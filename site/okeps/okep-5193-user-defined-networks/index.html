
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://www.ovn.org/ovn-kubernetes/okeps/okep-5193-user-defined-networks/">
      
      
        <link rel="prev" href="../okep-4380-network-qos/">
      
      
        <link rel="next" href="../okep-5233-preconfigured-udn-addresses/">
      
      
        
      
      
      <link rel="icon" href="../../images/ovn-inside-k8s.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>User Defined Networks - OVN-Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#okep-5193-user-defined-network-segmentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OVN-Kubernetes" class="md-header__button md-logo" aria-label="OVN-Kubernetes" data-md-component="logo">
      
  <img src="../../images/ovn-inside-k8s.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OVN-Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              User Defined Networks
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-label="Blueprint"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Blueprint" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.5 3A5.5 5.5 0 0 1 14 8.5c0 1.33-.47 2.55-1.26 3.5H21v9h-9v-8.26c-.95.79-2.17 1.26-3.5 1.26A5.5 5.5 0 0 1 3 8.5 5.5 5.5 0 0 1 8.5 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="cyan" data-md-color-accent="purple"  aria-label="Nerve Center"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Nerve Center" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19.07 4.93-1.41 1.41A8.01 8.01 0 0 1 20 12a8 8 0 0 1-8 8 8 8 0 0 1-8-8c0-4.08 3.05-7.44 7-7.93v2.02C8.16 6.57 6 9.03 6 12a6 6 0 0 0 6 6 6 6 0 0 0 6-6c0-1.66-.67-3.16-1.76-4.24l-1.41 1.41C15.55 9.9 16 10.9 16 12a4 4 0 0 1-4 4 4 4 0 0 1-4-4c0-1.86 1.28-3.41 3-3.86v2.14c-.6.35-1 .98-1 1.72a2 2 0 0 0 2 2 2 2 0 0 0 2-2c0-.74-.4-1.38-1-1.72V2h-1A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-2.76-1.12-5.26-2.93-7.07"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ovn-org/ovn-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ovn-org/ovn-kubernetes
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../installation/launching-ovn-kubernetes-on-kind/" class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../governance/CONTRIBUTING/" class="md-tabs__link">
          
  
  
    
  
  Developer Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api-reference/introduction/" class="md-tabs__link">
          
  
  
    
  
  API Reference Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../features/user-defined-networks/user-defined-networks/" class="md-tabs__link">
          
  
  
    
  
  Features

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/debugging/" class="md-tabs__link">
          
  
  
    
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../observability/metrics/" class="md-tabs__link">
          
  
  
    
  
  Observability

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../okep-5085-localnet-api/" class="md-tabs__link">
          
  
  
    
  
  Enhancement Proposals

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OVN-Kubernetes" class="md-nav__button md-logo" aria-label="OVN-Kubernetes" data-md-component="logo">
      
  <img src="../../images/ovn-inside-k8s.png" alt="logo">

    </a>
    OVN-Kubernetes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ovn-org/ovn-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ovn-org/ovn-kubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Overview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/topology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Topology
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/gateway-modes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gateway Modes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/traffic-flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Traffic Flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/pod-creation-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pod Creation Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/service-creation-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Creation Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/service-traffic-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Traffic Policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/host-to-node-port-hairpin-trafficflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Host To NodePort Hairpin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/external-ip-and-loadbalancer-ingress/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ExternalIPs/LoadBalancerIngress
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/ovn-kubernetes-subnets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Internal Subnets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/live-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubevirt VM Live Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/launching-ovn-kubernetes-on-kind/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launching OVN-Kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/launching-ovn-kubernetes-with-helm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launching OVN-Kubernetes Using Helm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/cli-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/example-pod-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying Workloads on OVN-Kubernetes cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/example-service-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying Services on OVN-Kubernetes cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/building-ovn-kubernetes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup and Building
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Developer Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developer Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../governance/CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../governance/REVIEWING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reviewing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/developer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coding Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/image-build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVN-Kubernetes Container Images
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/local_testing_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local Testing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ci/ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CI Testing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/release/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/egress-ip-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/egress-service-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressService
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/egress-qos-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressQoS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/egress-firewall-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressFirewall
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/admin-epbr-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AdminPolicyBasedExternalRoutes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/userdefinednetwork-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UserDefinedNetwork
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/routeadvertisements-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RouteAdvertisements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Universal Connectivity
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Universal Connectivity
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/user-defined-networks/user-defined-networks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UserDefinedNetwork
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    NetworkSecurityControls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    NetworkSecurityControls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-security-controls/admin-network-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AdminNetworkPolicy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-security-controls/network-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NetworkPolicy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-security-controls/egress-firewall/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressFirewall
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ClusterEgressControls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    ClusterEgressControls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-ip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressService
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-qos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressQoS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressGateway
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    InfrastructureSecurityControls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    InfrastructureSecurityControls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/infrastructure-security-controls/node-identity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NodeIdentity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    MultiNetworking
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    MultiNetworking
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/multiple-networks/multi-homing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multihoming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/multiple-networks/multi-network-policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MultiNetworkPolicies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/multiple-networks/multi-vtep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MultiNetworkRails
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/multicast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multicast
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    NetworkQoS
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    NetworkQoS
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-qos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-qos-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/live-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubevirt VM Live Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/hybrid-overlay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HybridOverlay
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Hardware Acceleration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hardware Acceleration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/hardware-offload/ovs-kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVS Acceleration with kernel datapath
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/hardware-offload/ovs-doca/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVS Acceleration with DOCA datapath
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    BGP Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    BGP Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/bgp-integration/route-advertisements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Route Advertisements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Troubleshooting
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/ovnkube-trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVNKube Trace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Observability
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/sdn-dashboard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDN Dashboard
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/ovn-observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVN observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Enhancement Proposals
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Enhancement Proposals
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5085-localnet-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Localnet API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-4380-network-qos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network QoS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    User Defined Networks
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    User Defined Networks
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem Statement
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terminology
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future-Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-storiesuse-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        User-Stories/Use-Cases
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Proposed Solution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip-addressing" class="md-nav__link">
    <span class="md-ellipsis">
      
        IP Addressing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crd-spec" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRD Spec
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crd-status" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRD Status
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#namespace-scoped-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Namespace scoped CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-scoped-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster scoped CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-namespace-scoped-network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example - Namespace scoped network
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-cluster-scoped-network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example - Cluster scoped network
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tenant-use-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tenant Use Case
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-use-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Admin Use Case
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crd-implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRD Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CRD Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster-manager-udn-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster Manager UDN Controller
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#general-crd-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        General CRD flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networkattachmentdefinition-rendering" class="md-nav__link">
    <span class="md-ellipsis">
      
        NetworkAttachmentDefinition Rendering
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices-for-managing-ovn-network-using-crds" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best practices for managing OVN network using CRDs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udn-functional-implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        UDN Functional Implementation Details
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-gateway-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shared Gateway Mode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shared Gateway Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-egress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pod Egress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress IP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Firewall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-qos" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress QoS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Service
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-external-gateways-meg-admin-based-policy-routing-abpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple External Gateways (MEG) / Admin Based Policy Routing (ABPR)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-gateway-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Gateway Mode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Local Gateway Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-egress_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pod Egress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-ip_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress IP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-firewall_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Firewall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-qos_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress QoS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-service_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Service
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-external-gateways-meg" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple External Gateways (MEG)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-readinessliveness-probes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Readiness/Liveness Probes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#host-networked-pods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Host Networked Pods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Host Networked Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrf-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        VRF Considerations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Service Access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing Details
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documentation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Documentation Details
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risks-known-limitations-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Risks, Known Limitations and Mitigations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Risks, Known Limitations and Mitigations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#risks-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Risks and Mitigations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drawbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Drawbacks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovn-kubernetes-version-skew" class="md-nav__link">
    <span class="md-ellipsis">
      
        OVN-Kubernetes Version Skew
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternatives
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5233-preconfigured-udn-addresses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preconfigured UDN Addresses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5296-bgp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BGP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5094-layer2-transit-router/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Layer2TransitRouter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5494-ovn-kubernetes-mcp-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP for Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5552-dynamic-udn-node-allocation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic UDN Node Allocation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5224-connecting-udns/okep-5224-connecting-udns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connecting User Defined Networks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5259-no-overlay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    No-Overlay Mode
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5088-evpn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EVPN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../okep-5674-dpu-healthcheck/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPU Healthcheck
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../blog/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem Statement
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terminology
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future-Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-storiesuse-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        User-Stories/Use-Cases
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Proposed Solution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip-addressing" class="md-nav__link">
    <span class="md-ellipsis">
      
        IP Addressing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Policy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crd-spec" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRD Spec
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crd-status" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRD Status
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#namespace-scoped-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Namespace scoped CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-scoped-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster scoped CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-namespace-scoped-network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example - Namespace scoped network
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-cluster-scoped-network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example - Cluster scoped network
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tenant-use-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tenant Use Case
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-use-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Admin Use Case
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crd-implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRD Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CRD Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster-manager-udn-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster Manager UDN Controller
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#general-crd-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        General CRD flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networkattachmentdefinition-rendering" class="md-nav__link">
    <span class="md-ellipsis">
      
        NetworkAttachmentDefinition Rendering
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices-for-managing-ovn-network-using-crds" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best practices for managing OVN network using CRDs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udn-functional-implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        UDN Functional Implementation Details
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-gateway-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shared Gateway Mode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shared Gateway Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-egress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pod Egress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress IP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Firewall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-qos" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress QoS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Service
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-external-gateways-meg-admin-based-policy-routing-abpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple External Gateways (MEG) / Admin Based Policy Routing (ABPR)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-gateway-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Local Gateway Mode
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Local Gateway Mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-egress_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pod Egress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-ip_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress IP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-firewall_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Firewall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-qos_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress QoS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#egress-service_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Egress Service
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-external-gateways-meg" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple External Gateways (MEG)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-readinessliveness-probes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Readiness/Liveness Probes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#host-networked-pods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Host Networked Pods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Host Networked Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vrf-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        VRF Considerations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        Service Access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing Details
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documentation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Documentation Details
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risks-known-limitations-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Risks, Known Limitations and Mitigations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Risks, Known Limitations and Mitigations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#risks-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Risks and Mitigations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#drawbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Drawbacks
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovn-kubernetes-version-skew" class="md-nav__link">
    <span class="md-ellipsis">
      
        OVN-Kubernetes Version Skew
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternatives
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="okep-5193-user-defined-network-segmentation">OKEP-5193: User Defined Network Segmentation<a class="headerlink" href="#okep-5193-user-defined-network-segmentation" title="Permanent link">&para;</a></h1>
<ul>
<li>Issue: <a href="https://github.com/ovn-org/ovn-kubernetes/issues/5193">#5193</a></li>
</ul>
<h2 id="problem-statement">Problem Statement<a class="headerlink" href="#problem-statement" title="Permanent link">&para;</a></h2>
<p>OVN-Kubernetes today allows multiple different types of networks per secondary network: layer 2, layer 3, or localnet.
Pods can be connected to different networks without discretion. For the primary network, OVN-Kubernetes only supports all
pods connecting to the same layer 3 virtual topology. The scope of this effort is to bring the same flexibility of the
secondary network to the primary network. Therefore, pods are able to connect to different types of networks as their
primary network.</p>
<p>Additionally, multiple and different instances of primary networks may co-exist for different users, and they will provide
native network isolation.</p>
<h2 id="terminology">Terminology<a class="headerlink" href="#terminology" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Primary Network</strong> - The network which is used as the default gateway for the pod. Typically recognized as the eth0
  interface in the pod.</li>
<li><strong>Secondary Network</strong> - An additional network and interface presented to the pod. Typically created as an additional
  Network Attachment Definition (NAD), leveraging Multus. Secondary Network in the context of this document refers to a
  secondary network provided by the OVN-Kubernetes CNI.</li>
<li><strong>Cluster Default Network</strong> - This is the routed OVN network that pods attach to by default today as their primary network.
  The pods default route, service access, as well as kubelet probe are all served by the interface (typically eth0) on this network.</li>
<li><strong>User-Defined Network</strong> - A network that may be primary or secondary, but is declared by the user.</li>
<li><strong>Layer 2 Type Network</strong> - An OVN-Kubernetes topology rendered into OVN where pods all connect to the same distributed
  logical switch (layer 2 segment) which spans all nodes. Uses Geneve overlay.</li>
<li><strong>Layer 3 Type Network</strong> - An OVN-Kubernetes topology rendered into OVN where pods have a per-node logical switch and subnet.
  Routing is used for pod to pod communication across nodes. This is the network type used by the cluster default network today.
  Uses Geneve overlay.</li>
<li><strong>Localnet Type Network</strong> - An OVN-Kubernetes topology rendered into OVN where pods connect to a per-node logical switch
  that is directly wired to the underlay.</li>
</ul>
<h2 id="goals">Goals<a class="headerlink" href="#goals" title="Permanent link">&para;</a></h2>
<ul>
<li>Provide a configurable way to indicate that a pod should be connected to a user-defined network of a specific type as a
  primary interface.</li>
<li>The primary network may be configured as a layer 3 or layer 2 type network.</li>
<li>Allow networks to have overlapping pod IP address space. This range may not overlap with the default cluster subnet
  used for allocating pod IPs on the cluster default network today.</li>
<li>The cluster default primary network defined today will remain in place as the default network pods attach to. The cluster
  default network will continue to serve as the primary network for pods in a namespace that has no primary user-defined network. Pods
  with primary user-defined networks will still attach to the cluster default network with limited access to Kubernetes system resources.
  Pods with primary user-defined networks will have at least two network interfaces, one connected to the cluster default network and one
  connected to the user-defined network. Pods with primary user-defined networks will use the user-defined network as their default
  gateway.</li>
<li>Allow multiple namespaces per network.</li>
<li>Support cluster ingress/egress traffic for user-defined networks, including secondary networks.</li>
<li>Support for ingress/egress features on user-defined primary networks where possible:<ul>
<li>QoS</li>
<li>EgressIP</li>
<li>Load Balancer and NodePort Services, as well as services with External IPs.</li>
</ul>
</li>
<li>In addition to ingress service support, there will be support for Kubernetes Cluster IP services in user-defined networks. The
  scope of reachability to that service as well as endpoints selected for that service will be confined to the network
  and corresponding namespace(s) where that service was created.</li>
<li>Support for pods to continue to have access to the cluster default primary network for DNS and KAPI service access.</li>
<li>Kubelet healthchecks/probes will still work on all pods.</li>
</ul>
<h2 id="non-goals">Non-Goals<a class="headerlink" href="#non-goals" title="Permanent link">&para;</a></h2>
<ul>
<li>Allowing different service CIDRs to be used in different networks.</li>
<li>Localnet will not be supported initially for primary networks.</li>
<li>Allowing multiple primary networks per namespace.</li>
<li>Hybrid overlay support on user-defined networks.</li>
</ul>
<h2 id="future-goals">Future-Goals<a class="headerlink" href="#future-goals" title="Permanent link">&para;</a></h2>
<ul>
<li>DNS lookup for pods returning records for IPs on the user-defined network. In the first phase DNS will return the pod
  IP on the cluster default network instead.</li>
<li>Admin ability to configure networks to have access to all services and/or expose services to be accessible from all
  networks.</li>
<li>Ability to advertise user-defined networks to external networks using BGP/EVPN. This will enable things like:<ul>
<li>External -&gt; Pod ingress per VRF (Ingress directly to pod IP)</li>
<li>Multiple External Gateway (MEG) in a BGP context, with ECMP routes</li>
</ul>
</li>
<li>Allow connection of multiple networks via explicit router API configuration.</li>
<li>An API to allow user-defined ports for pods to be exposed on the cluster default network. This may be used for things
  like promethus metric scraping.</li>
<li>Potentially, coming up with an alternative solution for requiring the cluster default network connectivity to the pod,
  and presenting the IP of the pod to Kubernetes as the user-defined primary network IP, rather than the cluster default
  network IP.</li>
<li>Support for Egress Service</li>
<li>Support for Host Networked Pods -&gt; UDN pods or UDN services</li>
</ul>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>As users migrate from OpenStack to Kubernetes, there is a need to provide network parity for those users. In OpenStack,
each tenant (akin to Kubernetes namespace) by default has a layer 2 network, which is isolated from any other tenant.
Connectivity to other networks must be specified explicitly as network configuration via a Neutron router. In Kubernetes
the paradigm is opposite, by default all pods can reach other pods, and security is provided by implementing Network Policy.
Network Policy can be cumbersome to configure and manage for a large cluster. It also can be limiting as it only matches
TCP, UDP, and SCTP traffic. Furthermore, large amounts of network policy can cause performance issues in CNIs. With all
these factors considered, there is a clear need to address network security in a native fashion, by using networks per
tenant to isolate traffic.</p>
<h2 id="user-storiesuse-cases">User-Stories/Use-Cases<a class="headerlink" href="#user-storiesuse-cases" title="Permanent link">&para;</a></h2>
<ul>
<li>As a user I want to be able to migrate applications traditionally on OpenStack to Kubernetes, keeping my tenant network
  space isolated and having the ability to use a layer 2 network.</li>
<li>As a user I want to be able to ensure network security between my namespaces without having to manage and configure
  complex network policy rules.</li>
<li>As an administrator, I want to be able to provision networks to my tenants to ensure their networks and applications
  are natively isolated from other tenants.</li>
<li>As a user, I want to be able to request a unique, primary network for my namespace without having to get administrator
  permission.</li>
<li>As a user, I want to be able to request new secondary networks for my namespace, without having to get administrator
  permission.</li>
<li>As a user, I want user-defined primary networks to be able to have similar functionality as the cluster default network,
  regardless of being on a layer 2 or layer 3 type network. Features like Egress IP, Egress QoS, Kubernetes services,
  Ingress, and pod Egress should all function as they do today in the cluster default network.</li>
<li>As a user, I want to be able to use my own consistent IP addressing scheme in my network. I want to be able to specify
  and re-use the same IP subnet for my pods across different namespaces and clusters. This provides a consistent
  and repeatable network environment for administrators and users.</li>
</ul>
<h2 id="proposed-solution">Proposed Solution<a class="headerlink" href="#proposed-solution" title="Permanent link">&para;</a></h2>
<p>By default, in OVN-Kubernetes pods are attached to what is known as the cluster default" network, which is a routed network
divided up into a subnet per node. All pods will continue to have an attachment to this network, even when assigned a
different primary network. Therefore, when a pod is assigned to a user-defined network, it will have two interfaces, one
to the cluster default network, and one to the user-defined network. The cluster default network attachment is required
in order to provide support for Kubelet healthcheck probes to the pod.</p>
<p>All other traffic from the pod will be dropped by firewall rules on this network, when the pod is assigned a user-defined
primary network. Routes will be added to the user-defined OVN network to route KAPI/DNS traffic out towards the cluster
default network. Note, it may be desired to allow access to any Kubernetes service on the cluster default network (instead of just KAPI/DNS),
but at a minimum KAPI/DNS will be accessible. Furthermore, the IP of the pod from the Kubernetes API will continue to
show the IP assigned in the cluster default network.</p>
<p>In OVN-Kubernetes secondary networks are defined using Network Attachment Definitions (NADs). For more information on
how these are configured, refer to:</p>
<p><a href="https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/features/multi-homing.md">https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/features/multi-homing.md</a></p>
<p>The proposal here is to leverage this existing mechanism to create the network. A new field, role is
introduced to the NAD spec which indicates that this network should be used for the pod's primary network. Additionally,
a new "joinSubnets" field is added in order to specify the join subnet used inside the OVN network topology. An
example OVN-Kubernetes NAD may look like:</p>
<div class="highlight"><pre><span></span><code>apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: l3-network
  namespace: default
spec:
  config: |2
    {
            &quot;cniVersion&quot;: &quot;0.3.1&quot;,
            &quot;name&quot;: &quot;l3-network&quot;,
            &quot;type&quot;: &quot;ovn-k8s-cni-overlay&quot;,
            &quot;topology&quot;:&quot;layer3&quot;,
            &quot;subnets&quot;: &quot;10.128.0.0/16/24,2600:db8::/29&quot;,
            &quot;joinSubnets&quot;: &quot;100.65.0.0/24,fd99::/64&quot;,
            &quot;mtu&quot;: 1400,
            &quot;netAttachDefName&quot;: &quot;default/l3-network&quot;,
            &quot;role&quot;: primary
    }
</code></pre></div>
<p>The NAD must be created before any pods are created for this namespace. In order to enforce this requirement, a required
label will need to be added to a namespace during namespace creation time to indicate this namespace will have a primary
UDN. The required label will be "k8s.ovn.org/primary-user-defined-network". It is recommended to use an admission policy
so that a namespace cannot be updated to add/remove this label, and that it must be added only at namespace creation time:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admissionregistration.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ValidatingAdmissionPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user-defined-networks-namespace-label</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchConstraints</span><span class="p">:</span>
<span class="w">    </span><span class="nt">resourceRules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w">   </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">apiVersions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;v1&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">operations</span><span class="p">:</span><span class="w">  </span><span class="p p-Indicator">[</span><span class="s">&quot;UPDATE&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">   </span><span class="p p-Indicator">[</span><span class="s">&quot;namespaces&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">failurePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fail</span>
<span class="w">  </span><span class="nt">validations</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">expression</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;(&#39;k8s.ovn.org/primary-user-defined-network&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">oldObject.metadata.labels)</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">(&#39;k8s.ovn.org/primary-user-defined-network&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">object.metadata.labels)&quot;</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;The</span><span class="nv"> </span><span class="s">&#39;k8s.ovn.org/primary-user-defined-network&#39;</span><span class="nv"> </span><span class="s">label</span><span class="nv"> </span><span class="s">cannot</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">added/removed</span><span class="nv"> </span><span class="s">after</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">namespace</span><span class="nv"> </span><span class="s">was</span><span class="nv"> </span><span class="s">created&quot;</span>

<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admissionregistration.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ValidatingAdmissionPolicyBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user-defined-networks-namespace-label-binding</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">policyName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user-defined-networks-namespace-label</span>
<span class="w">  </span><span class="nt">validationActions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Deny</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">matchResources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">resourceRules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w">   </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">apiVersions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;v1&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">operations</span><span class="p">:</span><span class="w">  </span><span class="p p-Indicator">[</span><span class="s">&quot;UPDATE&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">   </span><span class="p p-Indicator">[</span><span class="s">&quot;namespaces&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>The following conditions regarding the namespace label are:</p>
<ol>
<li>If namespace is missing the label, and a pod is created, it attaches to default network.</li>
<li>If the namespace is missing the label, and a primary UDN or CUDN is created that matches that namespace, the UDN/CUDN
will report error status and the NAD will not be generated.</li>
<li>If the namespace is missing the label, and a primary UDN/CUDN exists, a pod in the namespace will be created and
attached to default network.</li>
<li>If the namespace has the label, and a primary UDN/CUDN does not exist a pod in the namespace will fail creation until
the UDN/CUDN is created.</li>
</ol>
<p>Only one primary network may exist per namespace. If more than one user-defined network is created with the
"role" key set to primary, then future pod creations will return an error on CNI ADD until the network
configuration is corrected.</p>
<p>A pod may not connect to multiple primary networks other than the cluster default. When the NAD is created,
OVN-Kubernetes will validate the configuration, as well as that no pods have been created in the namespace already. If
pods existed before the NAD was created, errors will be logged, and no further pods will be created in this namespace
until the network configuration is fixed.</p>
<p>After creating the NAD, pods created in this namespace will connect to the newly defined network as their primary
network. The primaryNetwork key is used so that OVN-Kubernetes knows which network should be used, in case there are multiple
NADs created for a namespace (secondary networks).</p>
<p>After a pod is created that shall connect to a user-defined network, it will then be annotated by OVN-Kubernetes with the
appropriate networking config:</p>
<div class="highlight"><pre><span></span><code>trozet@fedora:~/Downloads$ oc get pods -o yaml -n ns1
apiVersion: v1
items:
- apiVersion: v1
  kind: Pod
  metadata:
    annotations:
      k8s.ovn.org/pod-networks: |
        {
          &quot;default&quot;: {
            &quot;ip_addresses&quot;: [&quot;10.244.0.3/24&quot;],
            &quot;mac_address&quot;: &quot;0a:58:0a:f4:00:03&quot;,
            &quot;routes&quot;: [
              {&quot;dest&quot;: &quot;10.244.0.0/16&quot;, &quot;nextHop&quot;: &quot;10.244.0.1&quot;},
              {&quot;dest&quot;: &quot;100.64.0.0/16&quot;, &quot;nextHop&quot;: &quot;10.244.0.1&quot;}
            ],
            &quot;ip_address&quot;: &quot;10.244.0.3/24&quot;,
            &quot;role&quot;: &quot;infrastructure-locked&quot;
          },
          &quot;udn-test/l3-primary&quot;: {
            &quot;ip_addresses&quot;: [&quot;10.20.2.5/24&quot;],
            &quot;mac_address&quot;: &quot;0a:58:0a:14:02:05&quot;,
            &quot;gateway_ips&quot;: [&quot;10.20.2.1&quot;],
            &quot;routes&quot;: [
              {&quot;dest&quot;: &quot;10.20.0.0/16&quot;, &quot;nextHop&quot;: &quot;10.20.2.1&quot;},
              {&quot;dest&quot;: &quot;10.96.0.0/16&quot;, &quot;nextHop&quot;: &quot;10.20.2.1&quot;},
              {&quot;dest&quot;: &quot;100.65.0.0/16&quot;, &quot;nextHop&quot;: &quot;10.20.2.1&quot;}
            ],
            &quot;ip_address&quot;: &quot;10.20.2.5/24&quot;,
            &quot;gateway_ip&quot;: &quot;10.20.2.1&quot;,
            &quot;role&quot;: &quot;primary&quot;
          }
        }
      k8s.v1.cni.cncf.io/network-status: |-
        [{
            &quot;name&quot;: &quot;ovn-kubernetes&quot;,
            &quot;interface&quot;: &quot;eth0&quot;,
            &quot;ips&quot;: [
                &quot;10.244.0.3&quot;
            ],
            &quot;mac&quot;: &quot;0a:58:0a:f4:00:03&quot;,
            &quot;dns&quot;: {}
        },{
            &quot;name&quot;: &quot;ovn-kubernetes&quot;,
            &quot;interface&quot;: &quot;ovn-udn1&quot;,
            &quot;ips&quot;: [
                &quot;10.20.2.5&quot;
            ],
            &quot;mac&quot;: &quot;0a:58:0a:14:02:05&quot;,
            &quot;default&quot;: true,
            &quot;dns&quot;: {}
        }]
    creationTimestamp: &quot;2025-04-22T18:50:50Z&quot;
    labels:
      pod-name: client
    name: client
    namespace: udn-test
    resourceVersion: &quot;2093&quot;
    uid: dca1ff46-1990-4e84-a0a5-7c9fdde01993
status:
    podIP: 10.244.0.3
    podIPs:
    - ip: 10.244.0.3
</code></pre></div>
<p>In the above output the primary network is listed within the k8s.ovn.org/pod-networks annotation. It is also listed in
the network-status cncf annotation as "ovn-udn1". A user does not have to manually request that the pod is attached
to the primary network. The attachment to the cluster default network (CDN) and the primary UDN are done within the same
CNI ADD call.</p>
<p>Multiple namespaces may also be configured to use the same network. In this case the underlying OVN network will be the
same, following a similar pattern to what is
<a href="https://github.com/ovn-kubernetes/ovn-kubernetes/blob/master/docs/features/multiple-networks/multi-homing.md">already supported today for secondary networks</a>.</p>
<h3 id="ip-addressing">IP Addressing<a class="headerlink" href="#ip-addressing" title="Permanent link">&para;</a></h3>
<p>As previously mentioned, one of the goals is to allow user-defined networks to have overlapping pod IP addresses. This
is enabled by allowing a user to configure what CIDR to use for pod addressing when they create the network. However,
this range cannot overlap with the default cluster CIDR used by the cluster default network today.</p>
<p>Furthermore, the internal masquerade subnet and the Kubernetes service subnet will remain unique and will exist globally
to serve all networks. The masquerade subnet must be large enough to accommodate enough networks. Therefore, the
subnet size of the masquerade subnet is equal to the number of desired networks * 2, as we need 2 masquerade IPs per
network. The masquerade subnet remains localized to each node, so each node can use the same IP addresses and the size
of the subnet does not scale with number of nodes.</p>
<p>The transit switch subnets may overlap between all networks. This network is just used for transport between nodes, and
is never seen by the pods or external clients.</p>
<p>The join subnet of the default cluster network may not overlap with the join subnet of user-defined networks. This is
due to the fact that the pod is connected to the default network, as well as the user-defined primary network. The join
subnet is SNAT'ed by the GR of that network in order to facilitate ingress reply service traffic going back to the
proper GR, in case it traverses the overlay. For this reason, the pods may see this IP address and routes are added to
the pod to steer the traffic to the right interface (100.64.0.0/16 is the default cluster network join subnet):</p>
<div class="highlight"><pre><span></span><code>[root@pod3 /]# ip route show
default via 10.244.1.1 dev eth0 
10.96.0.0/16 via 10.244.1.1 dev eth0 
10.244.0.0/16 via 10.244.1.1 dev eth0 
10.244.1.0/24 dev eth0 proto kernel scope link src 10.244.1.8 
100.64.0.0/16 via 10.244.1.1 dev eth0
</code></pre></div>
<p>Since the pod needs routes for each join subnet, any layer 3 or layer 2 network that is attached to the pod needs a unique
join subnet. Consider a pod connected to the default cluster network, a user-defined, layer 3, primary network, and a
layer 2, secondary network:</p>
<table>
<thead>
<tr>
<th>Network</th>
<th>Pod Subnet</th>
<th>Node Pod Subnet</th>
<th>Join Subnet</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cluster Default</td>
<td>10.244.0.0/16</td>
<td>10.244.0.0/24</td>
<td>100.64.0.0/16</td>
</tr>
<tr>
<td>Layer 3</td>
<td>10.245.0.0/16</td>
<td>10.245.0.0/24</td>
<td>100.65.0.0/16</td>
</tr>
<tr>
<td>Layer 2</td>
<td>10.246.0.0/16</td>
<td>N/A</td>
<td>100.66.0.0/16</td>
</tr>
</tbody>
</table>
<p>The routing table would look like:</p>
<div class="highlight"><pre><span></span><code>[root@pod3 /]# ip route show
default via 10.245.0.1 dev eth1 
10.96.0.0/16 via 10.245.0.1 dev eth1
10.244.0.0/16 via 10.244.0.1 dev eth0
10.245.0.0/16 via 10.245.0.1 dev eth1
10.244.0.0/24 dev eth0 proto kernel scope link src 10.244.0.8
10.245.0.0/24 dev eth1 proto kernel scope link src 10.245.0.8
10.246.0.0/16 dev eth2 proto kernel scope link src 10.246.0.8
100.64.0.0/16 via 10.244.0.1 dev eth0
100.65.0.0/16 via 10.245.0.1 dev eth1
100.66.0.0/16 via 10.246.0.1 dev eth2
</code></pre></div>
<p>Therefore, when specifying a user-defined network it will be imperative to ensure that the networks a pod will connect to
do not have overlapping pod network or join network subnets. OVN-Kubernetes should be able to detect this scenario and
refuse to CNI ADD a pod with conflicts.</p>
<h3 id="dns">DNS<a class="headerlink" href="#dns" title="Permanent link">&para;</a></h3>
<p>DNS lookups will happen via every pods access to the DNS service on the cluster default network. CoreDNS lookups for
pods will resolve to the pods IP on the cluster default network. This is a limitation of the first phase of this feature
and will be addressed in a future enhancement. DNS lookups for services and external entities will function correctly.</p>
<h3 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h3>
<p>Services in Kubernetes are namespace scoped. Any creation of a service in a namespace without a user-defined network
(using cluster default network as primary) will only be accessible by other namespaces also using the default network as
their primary network. Services created in namespaces served by user-defined networks, will only be accessible to
namespaces connected to the user-defined network.</p>
<p>Since most applications require DNS and KAPI access, there is an exception to the above conditions where pods that are
connected to user-defined networks are still able to access KAPI and DNS services that reside on the cluster default
network. In the future, access to more services on the default network may be granted. However, that would require more
groundwork around enforcing network policy (which is evaluated typically after service DNAT) as potentially nftables
rules. Such work is considered a future enhancement and beyond the scope of this initial implementation.</p>
<p>With this proposal, OVN-Kubernetes will check which network is being used for this namespace, and then only enable the
service there. The cluster IP of the service will only be available in the network of that service, except for KAPI and
DNS as previously explained. Host networked pods in a namespace with a user-defined primary network will also be limited
to only accessing the cluster IP of the services for that network. Load balancer IP and nodeport services are also
supported on user-defined networks. Service selectors are only able to select endpoints from the same namespace where the
service exists. Services that exist before the user-defined network is assigned to a namespace will result in
OVN-Kubernetes executing a re-sync on all services in that namespace, and updating all load balancers. Keep in mind that
pods must not exist in the namespace when the namespace is assigned to a new network or the new network assignment will
not be accepted by OVN-Kubernetes.</p>
<p>Services in a user-defined network will be reachable by other namespaces that share the same network.</p>
<p>As previously mentioned, Kubernetes API and DNS services will be accessible by all pods.</p>
<p>Endpoint slices will provide the IPs of the cluster default network in Kubernetes API. For this implementation the required
endpoints are those IP addresses which reside on the user-defined primary network. In order to solve this problem,
OVN-Kubernetes may create its own endpoint slices or may choose to do dynamic lookups at runtime to map endpoints to
their primary IP address. Leveraging a second set of endpoint slices will be the preferred method, as it creates less
indirection and gives explicit Kube API access to what IP addresses are being used by OVN-Kubernetes. Read more about
the <a href="https://github.com/ovn-kubernetes/ovn-kubernetes/blob/master/docs/features/multiple-networks/mirrored-endpointslices.md">endpoint slice mirroring implementation</a>.</p>
<p>Kubelet health checks to pods are queried via the cluster default network. When endpoints are considered unhealthy they
will be removed from the endpoint slice, and thus their primary IP will be removed from the OVN load balancer. However,
it is important to note that the healthcheck is being performed via the cluster default network interface on the pod,
which ensures the application is alive, but does not confirm network connectivity of the primary interface. Therefore,
there could be a situation where OVN networking on the primary interface is broken, but the default interface continues
to work and reports 200 OK to Kubelet, thus rendering the pod serving in the endpoint slice, but unable to function.
Although this is an unlikely scenario, it is good to document.</p>
<h3 id="network-policy">Network Policy<a class="headerlink" href="#network-policy" title="Permanent link">&para;</a></h3>
<p>Network Policy will be fully supported for user-defined primary networks as it is today with the cluster default network.
However, configuring network policies that allow traffic between namespaces that connect to different user-defined
primary networks will have no effect. This traffic will not be allowed, as the networks have no connectivity to each other.
These types of policies will not be invalidated by OVN-Kubernetes, but the configuration will have no effect. Namespaces
that share the same user-defined primary network will still benefit from network policy that applies access control over
a shared network. Additionally, policies that block/allow cluster egress or ingress traffic will still be enforced for
any user-defined primary network.</p>
<h3 id="api-details">API Details<a class="headerlink" href="#api-details" title="Permanent link">&para;</a></h3>
<p>Network Attachment Definitions (NADs) are the current way to configure the network in OVN-Kubernetes today, and the
method proposed in this enhancement. There are two major shortcomings of NAD:</p>
<ol>
<li>It has free-form configuration that depends on the CNI. There is no API validation of what a user enters, leading to
   mistakes which are not caught at configuration time and may cause unexpected functional behavior at runtime.</li>
<li>It requires cluster admin RBAC in order to create the NAD.</li>
</ol>
<p>In order to address these issues, a proper CRD may be implemented which indirectly creates the NAD for OVN-Kubernetes.
This solution may consist of more than one CRD, namely an Admin based CRD and one that is namespace scoped for tenants.
The reasoning behind this is we want tenants to be able to create their own user-defined network for their namespace,
but we do not want them to be able to connect to another namespaces network without permission. The Admin based version
would give higher level access and allow an administrator to create a network that multiple namespaces could connect to.
It may also expose more settings in the future for networks that would not be safe in the hands of a tenant, like
deciding if a network is able to reach other services in other networks. With tenants having access to be able to create
multiple networks, we need to consider potential attack vectors like a tenant trying to exhaust OVN-Kubernetes
resources by creating too many secondary networks.</p>
<p>Furthermore, by utilizing a CRD, the status of the network CR itself can be used to indicate whether it is configured
by OVN-Kubernetes. For example, if a user creates a network CR and there is some problem (like pods already existed) then
an error status can be reported to the CR, rather than relying on the user to check OVN-Kubernetes logs.</p>
<h4 id="api-overview">API Overview<a class="headerlink" href="#api-overview" title="Permanent link">&para;</a></h4>
<p>Two CRDs shall be introduced. Note for the final implementation, see the <a href="https://ovn-kubernetes.io/api-reference/userdefinednetwork-api-spec/">official api</a>.
- Namespace scoped CRD - represent user request for creating namespace scoped OVN network.
  - Shall be defined with <code>namespace</code> scope.
  - Targeted for cluster admin and non-admin users, enable creating OVN network in a specific namespace.
- Cluster scoped CRD - represent user request for creating cluster scoped OVN network, enables cross-namespace networking.
  - Shall be defined with <code>cluster</code> scope
  - Targeted for cluster admin users only, enable creating shared OVN network across multiple namespaces.</p>
<p>Having a namespace-scope CRD targeted for admin and non-admin users, a cluster-scope CRD for admins only and utilizing RBAC
mechanism, enable allowing non-admin users create OVN networks in namespaces they permitted to with no admin intervention,
without the risk of destabilizing the cluster nodes or break the cluster network.</p>
<p>There should be a finalizer on the CRDs, so that upon deletion OVN-Kubernetes can validate that there are no pods still using this network.
If there are pods still attached to this network, the network will not be removed.</p>
<h4 id="crd-spec">CRD Spec<a class="headerlink" href="#crd-spec" title="Permanent link">&para;</a></h4>
<p>The CRDs spec defines as follows:</p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>Description</th>
<th>optional</th>
</tr>
</thead>
<tbody>
<tr>
<td>Topology</td>
<td>The topological configuration for the network. Must be one of <code>Layer2</code>, <code>layer3</code>, <code>Localnet</code>.</td>
<td>No</td>
</tr>
<tr>
<td>Role</td>
<td>Select the network role in the pod, either <code>Primary</code> or <code>Secondary</code>. Primary network support topologies <code>Layer2</code> and <code>Layer3</code> only.</td>
<td>No</td>
</tr>
<tr>
<td>MTU</td>
<td>The maximum transmission unit (MTU).<br/>The default is 1400.</td>
<td>Yes</td>
</tr>
<tr>
<td>Subnets</td>
<td>The subnet to use for the network across the cluster.<br/>E.g. <code>10.100.200.0/24</code>.<br/>IPv6 <code>2001:DBB::/64</code> and dual-stack <code>192.168.100.0/24</code>,<code>2001:DBB::/64</code> subnets are supported.<br/>When omitted, the logical switch implementing the network only provides layer 2 communication, and users must configure IP addresses.<br/>Port security only prevents MAC spoofing if the subnets are omitted.</td>
<td>Yes</td>
</tr>
<tr>
<td>ExcludeSubnets</td>
<td>List of CIDRs.<br/>IP addresses are removed from the assignable IP address pool and are never passed to the pods.</td>
<td>Yes</td>
</tr>
<tr>
<td>JoinSubnets</td>
<td>Subnet used inside the OVN network topology.  When omitted, this means no opinion and the platform is left to choose a reasonable default which is subject to change over time.</td>
<td>Yes</td>
</tr>
<tr>
<td>IPAM.Lifecycle</td>
<td>Control IP addresses management lifecycle. When <code>Persistent</code> is specified it enable workloads have persistent IP addresses. For example: Virtual Machines will have the same IP addresses along their lifecycle (stop, start migration, reboots). Supported by Topology <code>Layer2</code> &amp; <code>Localnet</code>.</td>
<td>Yes</td>
</tr>
<tr>
<td>IPAM.Mode</td>
<td>Control how much of the IP configuration will be managed by OVN-Kubernetes. Must be one of <code>Enabled</code>, <code>Disabled</code>.</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>The cluster scoped CRD should have the following additional field:</p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>Description</th>
<th>optional</th>
</tr>
</thead>
<tbody>
<tr>
<td>NamespaceSelector</td>
<td>List of the standard <code>metav1.LabelSelector</code> selector for which namespace the network should be available for.</td>
<td>No</td>
</tr>
<tr>
<td>Template</td>
<td>The user defined network spec.</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>The template type should be the namespace scope CRD spec.</p>
<blockquote>
<p><strong>Note:</strong> The spec should be extended with care and strive to have minimal set of fields to provide nice abstraction for the NAD spec.</p>
</blockquote>
<h4 id="crd-status">CRD Status<a class="headerlink" href="#crd-status" title="Permanent link">&para;</a></h4>
<p>The CRD status should reflect the NAD state through conditions.
For example, when the NAD its created the condition should be placed with status <code>True</code>.</p>
<p>For cluster scoped networks, the condition should be true once all desired namespaces are provisioned with the corresponding NAD.</p>
<p>The cluster scoped CRD status should reflect on which namespaces the network is available.</p>
<h4 id="namespace-scoped-crd">Namespace scoped CRD<a class="headerlink" href="#namespace-scoped-crd" title="Permanent link">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><span class="c1">// UserDefinedNetwork describe network request for a Namespace</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">UserDefinedNetwork</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span><span class="w">   </span><span class="s">`json:&quot;,inline&quot;`</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="w"> </span><span class="s">`json:&quot;metadata,omitempty&quot;`</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;self == oldSelf&quot;, message=&quot;Spec is immutable&quot;</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot; self.topology != &#39;Layer3&#39; || (self.topology == &#39;Layer3&#39; &amp;&amp; size(self.subnets) &gt; 0)&quot;, message=&quot;Subnets is required for Layer3 topology&quot;</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;self.topology != &#39;Localnet&#39; || (self.topology == &#39;Localnet&#39; &amp;&amp; self.role == &#39;Secondary&#39;)&quot;, message=&quot;Topology localnet is not supported for primary network&quot;</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;!has(self.ipamLifecycle) || (self.ipamLifecycle == &#39;Persistent&#39; &amp;&amp; (self.topology == &#39;Layer2&#39; || self.topology == &#39;Localnet&#39;))&quot;, message=&quot;ipamLifecycle is supported for Layer2 and Localnet topologies&quot;</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="nx">Spec</span><span class="w"> </span><span class="nx">UserDefinedNetworkSpec</span><span class="w"> </span><span class="s">`json:&quot;spec&quot;`</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">Status</span><span class="w"> </span><span class="nx">UserDefinedNetworkStatus</span><span class="w"> </span><span class="s">`json:&quot;status,omitempty&quot;`</span>
<span class="p">}</span>
</code></pre></div>
Suggested API validation rules:
- Spec defined as immutable
  <br>
  Avoid incomplete state in a scenario where a NAD is created according to UDN spec, and pods connected to the network,
  UDN spec changes, now pods connected to a network that was created from previous revision spec.
- <code>Subnets</code> are mandatory for <code>Layer3</code> topology.
- <code>Localnet</code> topology is not supported for primary network.
- <code>IPAM.Lifecycle</code> is supported for <code>Layer2</code> and <code>Localnet</code> topology.
- <code>IPAM.Mode</code> can be set to <code>Disabled</code> only on <code>Layer2</code> or <code>Localnet</code> topologies for <code>Secondary</code> networks, where the <code>Subnets</code> parameter must be omitted. When set to <code>Enabled</code>, the <code>Subnets</code> attribute must be defined.</p>
<p>Suggested CRD short-name: <code>udn</code></p>
<p><div class="highlight"><pre><span></span><code><span class="c1">// UserDefinedNetworkSpec defines the desired state of UserDefinedNetwork.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">UserDefinedNetworkSpec</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// The topological configuration for the network.</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Enum=Layer2;Layer3;Localnet</span>
<span class="w">    </span><span class="nx">Topology</span><span class="w"> </span><span class="nx">NetworkTopology</span><span class="w"> </span><span class="s">`json:&quot;topology&quot;`</span>

<span class="w">    </span><span class="c1">// The network role in the pod (e.g.: Primary, Secondary).</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Enum=Primary;Secondary</span>
<span class="w">    </span><span class="nx">Role</span><span class="w"> </span><span class="nx">NetworkRole</span><span class="w"> </span><span class="s">`json:&quot;role&quot;`</span>

<span class="w">    </span><span class="c1">// The maximum transmission unit (MTU).</span>
<span class="w">    </span><span class="c1">// MTU is optional, if not provided the globally configured value in OVN-Kubernetes (defaults to 1400) is used for the network.    </span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">MTU</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="s">`json:&quot;mtu,omitempty&quot;`</span>


<span class="w">    </span><span class="c1">// The subnet to use for the pod network across the cluster.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// Dualstack clusters may set 2 subnets (one for each ip family), </span>
<span class="w">    </span><span class="c1">// otherwise only 1 subnet is allowed.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// When topology is `Layer3`, the given subnet is split into smaller subnets for every node.</span>
<span class="w">    </span><span class="c1">// To specify how the subnet should be split, the following format is supported for `Layer3` network:</span>
<span class="w">    </span><span class="c1">// `10.128.0.0/16/24`, which means that every host will get a `/24` subnet.</span>
<span class="w">    </span><span class="c1">// If host subnet mask is not set (for example, `10.128.0.0/16`), it will be assigned automatically.</span>
<span class="w">    </span><span class="c1">// </span>
<span class="w">    </span><span class="c1">// For `Layer2` and `Localnet` topology types, the format should match standard CIDR notation, without</span>
<span class="w">    </span><span class="c1">// providing any host subnet mask.</span>
<span class="w">    </span><span class="c1">// This field is required when `ipam.mode` is set to `Enabled` and is ignored otherwise.</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">Subnets</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;subnets,omitempty&quot;`</span>

<span class="w">    </span><span class="c1">// A list of CIDRs.</span>
<span class="w">    </span><span class="c1">// IP addresses are removed from the assignable IP address pool and are never passed to the pods.</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">ExcludeSubnets</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;excludeSubnets,omitempty&quot;`</span>

<span class="w">    </span><span class="c1">// Subnet used inside the OVN network topology.</span>
<span class="w">    </span><span class="c1">// This field is ignored for non-primary networks (e.g.: Role Secondary).</span>
<span class="w">    </span><span class="c1">// When omitted, this means no opinion and the platform is left to choose a reasonable default which is subject to change over time.    </span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;1 &lt;= size(self) &amp;&amp; size(self) &lt;= 2&quot;, message=&quot;Unexpected number of join subnets&quot;</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">JoinSubnets</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;joinSubnets,omitempty&quot;`</span>

<span class="w">    </span><span class="c1">// IPAM section contains IPAM-related configuration for the network.</span>
<span class="w">    </span><span class="nx">IPAM</span><span class="w"> </span><span class="o">*</span><span class="nx">IPAMSpec</span><span class="w"> </span><span class="s">`json:&quot;ipam,omitempty&quot;`</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">IPAMSpec</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Mode controls how much of the IP configuration will be managed by OVN.</span>
<span class="w">    </span><span class="c1">// `Enabled` means OVN-Kubernetes will apply IP configuration to the SDN infrastructure and it will also assign IPs</span>
<span class="w">    </span><span class="c1">// from the selected subnet to the individual pods.</span>
<span class="w">    </span><span class="c1">// `Disabled` means OVN-Kubernetes will only assign MAC addresses and provide layer 2 communication, letting users</span>
<span class="w">    </span><span class="c1">// configure IP addresses for the pods.</span>
<span class="w">    </span><span class="c1">// `Disabled` is only available for `Layer2` and `Localnet` topologies for Secondary networks.</span>
<span class="w">    </span><span class="c1">// By disabling IPAM, any Kubernetes features that rely on selecting pods by IP will no longer function</span>
<span class="w">    </span><span class="c1">// (such as network policy, services, etc). Additionally, IP port security will also be disabled for interfaces attached to this network.</span>
<span class="w">    </span><span class="c1">// Defaults to `Enabled`.</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">Mode</span><span class="w"> </span><span class="nx">IPAMMode</span><span class="w"> </span><span class="s">`json:&quot;mode&quot;`</span>

<span class="w">    </span><span class="c1">// Lifecycle controls IP addresses management lifecycle.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// The only allowed value is Persistent. When set, OVN-Kubernetes assigned IP addresses will be persisted in an</span>
<span class="w">    </span><span class="c1">// `ipamclaims.k8s.cni.cncf.io` object. These IP addresses will be reused by other pods if requested.</span>
<span class="w">    </span><span class="c1">// Only supported when &quot;mode&quot; is `Enabled`.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">Lifecycle</span><span class="w"> </span><span class="nx">NetworkIPAMLifecycle</span><span class="w"> </span><span class="s">`json:&quot;lifecycle,omitempty&quot;`</span>
<span class="p">}</span>
</code></pre></div>
Suggested API validation rules:
- <code>Topology</code> and <code>Role</code> fields are mandatory.
- <code>Topology</code> can be one of <code>Layer2</code>, <code>Layer3</code>, <code>Localnet</code>.
- <code>Role</code> can be one of <code>Primary</code>, <code>Secondary</code>.
- <code>IPAM.Lifecycle</code> can be <code>Persistent</code>.
- <code>IPAM.Mode</code> can be set to <code>Disabled</code> only on <code>Layer2</code> or <code>Localnet</code> topologies for <code>Secondary</code> networks, where the <code>Subnets</code> parameter must be omitted. When set to <code>Enabled</code>, the <code>Subnets</code> attribute must be defined.
- <code>JoinSubnets</code> length can be 1 or 2.</p>
<h4 id="cluster-scoped-crd">Cluster scoped CRD<a class="headerlink" href="#cluster-scoped-crd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// ClusterUserDefinedNetwork describes shared OVN network across namespaces request.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterUserDefinedNetwork</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span><span class="w">   </span><span class="s">`json:&quot;,inline&quot;`</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="w"> </span><span class="s">`json:&quot;metadata,omitempty&quot;`</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="nx">Spec</span><span class="w"> </span><span class="nx">ClusterUserDefinedNetworkSpec</span><span class="w"> </span><span class="s">`json:&quot;spec&quot;`</span>
<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">Status</span><span class="w"> </span><span class="nx">ClusterUserDefinedNetworkStatus</span><span class="w"> </span><span class="s">`json:&quot;status,omitempty&quot;`</span>
<span class="p">}</span>

<span class="c1">// ClusterUserDefinedNetwork defines the desired state of ClusterUserDefinedNetwork.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterUserDefinedNetwork</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// NamespaceSelector Label selector for which namespace network should be available for.</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="nx">NamespaceSelector</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">LabelSelector</span><span class="w"> </span><span class="s">`json:&quot;namespaceSelector&quot;`</span>

<span class="w">    </span><span class="c1">// Template is direct specification of UserDefinedNetwork.</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="nx">Template</span><span class="w"> </span><span class="o">*</span><span class="nx">UserDefinedNetworkTemplateSpec</span><span class="w"> </span><span class="s">`json:&quot;template&quot;`</span>
<span class="p">}</span>

<span class="c1">// UserDefinedNetworkTemplateSpec UserDefinedNetwork spec template.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">UserDefinedNetworkTemplateSpec</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// UserDefinedNetworkSpec contains the UserDefinedNetwork specification.</span>
<span class="w">    </span><span class="nx">Spec</span><span class="w"> </span><span class="nx">UserDefinedNetworkSpec</span><span class="w"> </span><span class="s">`json:&quot;spec,omitempty&quot;`</span>
<span class="p">}</span>

<span class="c1">// ClusterUserDefinedNetworkStatus contains the observed status of the ClusterUserDefinedNetwork.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterUserDefinedNetworkStatus</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ActiveNamespaces indicates in which namespaces network is available.</span>
<span class="w">    </span><span class="nx">ActiveNamespaces</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;activeNamespaces,omitempty&quot;`</span>

<span class="w">    </span><span class="nx">Conditions</span><span class="w"> </span><span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="w"> </span><span class="s">`json:&quot;conditions,omitempty&quot;`</span>
<span class="p">}</span>
</code></pre></div>
<p>Suggested CRD short-name: <code>cudn</code></p>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h4>
<p>Existing conditions that reflect if the Network Attachment Definition has been created, and if network allocation has been done for every
node:</p>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-05-13T18:01:05Z&quot;</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition has been created</span>
<span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinitionCreated</span>
<span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkCreated</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-05-13T18:01:05Z&quot;</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Network allocation succeeded for all synced nodes.</span>
<span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAllocationSucceeded</span>
<span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAllocationSucceeded</span>
</code></pre></div>
<p>To be implemented condition reflecting the network readiness underlying OVN network state:
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkCreated</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVNNetworkCreated</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVN network has been created</span>
</code></pre></div></p>
<h4 id="example-namespace-scoped-network">Example - Namespace scoped network<a class="headerlink" href="#example-namespace-scoped-network" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UserDefinedNetwork</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">topology</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Layer2</span>
<span class="w">  </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Primary</span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="w">  </span><span class="nt">subnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.0/24&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">excludeSubnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.0/26&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">ipamLifecycle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Persistent</span>
</code></pre></div>
<p>After creation:
<div class="highlight"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UserDefinedNetwork</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="w">  </span><span class="nt">finalizers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/user-defined-network-protection</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">topology</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Layer2</span>
<span class="w">  </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Primary</span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="w">  </span><span class="nt">subnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.0/24&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">excludeSubnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.100/26&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">    </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Persistent</span>
<span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-05-13T18:01:05Z&quot;</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition has been created</span>
<span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinitionCreated</span>
<span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkCreated</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-05-13T18:01:05Z&quot;</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Network allocation succeeded for all synced nodes.</span>
<span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAllocationSucceeded</span>
<span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAllocationSucceeded</span>
</code></pre></div></p>
<h4 id="example-cluster-scoped-network">Example - Cluster scoped network<a class="headerlink" href="#example-cluster-scoped-network" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterUserDefinedNetwork</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/metadata.name</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;mynamespace&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;theirnamespace&quot;</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Layer2</span>
<span class="w">    </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Primary</span>
<span class="w">    </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class="w">    </span><span class="nt">subnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.0/24&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">excludeSubnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10.0.0.100/26&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-05-13T19:26:13Z&quot;</span>
<span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;NetworkAttachmentDefinition</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">created</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">following</span><span class="nv"> </span><span class="s">namespaces:</span>
<span class="w">      </span><span class="s">[mynamespace,</span><span class="nv"> </span><span class="s">theirnamespace]&#39;</span>
<span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinitionCreated</span>
<span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkCreated</span>
</code></pre></div>
<h4 id="tenant-use-case">Tenant Use Case<a class="headerlink" href="#tenant-use-case" title="Permanent link">&para;</a></h4>
<p>As a tenant I want to ensure when I create pods in my namespace their network traffic is isolated from other tenants on
the cluster. In order to ensure this, I first create a network CRD that is namespace scoped and indicate:</p>
<ul>
<li>Type of network (Layer 3 or Layer 2)</li>
<li>IP addressing scheme I wish to use (optional)</li>
<li>Indicate this network will be the primary network</li>
</ul>
<p>After creating this CRD, I can check the status of the CRD to ensure it is actively being used as the primary network
for my namespace by OVN-Kubernetes. Once verified, I can now create pods and they will be in their own isolated SDN.</p>
<h4 id="admin-use-case">Admin Use Case<a class="headerlink" href="#admin-use-case" title="Permanent link">&para;</a></h4>
<p>As an admin, I have a customer who has multiple namespaces and wants to connect them all to the same private network. In
order to accomplish this, I first create an admin network CRD that is cluster scoped and indicate:</p>
<ul>
<li>Type of network (Layer 3 or Layer 2)</li>
<li>IP addressing scheme I wish to use (optional)</li>
<li>Indicate this network will be the primary network</li>
<li>Selector to decide which namespaces may connect to this network. May use the <code>kubernetes.io/metadata.name</code> label to
  guarantee uniqueness and eliminates the ability to falsify access.</li>
</ul>
<p>After creating the CRD, check the status to ensure OVN-Kubernetes has accepted this network to serve the namespaces
selected. Now tenants may go ahead and be provisioned their namespace.</p>
<h3 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h3>
<h4 id="crd-implementation-details">CRD Implementation Details<a class="headerlink" href="#crd-implementation-details" title="Permanent link">&para;</a></h4>
<h5 id="cluster-manager-udn-controller">Cluster Manager UDN Controller<a class="headerlink" href="#cluster-manager-udn-controller" title="Permanent link">&para;</a></h5>
<p>New controller should be introduced, it should manage the new CRDs lifecycle.</p>
<p>The controller should utilize the CNI plugin API and create OVN networks using <code>NetworkAttachmentDefinition</code> using the
<code>ovn-k8s-overlay-cni</code> CNI plugin according to desired spec.</p>
<p>The controller should watch NAD object in order to reconcile them and reflect the network state in the CRDs status.</p>
<p>The request corresponding NADs should be created with a finalizer, so that upon deletion OVN-Kubernetes can validate that
there are no pods still using this network.
If there are pods still attached to this network, the network will not be removed.</p>
<p>The CRD spec should be validated before creating the NAD, see the <a href="#validations">validation</a> section for more details.</p>
<p>The controller should create the requested NAD with:
1. finalizer, enable the controller release resources before NAD is deleted, ensure no pod is connected to the network.
2. owner-reference referring to the request CR object.
   Using the owner-reference mechanism should prevent deletion of the NAD before the corresponding CRD instance is deleted.
   In addition, the owner-reference make teardown seamless, when the request CR object instance is deleted,
   the cluster garbage collected will dispose the corresponding NAD when all finalizers are gone.</p>
<p>In a scenario a NAD already exist at the target namespace, the controller should check if the existing NAD is managed
by the controller as follows:
1. Check the owner reference match the request CR UID.
2. OVN-K user-defined-network finalizer exist.
3. NAD spec correspond to desired spec.</p>
<p>In case one of the previous checks fails, the controller should reconcile the request and
this state in the CR status network is not ready.</p>
<p>In scenario of cluster-scope CRD request, the controller should do best effort to create the desired NAD in each
specified namespace.
In case on or more NAD creation fails (e.g.: due to namespace not exist), the controller should continue to the
next namespace.
When finished, reflect in the status all namespaces where NAD creation failed to create.</p>
<h5 id="general-crd-flow">General CRD flow<a class="headerlink" href="#general-crd-flow" title="Permanent link">&para;</a></h5>
<ol>
<li>On namespaced-scope CRD creation:</li>
<li>Validates the CRD spec.</li>
<li>Generate NAD manifest from the CRD spec.</li>
<li>Check that the desired NAD is not already exist. If not, create the NAD and return.</li>
<li>Otherwise, verify the existing NAD correspond to desired spec, if so return.</li>
<li>In case foreign NAD* already exist at the target namespace, raise an error and return.</li>
<li>In case the NAD is malformed, reconcile it to desired state.</li>
<li>
<p>Update the status as follows:</p>
<ul>
<li>Reflect the reconciliation errors, which namespaces failed and the reason.</li>
</ul>
</li>
<li>
<p>on cluster-scope CRD creation:</p>
</li>
<li>Validates the CRD spec.</li>
<li>Generate NAD manifest from the CRD spec.</li>
<li>For each namespace specified in the spec:<ul>
<li>Check that the desired NAD does not already exist. If not, create the NAD and continue.</li>
<li>Otherwise, verify the existing NAD correspond to desired spec, if so continue.</li>
<li>In case foreign NAD* already exist at the target namespace, record an error and continue.</li>
<li>In case the NAD is malformed, reconcile it to desired state.</li>
</ul>
</li>
<li>
<p>Update the status as follows:</p>
<ul>
<li>Reflect namespaces where network is available.</li>
<li>Reflect the reconciliation errors, which namespaces failed and the reason.</li>
</ul>
</li>
<li>
<p>On namespace-scope CRD deletion:</p>
</li>
<li>If no NAD exist, return.</li>
<li>
<p>In case a NAD exist, ensure no pod specifying the network.</p>
<ul>
<li>In case no pod specifying the network, remove the finalizer, allowing the cluster garbage collector dispose the NAD object.</li>
<li>Otherwise, reflect in the status the network is being deleted because its in use.</li>
</ul>
</li>
<li>
<p>On cluster-scope CRD deletion:</p>
</li>
<li>For each namespace specified in the spec:</li>
<li>In case a NAD exist, ensure no pod specifying the network.</li>
<li>In case no pod specifying the network, remove the finalizer, allowing the cluster garbage collector dispose the NAD object.</li>
<li>Otherwise, reflect in the status the network is cannot be deleted because its in use.</li>
</ol>
<blockquote>
<p>Note:
NAD considered foreign when
- Has the same <code>meta.namesapce</code> and <code>meta.name</code> as the requested NAD.
- Has no owner-reference to the request CR object.</p>
</blockquote>
<h5 id="networkattachmentdefinition-rendering">NetworkAttachmentDefinition Rendering<a class="headerlink" href="#networkattachmentdefinition-rendering" title="Permanent link">&para;</a></h5>
<p>The underlying OVN network ID (network-name) is represented by the NAD CNI's network config <code>name</code> field, and must be unique.</p>
<p>The network-name is generated by the controller and should not be exposed for modification.</p>
<p>Having the network-name unique and non-configurable, avoid the risk where a malicious entity could guess other networks name,
specify then in the spec and tap into other networks.</p>
<p>The network-name should be composed for the subject CRD <code>metadata.namespace</code> and <code>metadata.name</code>, in the following format:
<code>mynamespace.myetwork</code></p>
<p>The <code>NetworkAttachmentDefinition</code> object <code>metadata.namespace</code> and <code>metadata.name</code> should correspond to the request CRD.</p>
<p>Creating namespace scoped CRD instance should trigger creation of a corresponding NAD at the namespace the CRD instance reside.
Following the <a href="#example---namespace-scoped-network">example</a>, the following NAD should be created:
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="w">  </span><span class="nt">finalizers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/user-defined-network-protection</span>
<span class="w">  </span><span class="nt">ownerReferences</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/v1alpha1</span>
<span class="w">    </span><span class="nt">blockOwnerDeletion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UserDefinedNetwork</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f45efb13-9511-48c1-95d7-44ee17c949f4</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span><span class="w">    </span>
<span class="w">      </span><span class="no">&#39;{</span>
<span class="w">          </span><span class="no">&quot;cniVersion&quot;:&quot;0.3.1&quot;,</span>
<span class="w">          </span><span class="no">&quot;mtu&quot;:1500,   </span>
<span class="w">          </span><span class="no">&quot;name&quot;:&quot;demo.network&quot;,  &lt;--- generated unique network-name</span>
<span class="w">          </span><span class="no">&quot;netAttachDefName&quot;:&quot;demo/poc-db-network&quot;,</span>
<span class="w">          </span><span class="no">&quot;subnets&quot;:&quot;10.0.0.0/24&quot;,</span>
<span class="w">          </span><span class="no">&quot;topology&quot;:&quot;layer2&quot;,</span>
<span class="w">          </span><span class="no">&quot;type&quot;:&quot;ovn-k8s-cni-overlay&quot;,</span>
<span class="w">          </span><span class="no">&quot;role&quot;: &quot;primary&quot;,</span>
<span class="w">          </span><span class="no">&quot;persistentIPs&quot;: &quot;true&quot;</span>
<span class="w">      </span><span class="no">}&#39;</span>
</code></pre></div></p>
<p>For cluster-scoped CRDs, the NAD <code>metadata.name</code> should correspond to the request CRD <code>metadata.name</code> with an additional prefix.
Having the prefix avoids conflicting with existing NADs who has the same <code>metadata.name</code>.
For example:
Given the CR meta.name is <code>db-network</code>,the NAD metadata.name will be <code>cluster.udn.db-network</code>.</p>
<p>Creating cluster scoped CRD instance should trigger creation of the corresponding NAD at each namespace specified in the spec.
Following the above cluster-scope CRD <a href="#example---cluster-scoped-network">example</a>, the following NADs should be created:
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-db-network          &lt;--- name starts with &quot;cluster&quot;</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mynamespace</span>
<span class="w">  </span><span class="nt">finalizers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/user-defined-network-protection</span>
<span class="w">  </span><span class="nt">ownerReferences</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/v1alpha1</span>
<span class="w">    </span><span class="nt">blockOwnerDeletion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterUserDefinedNetwork</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f45efb13-9511-48c1-95d7-44ee17c949f4</span><span class="w"> </span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span><span class="w">    </span>
<span class="w">      </span><span class="no">&#39;{</span>
<span class="w">          </span><span class="no">&quot;cniVersion&quot;:&quot;0.3.1&quot;,</span>
<span class="w">          </span><span class="no">&quot;excludeSubnets&quot;:&quot;10.0.0.100/24&quot;,</span>
<span class="w">          </span><span class="no">&quot;mtu&quot;:1500,   </span>
<span class="w">          </span><span class="no">&quot;name&quot;:&quot;cluster.udn.db-network&quot;,   &lt;--- generated unique network-name</span>
<span class="w">          </span><span class="no">&quot;netAttachDefName&quot;:&quot;mynamespace/db-network&quot;,</span>
<span class="w">          </span><span class="no">&quot;subnets&quot;:&quot;10.0.0.0/24&quot;,</span>
<span class="w">          </span><span class="no">&quot;topology&quot;:&quot;layer2&quot;,</span>
<span class="w">          </span><span class="no">&quot;type&quot;:&quot;ovn-k8s-cni-overlay&quot;,</span>
<span class="w">          </span><span class="no">&quot;role&quot;: &quot;primary&quot;</span>
<span class="w">      </span><span class="no">}&#39;</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-db-network                 &lt;--- same name as in other nameapces</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">theirnamespace</span>
<span class="w">  </span><span class="nt">finalizers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/user-defined-network-protection</span>
<span class="w">  </span><span class="nt">ownerReferences</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/v1alpha1</span>
<span class="w">    </span><span class="nt">blockOwnerDeletion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterUserDefinedNetwork</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-network</span>
<span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f45efb13-9511-48c1-95d7-44ee17c949f4</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">    </span><span class="no">&#39;{</span>
<span class="w">        </span><span class="no">&quot;cniVersion&quot;:&quot;0.3.1&quot;,</span>
<span class="w">        </span><span class="no">&quot;excludeSubnets&quot;:&quot;10.0.0.100/24&quot;,</span>
<span class="w">        </span><span class="no">&quot;mtu&quot;:1500,   </span>
<span class="w">        </span><span class="no">&quot;name&quot;:&quot;cluster.udn.db-network&quot;,   &lt;--- same name as in other namespaces</span>
<span class="w">        </span><span class="no">&quot;netAttachDefName&quot;:&quot;theirnamespace/db-network&quot;,</span>
<span class="w">        </span><span class="no">&quot;subnets&quot;:&quot;10.0.0.0/24&quot;,</span>
<span class="w">        </span><span class="no">&quot;topology&quot;:&quot;layer2&quot;,</span>
<span class="w">        </span><span class="no">&quot;type&quot;:&quot;ovn-k8s-cni-overlay&quot;,</span>
<span class="w">        </span><span class="no">&quot;role&quot;: &quot;primary&quot;</span>
<span class="w">    </span><span class="no">}&#39;</span>
</code></pre></div></p>
<h5 id="validations">Validations<a class="headerlink" href="#validations" title="Permanent link">&para;</a></h5>
<p>The controller should validate the request CRD spec and verify:
- CIDRs are valid.
- <code>Subnets</code> length is at least 1 when topology is <code>Layer3</code>.
- <code>Topology</code> is one of <code>Layer2</code>, <code>Layer3</code> or <code>Localnet</code>.
- <code>Role</code> is one of <code>Primary</code> or <code>Secondary</code>.
- <code>IPAM.Lifecycle</code> can be <code>Persistent</code>, and set only when topology is <code>Layer2</code> or <code>Localnet</code>.
- In case <code>Topology: Localnet</code>, <code>Role</code> cannot be <code>Primary</code></p>
<p>In addition, the following scenarios should be validated:
- The join subnet shall not overlap with the configured cluster default network join subnet.
  If there is overlap, OVN-Kubernetes should report an error in the request CR status.</p>
<ul>
<li>When primary network is requested (i.e.: <code>spec.role: Primary</code>)</li>
<li>
<p>Verify no primary network exist at the target namespace (i.e.: no NAD with <code>"primaryNetwork": "true"</code> exist).
    In case primary-network already exist, the request CR status should reflect network is not ready because primary network
    already exist at the target namespace.</p>
</li>
<li>
<p>In a scenario primary network created following CR request, and a primary NAD is created at the same target namespace,
  the CR status should reflect there's a conflicting primary NAD.</p>
</li>
<li>
<p>When CRD instance is deleted, ensure the network is not in use before continuing with deletion process (e.g.: remove finalizer).</p>
</li>
<li>Check no pod using the CRD instance corresponding NAD.</li>
<li>
<p>In case at least on pod using the network, update the status to reflect network cannot be deleted because its being used.</p>
</li>
<li>
<p>When a managed NAD already exist at the target namespace:</p>
</li>
<li>
<p>In case no owner-reference exist or owner-reference doesn't match the request CR object's UID,
    the controller should re-enqueue the request and reflect the error in status saying a foreign NAD exist.</p>
</li>
<li>
<p>When there is existing primary network cluster-scope CR "net1" (<code>spec.role: Primary</code>) specifies namespace "A","B","C".
  The admin create new primary network cluster-scope CR "net2" (<code>spec.role: Primary</code>) specifies namespaces "C","D","E".</p>
</li>
<li>The "net2" network should not be ready at namespace "C", the status should reflect network is not ready because
    primary network already exist in namespace "C".</li>
</ul>
<h5 id="best-practices-for-managing-ovn-network-using-crds">Best practices for managing OVN network using CRDs<a class="headerlink" href="#best-practices-for-managing-ovn-network-using-crds" title="Permanent link">&para;</a></h5>
<ul>
<li>NAD should be managed by cluster-admin only, it's not recommended to grant non-admin users permissions to create/modify delete NADs.</li>
<li>Managing user-defined-networks should be done using the suggested CRDs.
  <br>
  Creating user-defined-networks using NADs may introduce unexpected behaviour and collisions with NAD object the controller manage.</li>
<li>Managed NAD object should not be deleted manually, in order to delete a network, the corresponding CR instance should be deleted.</li>
<li>Only one primary network per namespace is supported.</li>
<li>Make sure no workloads exist on a namespace before creating primary network in that namespace.</li>
<li>For the cluster-scoped CRD, its recommended to use <code>kubernetes.io/metadata.name</code> label to specify the target namespaces.</li>
</ul>
<h4 id="udn-functional-implementation-details">UDN Functional Implementation Details<a class="headerlink" href="#udn-functional-implementation-details" title="Permanent link">&para;</a></h4>
<p>OVN offers the ability to create multiple virtual topologies. As with secondary networks in OVN-Kubernetes today,
separate topologies are created whenever a new network is needed. The same methodology will be leveraged for this design.
Whenever a new network of type layer 3 or layer 2 is requested, a new topology will be created for that network where
pods may connect to.</p>
<p>The limitation today with secondary networks is that there is only support for east/west traffic. This RFE will address
adding support for user-defined primary and secondary network north/south support. In order to support north/south
traffic, pods on different networks need to be able to egress, typically using the hosts IP. Today in shared gateway
mode we use a Gateway Router (GR) in order to provide this external connectivity, while in local gateway mode, the host
kernel handles SNATing and routing out egress traffic. Ingress traffic also follows similar, and reverse paths. There
are some exceptions to these rules:</p>
<ol>
<li>MEG traffic always uses the GR to send and receive traffic.</li>
<li>Egress IP on the primary NIC always uses the GR, even in local gateway mode.</li>
<li>Egress Services always use the host kernel for egress routing.</li>
</ol>
<p>To provide an ingress/egress point for pods on different networks the most simple solution may appear to be to connect
them all to a single gateway router. This introduces an issue where now networks are all connected to a single router,
and there may be routing happening between networks that were supposed to be isolated from one another. Furthermore in
the future, we will want to extend these networks beyond the cluster, and to do that in OVN would require making a
single router VRF aware, which adds more complexity into OVN.</p>
<p>The proposal here is to create a GR per network. With this topology, OVN will create a patch port per network to the
br-ex bridge. OVN-Kubernetes will be responsible for being VRF/network aware and forwarding packets via flows in br-ex
to the right GR. Each per-network GR will only have load balancers configured on it for its network, and only be able to
route to pods in its network. The logical topology would look something like this, if we use an example of having a
cluster default primary network, a layer 3 primary network, and a layer 2 primary network:</p>
<p><img alt="VRF Topology" src="../../images/VRFs.svg" /></p>
<p>In the above diagram, each network is assigned a unique conntrack zone and conntrack mark. These are required in order
to be able to handle overlapping networks egressing into the same VRF and SNATing to the host IP. Note, the default
cluster network does not need to use a unique CT mark or zone, and will continue to work as it does today. This is due
to the fact that no user-defined network may overlap with the default cluster subnet. More details in the next section.</p>
<h4 id="shared-gateway-mode">Shared Gateway Mode<a class="headerlink" href="#shared-gateway-mode" title="Permanent link">&para;</a></h4>
<h5 id="pod-egress">Pod Egress<a class="headerlink" href="#pod-egress" title="Permanent link">&para;</a></h5>
<p>On pod egress, the respective GR of that network will handle doing the SNAT to a unique masquerade subnet IP assigned to
this network. For example, in the above diagram packets leaving GR-layer3 would be SNATed to 169.254.169.5 in zone 64005.
The packet will then enter br-ex, where flows in br-ex will match this packet, and then SNAT the packet to the node IP
in zone 0, and apply its CT mark of 5. Finally, the packet will be recirculated back to table 0, where the packet will
be CT marked with 1 in zone 64000, and sent out of the physical interface. In OVN-Kubernetes we use zone 64000 to track
things from OVN or the host and additionally, we mark packets from OVN with a CT Mark of 1 and packets from the host
with 2. Pseudo openflow rules would look like this (assuming node IP of 172.18.0.3):</p>
<div class="highlight"><pre><span></span><code>pod--&gt;GR(snat, 169.254.169.5, zone 64005)-&gt;br-ex(snat, 172.18.0.3, zone 0, mark 5, table=0) --&gt;recirc table0 (commit
zone 64000, mark 1) --&gt;eth0
</code></pre></div>
<p>The above design will accommodate for overlapping networks with overlapping ports. The worst case scenario is if two
networks share the same address space, and two pods with identical IPs are trying to connect externally using the same
source and destination port. Although unlikely, we have to plan for this type of scenario. When each pod tries to send a
packet through their respective GR, SNATing to the unique GR masquerade IP differentiates the conntrack entries. Now,
when the final SNAT occurs in br-ex with zone 0, they can be determined as different connections via source IP, and when
SNATing to host IP, conntrack will detect a collision using the same layer 4 port, and choose a different port to use.</p>
<p>When reply traffic comes back into the cluster, we must now submit the packet to conntrack to find which network this
traffic belongs to. The packet is always first sent into zone 64000, where it is determined whether this packet
belonged to OVN (CT mark of 1) or the host. Once identified by CT mark as OVN traffic, the packet will then be unSNATed
in zone 0 via br-ex rules and the CT mark restored of which network it belonged to. Finally, we can send the packet to
the correct GR via the right patch port, by matching on the restored CT Mark. From there, OVN will handle unSNATing the
masquerade IP and forward the packet to the original pod.</p>
<p>To support KubeVirt live migration the GR LRP will have an extra address with the configured gateway for the layer2
subnet (to allow the gateway IP to be independent of the node where the VM is running on). After live migration succeeds,
OVN should send a GARP for VMs to clean up its ARP tables since the gateway IP has different mac now.</p>
<p>The live migration feature at layer 2 described here will work only with OVN interconnect (OVN IC, which is used by OCP).
Since there is no MAC learning between zones, so we can have the same extra address on every gateway router port, basically
implementing anycast for this SVI address.</p>
<p>Following is a picture that illustrate all these bits with a topology</p>
<p><img alt="Layer 2 Egress Topology" src="../../images/multi-homing-l2-gw.svg" /></p>
<h5 id="services_1">Services<a class="headerlink" href="#services_1" title="Permanent link">&para;</a></h5>
<p>When ingress service traffic enters br-ex, there are flows installed that steer service traffic towards the OVN GR. With
additional networks, these flows will be modified to steer traffic to the correct GR-&lt;network&gt;s patch port.</p>
<p>When a host process or host networked pod on a Kubernetes node initiates a connection to a service, iptables rules will
DNAT the nodeport or loadbalancer IP into the cluster IP, and then send the traffic via br-ex where it is masqueraded
and sent into the OVN GR. These flows can all be modified to detect the service IP and then send to the correct
GR-&lt;network&gt; patch port. For example, in the br-ex (breth0) bridge today we have flows that match on packets sent
to the service CIDR (10.96.0.0/24):</p>
<div class="highlight"><pre><span></span><code>[root@ovn-worker ~]# ovs-ofctl dump-flows breth0 table=0 | grep 10.96
 cookie=0xdeff105, duration=22226.373s, table=0, n_packets=41, n_bytes=4598, idle_age=19399,priority=500,ip,in_port=LOCAL,nw_dst=10.96.0.0/16 actions=ct(commit,table=2,zone=64001,nat(src=169.254.169.2))
</code></pre></div>
<p>Packets that are destined to the service CIDR are SNAT'ed to the masquerade IP of the host (169.254.169.2) and then
sent to the dispatch table 2:</p>
<div class="highlight"><pre><span></span><code>[root@ovn-worker ~]# ovs-ofctl dump-flows breth0 table=2
 cookie=0xdeff105, duration=22266.310s, table=2, n_packets=41, n_bytes=4598, actions=mod_dl_dst:02:42:ac:12:00:03,output:&quot;patch-breth0_ov&quot;
</code></pre></div>
<p>In the above flow, all packets have the dest MAC address changed to be that of the OVN GR, and then sent on the patch port
towards the OVN GR. With multiple networks, host access to cluster IP service flows will now be modified to be on a per
cluster IP basis. For example, if we assume two services exist on two user defined namespaces with cluster IPs 10.96.0.5
and 10.96.0.6. The flows would look like:</p>
<div class="highlight"><pre><span></span><code>[root@ovn-worker ~]# ovs-ofctl dump-flows breth0 table=0 | grep 10.96
 cookie=0xdeff105, duration=22226.373s, table=0, n_packets=41, n_bytes=4598, idle_age=19399,priority=500,ip,in_port=LOCAL,nw_dst=10.96.0.5 actions=set_field:2-&gt;reg1,ct(commit,table=2,zone=64001,nat(src=169.254.169.2))
 cookie=0xdeff105, duration=22226.373s, table=0, n_packets=41, n_bytes=4598, idle_age=19399,priority=500,ip,in_port=LOCAL,nw_dst=10.96.0.6 actions=set_field:3-&gt;reg1,ct(commit,table=2,zone=64001,nat(src=169.254.169.2))
</code></pre></div>
<p>The above flows are now per cluster IP and will send the packet to the dispatch table while also setting unique register
values to differentiate which OVN network these packets should be delivered to:</p>
<div class="highlight"><pre><span></span><code>[root@ovn-worker ~]# ovs-ofctl dump-flows breth0 table=2
 cookie=0xdeff105, duration=22266.310s, table=2, n_packets=41, n_bytes=4598, reg1=0x2 actions=mod_dl_dst:02:42:ac:12:00:05,output:&quot;patch-breth0-net1&quot;
 cookie=0xdeff105, duration=22266.310s, table=2, n_packets=41, n_bytes=4598, reg1=0x3 actions=mod_dl_dst:02:42:ac:12:00:06,output:&quot;patch-breth0-net2&quot;
</code></pre></div>
<p>Furthermore, host networked pod access to services will be restricted to the network it belongs to. For more information
see the <a href="#host-networked-pods">Host Networked Pods</a> section.</p>
<p>Additionally, in the case where there is hairpin service traffic to the host
(Host-&gt;Service-&gt;Endpoint is also the host), the endpoint reply traffic will need to be distinguishable on a per network
basis. In order to achieve this, each OVN GRs unique masquerade IP will be leveraged.</p>
<p>For service access towards KAPI/DNS or potentially other services on the cluster default network, there are two potential
technical solutions. Assume eth0 is the pod interface connected to the cluster default network, and eth1 is connected to the
user-defined primary network:</p>
<ol>
<li>
<p>Add routes for KAPI/DNS specifically into the pod to go out eth0, while all other service access will go to eth1.
   This will then just work normally with the load balancers on the switches for the respective networks.</p>
</li>
<li>
<p>Do not send any service traffic out of eth0, instead all service traffic goes to eth1. In this case all service
   traffic is flowing through the user-defined primary network, where only load balancers for that network are configured
   on that network's OVN worker switch. Therefore, packets to KAPI/DNS (services not on this network) are not DNAT'ed at
   the worker switch and are instead forwarded onwards to the ovn_cluster_router_&lt;user-defined network&gt; or
   GR-&lt;node-user-defined-network&gt; for layer 3 or layer 2 networks, respectively . This router is
   configured to send service CIDR traffic to ovn-k8s-mp0-&lt;user-defined network&gt;. IPTables rules in the host only permit
   access to KAPI/DNS and drop all other service traffic coming from ovn-k8s-mp0-&lt;user-defined network&gt;. The traffic then
   gets routed to br-ex and default GR where it hits the OVN load balancer there and forwarded to the right endpoint.</p>
</li>
</ol>
<p>While the second option is more complex, it allows for not configuring routes to service addresses in the pod that could
hypothetically change.</p>
<h5 id="egress-ip">Egress IP<a class="headerlink" href="#egress-ip" title="Permanent link">&para;</a></h5>
<p>This feature works today by labeling and choosing a node+network to be used for egress, and then OVN logical routes and
logical route policies are created which steer traffic from a pod towards a specific gateway router (for primary network
egress). From there the packets are SNATed by the OVN GR to the egress IP, and sent to br-ex. Egress IP is cluster
scoped, but applies to selected namespaces, which will allow us to only apply the SNAT and routes to the GR and OVN
topology elements of that network. In the layer 3 case, the current design used today for the cluster default primary
network will need some changes. Since Egress IP may be served on multiple namespaces and thus networks, it is possible
that there could be a collision as previously mentioned in the Pod Egress section. Therefore, the same solution provided
in that section where the GR SNATs to the masquerade subnet must be utilized. However, once the packet arrives in br-ex
we will need a way to tell if it was sent from a pod affected by a specific egress IP. To address this, pkt_mark will be
used to mark egress IP packets and signify to br-ex which egress IP to SNAT to. An example where the egress IP is
1.1.1.1 that maps to pkt_mark 10 would look something like this:</p>
<p><img alt="Egress IP VRF SGW" src="../../images/egress-ip-vrf-sgw.svg" /></p>
<p>For layer 2, egress IP has never been supported before. With the IC design, there is no need to have an
ovn_cluster_router and join switch separating the layer 2 switch network (transit switch) from the GR. Non-IC will
not be supported. In the layer 2 IC model, GRs per node on a network will all be connected to the layer 2 transit switch:</p>
<p><img alt="Egress IP Layer 2" src="../../images/egress-ip-l2-primary.svg" /></p>
<p>In the above diagram, Node 2 is chosen to be the egress IP node for any pods in namespace A. Pod 1 and Pod 2 have
default gateway routes to their respective GR on their node. When egress traffic leaves Pod 2, it is sent towards its
GR-A on node 2, where it is SNATed to the egress IP and the traffic sent to br-ex. For Pod 1, its traffic is sent to
its GR-A on Node 1, where it is then rerouted towards GR-A on Node 2 for egress.</p>
<h5 id="egress-firewall">Egress Firewall<a class="headerlink" href="#egress-firewall" title="Permanent link">&para;</a></h5>
<p>Egress firewall is enforced at the OVN logical switch, and this proposal has no effect on its functionality.</p>
<h5 id="egress-qos">Egress QoS<a class="headerlink" href="#egress-qos" title="Permanent link">&para;</a></h5>
<p>Egress QoS is namespace scoped and functions by marking packets at the OVN logical switch, and this proposal has no
effect on its functionality.</p>
<h5 id="egress-service">Egress Service<a class="headerlink" href="#egress-service" title="Permanent link">&para;</a></h5>
<p>Egress service is namespace scoped and its primary function is to SNAT egress packets to a load balancer IP. As
previously mentioned, the feature works the same in shared and local gateway mode, by leveraging the local gateway mode
path. Therefore, its design will be covered in the Local Gateway Mode section of the Design Details.</p>
<h5 id="multiple-external-gateways-meg-admin-based-policy-routing-abpr">Multiple External Gateways (MEG) / Admin Based Policy Routing (ABPR)<a class="headerlink" href="#multiple-external-gateways-meg-admin-based-policy-routing-abpr" title="Permanent link">&para;</a></h5>
<p>There will be no support for MEG or pod direct ingress on any network other than the primary, cluster default network.
This support may be enhanced later by extending VRFs/networks outside the cluster.</p>
<h4 id="local-gateway-mode">Local Gateway Mode<a class="headerlink" href="#local-gateway-mode" title="Permanent link">&para;</a></h4>
<p>With local gateway mode, egress/ingress traffic uses the kernels networking stack as a next hop. OVN-Kubernetes
leverages an interface named ovn-k8s-mp0 in order to facilitate sending traffic to and receiving traffic from the
host. For egress traffic, the host routing table decides where to send the egress packet, and then the source IP is
masqueraded to the node IP of the egress interface. For ingress traffic, the host routing table steers packets destined
for pods via ovn-k8s-mp0 and SNATs the packet to the interface address.</p>
<p>For multiple networks to use local gateway mode, some changes are necessary. The ovn-k8s-mp0 port is a logical port in
the OVN topology tied to the cluster default network. There will need to be multiple ovn-k8s-mp0 ports created, one per
network. Additionally, all of these ports cannot reside in the default VRF of the host network. Doing so would result in
an inability to have overlapping subnets, as well as the host VRF would be capable of routing packets between namespace
networks, which is undesirable. Therefore, each ovn-k8s-mp0-&lt;network&gt; interface must be placed in its own VRF:</p>
<p><img alt="Local GW Node Setup" src="../../images/local-gw-node-setup-vrfs.svg" /></p>
<p>The VRFs will clone the default routing table, excluding routes that are created by OVN-Kubernetes for its networks.
This is similar to the methodology in place today for supporting
<a href="https://github.com/ovn-kubernetes/ovn-kubernetes/blob/master/docs/features/cluster-egress-controls/egress-ip.md#egressip-ip-is-assigned-to-a-secondary-host-interface">Egress IP with multiple NICs</a>.</p>
<h5 id="pod-egress_1">Pod Egress<a class="headerlink" href="#pod-egress_1" title="Permanent link">&para;</a></h5>
<p>Similar to the predicament outlined in Shared Gateway mode, we need to solve the improbable case where two networks have
the same address space, and pods with the same IP/ports are trying to talk externally to the same server. In this case,
OVN-Kubernetes will reserve an extra IP from the masquerade subnet per network. This masquerade IP will be used to SNAT
egress packets from pods leaving via mp0. The SNAT will be performed by ovn_cluster_router for layer 3 networks and
the gateway router (GR) for layer 2 networks using configuration like:</p>
<div class="highlight"><pre><span></span><code>[root@ovn-worker ~]# ovn-nbctl lr-nat-list daac7843-ad73-4b73-b415-e432a28f0d61
TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                   eth.dst == 0a:58:0    169.254.0.100                       10.20.1.0/24
</code></pre></div>
<p>Now when egress traffic arrives in the host via mp0, it will enter the VRF, where clone routes will route the packet as
if it was in the default VRF out a physical interface, typically towards br-ex, and the packet is SNATed to the host IP.</p>
<p>When the egress reply comes back into the host, iptables will unSNAT the packet and the destination will be
169.254.169.100. At this point, an ip rule will match the destination on the packet and do a lookup in the VRF where a
route specifying 169.254.169.100/32 via 10.244.0.1 will cause the packet to be sent back out the right mp0 port for the
respective network.</p>
<p>Note, the extra masquerade SNAT will not be required on the cluster default network's ovn-k8s-mp0 port. This will
preserve the previous behavior, and it is not necessary to introduce this SNAT since the default cluster network subnet
may not overlap with user-defined networks.</p>
<h5 id="services_2">Services<a class="headerlink" href="#services_2" title="Permanent link">&para;</a></h5>
<p>Local gateway mode services function similar to the behavior described in host -&gt; service description in the Shared
Gateway Mode Services section. When the packet enters br-ex, it is forwarded to the host, where it is then DNATed to
the cluster IP and typically sent back into br-ex towards the OVN GR. This traffic will behave the same as previously
described. There are some exceptions to this case, namely when external traffic policy (ETP) is set to local. In this
case traffic is DNATed to a special masquerade IP (169.254.169.3) and sent via ovn-k8s-mp0. There will need to be IP
rules to match on the destination node port and steer traffic to the right VRF for this case. Additionally, with internal
traffic policy (ITP) is set to local, packets are marked in the mangle table and forwarded via ovn-k8s-mp0 with an IP
rule and routing table 7. This logic will need to ensure the right ovn-k8s-mp0 is chosen for this case as well.</p>
<h5 id="egress-ip_1">Egress IP<a class="headerlink" href="#egress-ip_1" title="Permanent link">&para;</a></h5>
<p>As previously mentioned, egress IP on the primary NIC follows the pathway of shared gateway mode. The traffic is not
routed by the kernel networking stack as a next hop. However, for multi-nic support, packets are sent into the kernel
via the ovn-k8s-mp0 port. Here the packets are matched on, sent to an egress IP VRF, SNATed and sent out the chosen
interface. The detailed steps for a pod with IP address 10.244.2.3 affected by egress IP look like:</p>
<ol>
<li>Pod sends egress packet, arrives in the kernel via ovn-k8s-mp0 port, the packet is marked with 1008 (0x3f0 in hex)
   if it should skip egress IP. It has no mark if the packet should be affected by egress IP.</li>
<li>
<p>IP rules match the source IP of the packet, and send it into an egress IP VRF (rule 6000):</p>
<p>```
   sh-5.2# ip rule</p>
</li>
</ol>
<p>0:   from all lookup local
   30:  from all fwmark 0x1745ec lookup 7
   5999:    from all fwmark 0x3f0 lookup main
   6000:    from 10.244.2.3 lookup 1111
   32766:   from all lookup main
   32767:   from all lookup default
   ```</p>
<ol>
<li>
<p>Iptables rules save the packet mark in conntrack. This is only applicable to packets that were marked with 1008 and
   are bypassing egress IP:</p>
<div class="highlight"><pre><span></span><code>sh-5.2# iptables -t mangle -L  PREROUTING

Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
CONNMARK   all  --  anywhere             anywhere             mark match 0x3f0 CONNMARK save
CONNMARK   all  --  anywhere             anywhere             mark match 0x0 CONNMARK restore
</code></pre></div>
</li>
<li>
<p>VRF 1111 has a route in it to steer the packet to the right egress interface:</p>
<div class="highlight"><pre><span></span><code>sh-5.2# ip route show table 1111
default dev eth1
</code></pre></div>
</li>
<li>
<p>IPTables rules in NAT table SNAT the packet:</p>
<div class="highlight"><pre><span></span><code>-A OVN-KUBE-EGRESS-IP-MULTI-NIC -s 10.244.2.3/32 -o eth1 -j SNAT --to-source 10.10.10.100
</code></pre></div>
</li>
<li>
<p>For reply bypass traffic, the 0x3f0 mark is restored, and ip rules 5999 send it back into default VRF for routing
   back into mp0 for non-egress IP packets. This is rule and connmark restoring is required for the packet to pass the
   reverse path filter (RPF) check. For egress IP reply packets, there is no connmark restored and the packets hit the
   default routing table to go back into mp0.</p>
</li>
</ol>
<p>This functionality will continue to work, with ip rules steering the packets from the per network VRF to the appropriate
egress IP VRF. CONNMARK will continue to be used so that return traffic is sent back to the correct VRF. Step 5 in the
above may need to be tweaked to match on mark in case 2 pods have overlapping IPs, and are both egressing
the same interface with different Egress IPs. The flow would look something like this:</p>
<p><img alt="Egress IP VRF LGW" src="../../images/egress-ip-vrf-lgw.svg" /></p>
<h5 id="egress-firewall_1">Egress Firewall<a class="headerlink" href="#egress-firewall_1" title="Permanent link">&para;</a></h5>
<p>Egress firewall is enforced at the OVN logical switch, and this proposal has no effect on its functionality.</p>
<h5 id="egress-qos_1">Egress QoS<a class="headerlink" href="#egress-qos_1" title="Permanent link">&para;</a></h5>
<p>Egress QoS is namespace scoped and functions by marking packets at the OVN logical switch, and this proposal has no
effect on its functionality.</p>
<h5 id="egress-service_1">Egress Service<a class="headerlink" href="#egress-service_1" title="Permanent link">&para;</a></h5>
<p>Egress service functions similar to Egress IP in local gateway mode, with the exception that all traffic paths go
through the kernel networking stack. Egress Service also uses IP rules and VRFs in order to match on traffic and forward
it out the right network (if specified in the CRD). It uses iptables in order to SNAT packets to the load balancer IP.
Like Egress IP, with user-defined networks there will need to be IP rules with higher precedence to match on packets from
specific networks and direct them to the right VRF.</p>
<h5 id="multiple-external-gateways-meg">Multiple External Gateways (MEG)<a class="headerlink" href="#multiple-external-gateways-meg" title="Permanent link">&para;</a></h5>
<p>There will be no support for MEG or pod direct ingress on any network other than the primary, cluster default network.
Remember, MEG works the same way in local or shared gateway mode, by utilizing the shared gateway path. This support may
be enhanced later by extending VRFs/networks outside the cluster.</p>
<h4 id="kubernetes-readinessliveness-probes">Kubernetes Readiness/Liveness Probes<a class="headerlink" href="#kubernetes-readinessliveness-probes" title="Permanent link">&para;</a></h4>
<p>As previously mentioned, Kubelet probes will continue to work. This includes all types of probes such as TCP, HTTP or
GRPC. Additionally, we want to restrict host networked pods in namespaces that belong to user-defined networks from
being able to access pods in other networks. For that reason, we need to block host networked pods from being able to
access pods via the cluster default network. In order to do this, but still allow Kubelet to send probes; the cgroup
module in iptables will be leveraged. For example:</p>
<div class="highlight"><pre><span></span><code>root@ovn-worker:/# iptables -L -t raw -v
Chain PREROUTING (policy ACCEPT 6587 packets, 1438K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 3003 packets, 940K bytes)
 pkts bytes target     prot opt in     out     source               destination         
 3677 1029K ACCEPT     all  --  any    any     anywhere             anywhere             cgroup kubelet.slice/kubelet.service
    0     0 ACCEPT     all  --  any    any     anywhere             anywhere             ctstate ESTABLISHED
  564 33840 DROP       all  --  any    any     anywhere             10.244.0.0/16    
</code></pre></div>
<p>From the output we can see that traffic to the pod network <code>10.244.0.0/16</code> will be dropped by default. However,
traffic coming from kubelet will be allowed.</p>
<h4 id="host-networked-pods">Host Networked Pods<a class="headerlink" href="#host-networked-pods" title="Permanent link">&para;</a></h4>
<h5 id="vrf-considerations">VRF Considerations<a class="headerlink" href="#vrf-considerations" title="Permanent link">&para;</a></h5>
<p>By encompassing VRFs into the host, this introduces some constraints and requirements for the behavior of host networked
type pods. If a host networked pod is created in a Kubernetes namespace that has a user-defined network, it should be
confined to only talking to ovn-networked pods on that same user-defined network.</p>
<p>With Linux VRFs, different socket types behave differently by default. Raw, unbound sockets by default are allowed to
listen and span multiple VRFs, while TCP, UDP, SCTP and other protocols are restricted to the default VRF. There are
settings to control this behavior via sysctl, with the defaults looking like this:</p>
<div class="highlight"><pre><span></span><code>trozet@fedora:~/Downloads/ip-10-0-169-248.us-east-2.compute.internal$ sudo sysctl -A | grep net | grep l3mdev
net.ipv4.raw_l3mdev_accept = 1
net.ipv4.tcp_l3mdev_accept = 0
net.ipv4.udp_l3mdev_accept = 0
</code></pre></div>
<p>Note, there is no current <a href="https://lore.kernel.org/netdev/bf6bcf15c5b1f921758bc92cae2660f68ed6848b.1668357542.git.lucien.xin@gmail.com/">support in the kernel for SCTP</a>,
and it does not look like there is support for IPv6. Given the desired behavior to restrict host networked pods to
talking to only pods in their namespace/network, it may make sense to set raw_l3dev_accept to 0. This is set to 1 by
default to allow legacy ping applications to work over VRFs. Furthermore, a user modifying sysctl settings to allow
applications to listen across all VRFs will be unsupported. Reasons include there can be odd behavior and interactions
that occur with applications communicating across multiple VRFs, as well as the fact that this would break the native
network isolation paradigm offered by this feature.</p>
<p>For host network pods to be able to communicate with pod IPs on their user-defined network, the only supported method
will be for the applications to bind their socket to the VRF device. Many applications will not be able to support this,
so in the future it makes sense to come up with a better solution. One possibility is to use ebpf in order to intercept
the socket bind call of an application (that typically will bind to INADDR_ANY) and force it to bind to the VRF device.
Note, host network pods will still be able to communicate with pods via services that belong to its user-defined network
without any limitations. See the next section <a href="#service-access">Service Access</a> for more information.</p>
<p>Keep in mind that if a host network pod runs and does not bind to the VRF device, it will be able to communicate on the
default VRF. This means the host networked pod will be able to talk to other host network pods. However, due to nftables
rules in the host however, it will not be able to talk to OVN networked pods via the default cluster network/VRF.</p>
<p>For more information on how VRFs function in Linux and the settings discussed in this section, refer to
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/networking/vrf.rst?h=v6.1">https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/networking/vrf.rst?h=v6.1</a> for
more details.</p>
<h5 id="service-access">Service Access<a class="headerlink" href="#service-access" title="Permanent link">&para;</a></h5>
<p>Host networked pods in a user-defined network will be restricted to only accessing services in either:
1. The cluster default network.
2. The user-defined network in which the host networked pod's namespace belongs to.</p>
<p>This will be enforced by iptables/nftables rules added that match on the cgroup of the host networked pod. For example:</p>
<p><div class="highlight"><pre><span></span><code>root@ovn-worker:/# iptables -L -t raw -v
Chain PREROUTING (policy ACCEPT 60862 packets, 385M bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 36855 packets, 2504K bytes)
 pkts bytes target     prot opt in     out     source               destination         
   17  1800 ACCEPT     all  --  any    any     anywhere             10.96.0.1            cgroup /kubelet.slice/kubelet-kubepods.slice/kubelet-kubepods-besteffort.slice/kubelet-kubepods-besteffort-pod992d3b9e_3f85_42e2_9558_9d4273d4236f.slice
23840 6376K ACCEPT     all  --  any    any     anywhere             anywhere             cgroup kubelet.slice/kubelet.service
    0     0 ACCEPT     all  --  any    any     anywhere             anywhere             ctstate ESTABLISHED
  638 37720 DROP       all  --  any    any     anywhere             10.244.0.0/16       
   28  1440 DROP       all  --  any    any     anywhere             10.96.0.0/16
</code></pre></div>
In the example above, access to the service network of <code>10.96.0.0/16</code> is denied by default. However, one host networked
pod is given access to the 10.96.0.1 cluster IP service, while other host networked pods are blocked from access.</p>
<h3 id="testing-details">Testing Details<a class="headerlink" href="#testing-details" title="Permanent link">&para;</a></h3>
<ul>
<li>E2E upstream CI jobs covering supported features across multiple networks.</li>
<li>E2E tests which ensure network isolation between OVN networked and host networked pods, services, etc.</li>
<li>E2E tests covering network subnet overlap and reachability to external networks.</li>
<li>Scale testing to determine limits and impact of multiple user-defined networks. This is not only limited to OVN, but
  also includes OVN-Kubernetes design where we spawn a new network controller for every new network created.</li>
<li>Integration testing with other features like IPSec to ensure compatibility.</li>
<li>E2E tests verify the expected NAD is generated according to CRDs spec.</li>
<li>E2E tests verify workloads on different namespaces connected to namespace scoped OVN network with the same name cannot communicate.</li>
<li>E2E tests verify workloads on different namespaces connected to cluster-scope OVN network can communicate.</li>
</ul>
<h3 id="documentation-details">Documentation Details<a class="headerlink" href="#documentation-details" title="Permanent link">&para;</a></h3>
<ul>
<li>ovn-kubernetes.io will be updated with a UDN user guide, and a support matrix showing what features are supported
  with UDN.</li>
<li>Additional dev guides will be added to the repo to show how the internal design of UDN is implemented.</li>
</ul>
<h2 id="risks-known-limitations-and-mitigations">Risks, Known Limitations and Mitigations<a class="headerlink" href="#risks-known-limitations-and-mitigations" title="Permanent link">&para;</a></h2>
<h3 id="risks-and-mitigations">Risks and Mitigations<a class="headerlink" href="#risks-and-mitigations" title="Permanent link">&para;</a></h3>
<p>The biggest risk with this feature is hitting scale limitations. With many namespaces and networks, the number of
internal OVN objects will multiply, as well as internal kernel devices, rules, VRFs. There will need to be a large-scale
effort to determine how many networks we can comfortably support.</p>
<p>Following the introduction of a CRD for non-admin users create OVN network, there is a risk a non-admin users could
cause node / OVN resources starvation due to creating too many OVN networks.
To mitigates it, CRDs controller could monitor how many OVN network exists and reject new ones in case a given limit is exceeded.</p>
<p>Alternatively, OVN-K resources should be exposed as node resource (using the device-plugin API).
Once a node resource is exposed, it will enable using the <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/#resource-quota-for-extended-resources">resource-quota API</a>
and put boundaries on how many networks could exist.</p>
<p>There is also a risk of breaking secondary projects that integrate with OVN-Kubernetes, such as Metal LB or Submariner.</p>
<h3 id="drawbacks">Drawbacks<a class="headerlink" href="#drawbacks" title="Permanent link">&para;</a></h3>
<p>As described in the Design Details section, this proposal will require reserving two IPs per network in the masquerade
subnet. This is a private subnet only used internally by OVN-Kubernetes, but it will require increasing the subnet size
in order to accommodate multiple networks. Today this subnet by default is configured as a /29 for IPv4, and only 6 IP
addresses are used. With this new design, users will need to reconfigure their subnet to be large enough to hold the
desired number of networks. Note, API changes will need to be made in order to support changing the masquerade subnet
post-installation.</p>
<h2 id="ovn-kubernetes-version-skew">OVN-Kubernetes Version Skew<a class="headerlink" href="#ovn-kubernetes-version-skew" title="Permanent link">&para;</a></h2>
<p>UDN will be delivered in version 1.1.0.</p>
<h2 id="alternatives">Alternatives<a class="headerlink" href="#alternatives" title="Permanent link">&para;</a></h2>
<p>None</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<p>None</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  OVN-Kubernetes a Series of LF Projects, LLC. For website terms of use, trademark policy and other project policies please see <a href="https://lfprojects.org/policies/">LF Projects Policies</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/gemini-api-key.js"></script>
      
        <script src="../../javascripts/theme.js"></script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>