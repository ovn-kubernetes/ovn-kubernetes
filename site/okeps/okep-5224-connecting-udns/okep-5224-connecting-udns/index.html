
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://www.ovn.org/ovn-kubernetes/okeps/okep-5224-connecting-udns/okep-5224-connecting-udns/">
      
      
        <link rel="prev" href="../../okep-5552-dynamic-udn-node-allocation/">
      
      
        <link rel="next" href="../../okep-5259-no-overlay/">
      
      
        
      
      
      <link rel="icon" href="../../../images/ovn-inside-k8s.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Connecting User Defined Networks - OVN-Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#okep-5224-connecting-userdefinednetworks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="OVN-Kubernetes" class="md-header__button md-logo" aria-label="OVN-Kubernetes" data-md-component="logo">
      
  <img src="../../../images/ovn-inside-k8s.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OVN-Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Connecting User Defined Networks
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-label="Blueprint"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Blueprint" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.5 3A5.5 5.5 0 0 1 14 8.5c0 1.33-.47 2.55-1.26 3.5H21v9h-9v-8.26c-.95.79-2.17 1.26-3.5 1.26A5.5 5.5 0 0 1 3 8.5 5.5 5.5 0 0 1 8.5 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="cyan" data-md-color-accent="purple"  aria-label="Nerve Center"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Nerve Center" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19.07 4.93-1.41 1.41A8.01 8.01 0 0 1 20 12a8 8 0 0 1-8 8 8 8 0 0 1-8-8c0-4.08 3.05-7.44 7-7.93v2.02C8.16 6.57 6 9.03 6 12a6 6 0 0 0 6 6 6 6 0 0 0 6-6c0-1.66-.67-3.16-1.76-4.24l-1.41 1.41C15.55 9.9 16 10.9 16 12a4 4 0 0 1-4 4 4 4 0 0 1-4-4c0-1.86 1.28-3.41 3-3.86v2.14c-.6.35-1 .98-1 1.72a2 2 0 0 0 2 2 2 2 0 0 0 2-2c0-.74-.4-1.38-1-1.72V2h-1A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-2.76-1.12-5.26-2.93-7.07"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ovn-org/ovn-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ovn-org/ovn-kubernetes
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
    
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../installation/launching-ovn-kubernetes-on-kind/" class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../governance/CONTRIBUTING/" class="md-tabs__link">
          
  
  
    
  
  Developer Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../api-reference/introduction/" class="md-tabs__link">
          
  
  
    
  
  API Reference Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../features/user-defined-networks/user-defined-networks/" class="md-tabs__link">
          
  
  
    
  
  Features

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../troubleshooting/debugging/" class="md-tabs__link">
          
  
  
    
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../observability/metrics/" class="md-tabs__link">
          
  
  
    
  
  Observability

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../okep-5085-localnet-api/" class="md-tabs__link">
          
  
  
    
  
  Enhancement Proposals

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../blog/" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="OVN-Kubernetes" class="md-nav__button md-logo" aria-label="OVN-Kubernetes" data-md-component="logo">
      
  <img src="../../../images/ovn-inside-k8s.png" alt="logo">

    </a>
    OVN-Kubernetes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ovn-org/ovn-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ovn-org/ovn-kubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Overview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/topology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Topology
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/gateway-modes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gateway Modes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/traffic-flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Traffic Flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/pod-creation-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pod Creation Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/service-creation-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Creation Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/service-traffic-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Traffic Policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/host-to-node-port-hairpin-trafficflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Host To NodePort Hairpin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/external-ip-and-loadbalancer-ingress/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ExternalIPs/LoadBalancerIngress
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/ovn-kubernetes-subnets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Internal Subnets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/live-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubevirt VM Live Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/launching-ovn-kubernetes-on-kind/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launching OVN-Kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/launching-ovn-kubernetes-with-helm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launching OVN-Kubernetes Using Helm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/cli-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/example-pod-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying Workloads on OVN-Kubernetes cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/example-service-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying Services on OVN-Kubernetes cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/building-ovn-kubernetes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup and Building
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Developer Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developer Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/REVIEWING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reviewing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/developer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coding Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/image-build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVN-Kubernetes Container Images
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/local_testing_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local Testing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ci/ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CI Testing Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/release/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/egress-ip-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/egress-service-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressService
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/egress-qos-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressQoS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/egress-firewall-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressFirewall
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/admin-epbr-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AdminPolicyBasedExternalRoutes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/userdefinednetwork-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UserDefinedNetwork
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api-reference/routeadvertisements-api-spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RouteAdvertisements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Universal Connectivity
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Universal Connectivity
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/user-defined-networks/user-defined-networks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UserDefinedNetwork
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    NetworkSecurityControls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    NetworkSecurityControls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/network-security-controls/admin-network-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AdminNetworkPolicy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/network-security-controls/network-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NetworkPolicy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/network-security-controls/egress-firewall/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressFirewall
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ClusterEgressControls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    ClusterEgressControls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/cluster-egress-controls/egress-ip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/cluster-egress-controls/egress-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressService
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/cluster-egress-controls/egress-qos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressQoS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/cluster-egress-controls/egress-gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EgressGateway
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    InfrastructureSecurityControls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    InfrastructureSecurityControls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/infrastructure-security-controls/node-identity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NodeIdentity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    MultiNetworking
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    MultiNetworking
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/multiple-networks/multi-homing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multihoming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/multiple-networks/multi-network-policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MultiNetworkPolicies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/multiple-networks/multi-vtep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MultiNetworkRails
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/multicast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multicast
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    NetworkQoS
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    NetworkQoS
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/network-qos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/network-qos-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/live-migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubevirt VM Live Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/hybrid-overlay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HybridOverlay
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Hardware Acceleration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hardware Acceleration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/hardware-offload/ovs-kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVS Acceleration with kernel datapath
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/hardware-offload/ovs-doca/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVS Acceleration with DOCA datapath
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    BGP Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    BGP Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/bgp-integration/route-advertisements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Route Advertisements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Troubleshooting
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/ovnkube-trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVNKube Trace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Observability
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../observability/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../observability/sdn-dashboard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDN Dashboard
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../observability/ovn-observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OVN observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Enhancement Proposals
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Enhancement Proposals
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5085-localnet-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Localnet API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-4380-network-qos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network QoS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5193-user-defined-networks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User Defined Networks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5233-preconfigured-udn-addresses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preconfigured UDN Addresses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5296-bgp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BGP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5094-layer2-transit-router/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Layer2TransitRouter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5494-ovn-kubernetes-mcp-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP for Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5552-dynamic-udn-node-allocation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic UDN Node Allocation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Connecting User Defined Networks
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Connecting User Defined Networks
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem Statement
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem Statement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-personas" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Personas:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#symmetric-nature-of-udn-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Symmetric nature of UDN Connectivity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-transitive-nature-of-udn-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Transitive nature of UDN Connectivity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-storiesuse-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        User-Stories/Use-Cases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User-Stories/Use-Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#story-1-allowing-network-expansion-for-a-tenant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 1: Allowing network expansion for a tenant
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-2-allowing-connectivity-between-two-tenants-through-exposed-clusterip-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 2: Allowing connectivity between two tenants through exposed clusterIP services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-3-allowing-connectivity-between-two-networks-with-overlapping-subnets-through-exposed-clusterip-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 3: Allowing connectivity between two networks with overlapping subnets through exposed clusterIP services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-4-merging-two-tenants-maybe-even-temporarily" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 4: Merging two tenants (maybe even temporarily)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-5-same-udn-across-multiple-clusters-must-be-connected-by-default" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 5: Same UDN across multiple clusters must be connected by default
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-6-connecting-mixed-type-networks-together-layer2-network-workloads-with-layer3-primarydefault-network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 6: Connecting mixed type networks together (Layer2 Network workloads with Layer3 Primary/Default Network)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-7-migration-of-connected-tenant-workloads-from-other-platforms-like-nsx-into-ovn-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 7: Migration of connected tenant workloads from other platforms like NSX into OVN-Kubernetes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-8-future-use-case-tenant-self-connection-without-admin-intervention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 8: [Future Use Case] Tenant self-connection without admin intervention
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Proposed Solution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#config-for-enabling-the-feature" class="md-nav__link">
    <span class="md-ellipsis">
      
        Config for enabling the feature
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-field-details-and-cel-validations" class="md-nav__link">
    <span class="md-ellipsis">
      
        API field details and CEL Validations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-field-checks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validation Field Checks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#valid-ways-of-connectingselectingdisconnecting-udns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Valid ways of Connecting/Selecting/Disconnecting UDNs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statusconditions" class="md-nav__link">
    <span class="md-ellipsis">
      
        StatusConditions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#network-topology" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Topology
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-policies-and-admin-network-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Policies and Admin Network Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controller-design-changes-to-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controller Design / Changes to Components
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Controller Design / Changes to Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#algorithm-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Algorithm Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scale Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-feature-interaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross Feature Interaction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cross Feature Interaction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-advertised-udns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connecting Advertised UDNs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connecting-udns-with-no-overlay-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connecting UDNs with no overlay mode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing Details
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documentation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Documentation Details
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risks-known-limitations-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Risks, Known Limitations and Mitigations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Risks, Known Limitations and Mitigations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scale-and-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scale and Performance
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovn-kubernetes-version-skew" class="md-nav__link">
    <span class="md-ellipsis">
      
        OVN Kubernetes Version Skew
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternatives
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alternatives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-bgp-and-routeradvertisement-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using BGP and RouterAdvertisement API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-alternative-connection-ideas-on-ovn-topology-level" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using alternative connection ideas on OVN topology level
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-nodenetwork-cr-instead-of-annotations-on-clusternetworkconnect-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using NodeNetwork CR instead of Annotations on ClusterNetworkConnect API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#have-clustermanager-give-out-point-to-point-subnet-slices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Have ClusterManager give out point to point subnet slices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-load-balancers-on-transit-connect-routers-for-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding load balancers on transit connect routers for services
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependencies
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5259-no-overlay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    No-Overlay Mode
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5088-evpn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EVPN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../okep-5674-dpu-healthcheck/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPU Healthcheck
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../blog/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem Statement
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem Statement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-personas" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Personas:
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#symmetric-nature-of-udn-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Symmetric nature of UDN Connectivity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-transitive-nature-of-udn-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Non-Transitive nature of UDN Connectivity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-storiesuse-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        User-Stories/Use-Cases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User-Stories/Use-Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#story-1-allowing-network-expansion-for-a-tenant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 1: Allowing network expansion for a tenant
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-2-allowing-connectivity-between-two-tenants-through-exposed-clusterip-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 2: Allowing connectivity between two tenants through exposed clusterIP services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-3-allowing-connectivity-between-two-networks-with-overlapping-subnets-through-exposed-clusterip-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 3: Allowing connectivity between two networks with overlapping subnets through exposed clusterIP services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-4-merging-two-tenants-maybe-even-temporarily" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 4: Merging two tenants (maybe even temporarily)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-5-same-udn-across-multiple-clusters-must-be-connected-by-default" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 5: Same UDN across multiple clusters must be connected by default
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-6-connecting-mixed-type-networks-together-layer2-network-workloads-with-layer3-primarydefault-network" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 6: Connecting mixed type networks together (Layer2 Network workloads with Layer3 Primary/Default Network)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-7-migration-of-connected-tenant-workloads-from-other-platforms-like-nsx-into-ovn-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 7: Migration of connected tenant workloads from other platforms like NSX into OVN-Kubernetes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#story-8-future-use-case-tenant-self-connection-without-admin-intervention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Story 8: [Future Use Case] Tenant self-connection without admin intervention
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Proposed Solution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#config-for-enabling-the-feature" class="md-nav__link">
    <span class="md-ellipsis">
      
        Config for enabling the feature
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-field-details-and-cel-validations" class="md-nav__link">
    <span class="md-ellipsis">
      
        API field details and CEL Validations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-field-checks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validation Field Checks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#valid-ways-of-connectingselectingdisconnecting-udns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Valid ways of Connecting/Selecting/Disconnecting UDNs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statusconditions" class="md-nav__link">
    <span class="md-ellipsis">
      
        StatusConditions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#network-topology" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Topology
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Services
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-policies-and-admin-network-policies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Policies and Admin Network Policies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controller-design-changes-to-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controller Design / Changes to Components
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Controller Design / Changes to Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#algorithm-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Algorithm Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Allocation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scale Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-feature-interaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cross Feature Interaction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cross Feature Interaction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-advertised-udns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connecting Advertised UDNs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connecting-udns-with-no-overlay-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connecting UDNs with no overlay mode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing Details
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documentation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Documentation Details
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risks-known-limitations-and-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Risks, Known Limitations and Mitigations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Risks, Known Limitations and Mitigations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scale-and-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scale and Performance
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovn-kubernetes-version-skew" class="md-nav__link">
    <span class="md-ellipsis">
      
        OVN Kubernetes Version Skew
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alternatives
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alternatives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-bgp-and-routeradvertisement-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using BGP and RouterAdvertisement API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-alternative-connection-ideas-on-ovn-topology-level" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using alternative connection ideas on OVN topology level
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-nodenetwork-cr-instead-of-annotations-on-clusternetworkconnect-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using NodeNetwork CR instead of Annotations on ClusterNetworkConnect API
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#have-clustermanager-give-out-point-to-point-subnet-slices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Have ClusterManager give out point to point subnet slices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-load-balancers-on-transit-connect-routers-for-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adding load balancers on transit connect routers for services
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependencies
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="okep-5224-connecting-userdefinednetworks">OKEP-5224: Connecting UserDefinedNetworks<a class="headerlink" href="#okep-5224-connecting-userdefinednetworks" title="Permanent link">&para;</a></h1>
<h2 id="problem-statement">Problem Statement<a class="headerlink" href="#problem-statement" title="Permanent link">&para;</a></h2>
<p>A (C)UDN is an isolated island, however, we have users that wish to connect
these islands together for multiple reasons. This OKEP proposes a solution
to connect multiple <a href="https://ovn-kubernetes.io/api-reference/userdefinednetwork-api-spec/#userdefinednetwork">UserDefinedNetworks</a> or <a href="https://ovn-kubernetes.io/api-reference/userdefinednetwork-api-spec/#clusteruserdefinednetwork">ClusterUserDefinedNetworks</a>
together, better known as "Connecting (C)UDNs". This solution will ensure
that (C)UDNs remain isolated unless an explicit request to connect them
together has been made.</p>
<h3 id="user-personas">User Personas:<a class="headerlink" href="#user-personas" title="Permanent link">&para;</a></h3>
<ul>
<li><code>Admin</code>: Cluster administrator who has the highest priviledge access to
  the cluster. Admin creates the namespaces for each tenant in the cluster.</li>
<li><code>Tenant</code>: A tenant is an end user who owns the resources (workloads,
  policies, services, udns) created in one or more namespaces that are
  designated to them by admins. They cannot update or mutate the
  namespace(s) but they live within the namespace(s) boundary controlled
  using RBAC.</li>
</ul>
<h2 id="goals">Goals<a class="headerlink" href="#goals" title="Permanent link">&para;</a></h2>
<ul>
<li>Connecting and disconnecting UDNs and CUDNs within the same cluster
  aka intra-cluster-udn-connectivity for admins (can be done as day0 or
  day2).</li>
<li>Support for connecting primary <code>CUDN&lt;-&gt;UDN</code> across namespaces<sup>[footnote]</sup> which includes:<ul>
<li>Support for connecting <code>CUDN&lt;-&gt; CUDN</code> (for <code>Admin</code> role only)</li>
<li>Support for connecting <code>CUDN&lt;-&gt;UDN</code> (for <code>Admin</code> role only)</li>
<li>Support for connecting <code>UDN&lt;-&gt;UDN</code> (for <code>Admin</code> role only)</li>
</ul>
</li>
<li>Support for connecting <code>Layer3&lt;-&gt;Layer3</code>, <code>Layer2&lt;-&gt;Layer2</code> and
    <code>Layer3&lt;-&gt;Layer2</code> type networks.</li>
<li>Support for only <code>role:Primary</code> type CUDN, and UDN connections.</li>
<li>Support for pods, services (clusterIPs only since expectation today is
  that NodePorts and LoadBalancer type services are already exposed
  externally and hence reachable across UDNs) and network policies across
  the connected UDNs and CUDNs.</li>
<li>Ensure the proposed API is expandable for also connecting and
  disconnecting UDNs or CUDNs across clusters in the future if need be.</li>
</ul>
<p>[footnote] Food for thought: Currently, there is no need to consider
connecting UDNs within the same namespace since there is no support for
more than 1 primary-UDN in a namespace and each pod would have
connection to its primary and secondary UDNs in its namespace.
However there are use cases for connecting secondary UDNs within a namespace
to consider in the future. There is also a future enhancement on
<a href="https://github.com/ovn-kubernetes/ovn-kubernetes/pull/5255">multiple primary UDNs</a> which if accepted can automatically leverage
the work happening in this enhancement.</p>
<h2 id="future-goals">Future Goals<a class="headerlink" href="#future-goals" title="Permanent link">&para;</a></h2>
<ul>
<li>[Tenant usecase] Connecting and disconnecting UDNs owned by the
  same tenant in same namespace or across different namespaces they
  own, in a self-serve fashion without any admin intervention. A tenant
  should be able to connnect the secondary networks that belong to them.
  This would most likely be a namespace-scoped API.</li>
<li>Tenants being able to request for interconnecting their networks
  with other tenants.<ul>
<li>We need to understand exact use cases for why we need tenants to
  initiate connection requests with other tenants. How will a tenant
  know other tenants that exist on the cluster? In cases like finance
  tenant wanting to use IT tenant's services, they could open a ticket
  to the admin to make that happen.</li>
<li>Regardless, the tenant API might need more RBAC considerations if we
  get such use cases</li>
<li>One other idea is to re-use the same peering semantics that
  network policies API uses where both the CRs across both the tenant
  namespaces would need to select each other to be permitted
  connectivity</li>
</ul>
</li>
<li>Admins being able to connect <code>role:Secondary</code> UDNs and CUDNs. The
  reason why this is a future goal is because of the following reasons:<ul>
<li>For UDNs, given <code>SecondaryUserDefinedNetworkSelector</code> uses a
  combination of namespace selector and network selector, a tenant could
  change the labels on the UDN thereby causing security issues. Hence
  this type of selector support will come later where we might want to
  add a well-known label to be able to leverage selectors.</li>
<li>The secondary networks don't have the same level of topology parity
  as primary networks today. So there is no support for transit router
  or egress gateway today in <code>Layer2</code> secondary networks. Hence we would
  need to add the transit router to the secondary network <code>Layer2</code>
  topology as well which can come in the future. <code>Layer3</code> networks don't
  have the same issue as the required topology parity exists but given
  we'd need that change for <code>Layer2</code> might as well do the full secondary
  networks connect support in future.</li>
</ul>
</li>
<li>Connecting two UDNs with overlapping subnets won't be supported in the first
  phase. This is a valid use case scenario but harder to implement.</li>
</ul>
<h2 id="non-goals">Non-Goals<a class="headerlink" href="#non-goals" title="Permanent link">&para;</a></h2>
<ul>
<li>Support for selecting NADs directly. Since UDNs is the future, new
  features should not be added on NADs.</li>
<li>Support for this feature in non-interconnect architecture is out of scope
  since we plan to deprecate non-interconnect mode soon.</li>
<li>Support for <code>localnet</code> type network connections is out of scope.</li>
<li><code>localnet</code> type networks can be connected together using bridges
    already</li>
<li><code>localnet</code>&lt;-&gt;<code>layer2</code> or <code>localnet</code>&lt;-&gt;<code>layer3</code> will not be covered here.</li>
<li>Supporting Live Migration and PersistentIPs across connected UDNs.</li>
<li>Connecting and disconnecting UDNs and CUDNs across two clusters
  aka inter-cluster-udn-connectivity for admins (can be done as day0 or
  day2). The plan is to be able to do this using EVPN protocol. See
  enhancement <a href="https://github.com/ovn-kubernetes/ovn-kubernetes/pull/5255">on EVPN</a> to see how it is planned to be leveraged as the
  mode to connect different UDNs across clusters. But regardless, the API
  bits around how to request connectivity needs more fleshing and EVPN's
  primary use case is not about connecting UDNs across clusters.</li>
</ul>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>OVN-Kubernetes supports two types of user-defined networks for workload
isolation:</p>
<ul>
<li>
<p><strong>UserDefinedNetworks (UDNs)</strong>: Namespace-scoped networks that tenants can
  create to isolate workloads within a namespace.</p>
</li>
<li>
<p><strong>ClusterUserDefinedNetworks (CUDNs)</strong>: Cluster-scoped networks that admins
  can use to connect multiple namespaces as part of the same isolated network.</p>
</li>
</ul>
<p>These networks can be configured with different roles:</p>
<ul>
<li>
<p><strong><code>role:Primary</code></strong>: The network becomes the primary network for workloads.
  Workloads attached to a primary UDN/CUDN cannot communicate with workloads
  on other UDNs/CUDNs or the default network.</p>
</li>
<li>
<p><strong><code>role:Secondary</code></strong>: Enables multihoming scenarios, allowing pods to be
  attached to multiple networks simultaneously.</p>
</li>
</ul>
<p>Currently, workloads on different (C)UDNs are completely isolated from each
other. However, there are scenarios where partial or full connectivity between
microservices segmented across different (C)UDNs is desirable (see use cases
section).</p>
<p>This OKEP defines how to implement connectivity between two or more (C)UDNs
within a single cluster. The following sections outline the design assumptions
and implementation details.</p>
<h3 id="symmetric-nature-of-udn-connectivity">Symmetric nature of UDN Connectivity<a class="headerlink" href="#symmetric-nature-of-udn-connectivity" title="Permanent link">&para;</a></h3>
<p>If UDN-A is connected to UDN-B then that means UDN-B is connected to
UDN-A. When connecting those networks together it assumes bi-directional
relationship.</p>
<h3 id="non-transitive-nature-of-udn-connectivity">Non-Transitive nature of UDN Connectivity<a class="headerlink" href="#non-transitive-nature-of-udn-connectivity" title="Permanent link">&para;</a></h3>
<p>If UDN-A and UDN-B are connected together and UDN-B and UDN-C are
connected together, that does not mean UDN-A is connected to UDN-C.
Reasoning is we cannot assume something indirectly - It's always best to
let the user express what they'd like to see connected.</p>
<h2 id="user-storiesuse-cases">User-Stories/Use-Cases<a class="headerlink" href="#user-storiesuse-cases" title="Permanent link">&para;</a></h2>
<h3 id="story-1-allowing-network-expansion-for-a-tenant">Story 1: Allowing network expansion for a tenant<a class="headerlink" href="#story-1-allowing-network-expansion-for-a-tenant" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I want</strong> to connect my newly created UDN-New
with an existing UDN-Old <strong>so that</strong> they can communicate with each other
as if being part of the same network.</p>
<p>Example: Existing (C)UDN has full occupancy of its address-space and
we dont allow CIDR expansion or mutation of UDN Spec today.</p>
<p>The admin created UDN-Old with a defined subnet CIDR range which gets
exhausted on a 500th day, now the admin cannot mutate UDN-Old to change
or expand its subnet CIDR range. Admin creates a new UDN-New (could be
in a totally different cluster) and now wants to interconnect them
together.</p>
<p><img alt="user-story-1" src="../images/user-story-1.png" /></p>
<h3 id="story-2-allowing-connectivity-between-two-tenants-through-exposed-clusterip-services">Story 2: Allowing connectivity between two tenants through exposed clusterIP services<a class="headerlink" href="#story-2-allowing-connectivity-between-two-tenants-through-exposed-clusterip-services" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I want</strong> to allow tenant-Green to be able to
access the clusterIP microservice exposed by tenant-Blue without direct
access to workloads behind the service.</p>
<p>Example: When separate services owned by different teams need to
communicate via APIs like frontend needing to access database through
the backend service.</p>
<p>The admin created UDN-Blue and UDN-Green that were isolated initially
but now wants to allow partial inter-tenant communication. Say data
produced by microservice blue needs to be consumed by microservice
green to do its task.</p>
<p><img alt="user-story-2" src="../images/user-story-2.png" /></p>
<p>When the two networks have overlapping subnets, using service clusterIP
as a way to allow communication is valid use case.</p>
<h3 id="story-3-allowing-connectivity-between-two-networks-with-overlapping-subnets-through-exposed-clusterip-services">Story 3: Allowing connectivity between two networks with overlapping subnets through exposed clusterIP services<a class="headerlink" href="#story-3-allowing-connectivity-between-two-networks-with-overlapping-subnets-through-exposed-clusterip-services" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I want</strong> to allow tenant-Green to be able to
access the clusterIP microservice exposed by tenant-Blue even though
tenant-Green and tenant-Blue have overlapping pod subnets.</p>
<p>Example: IPAddress Management is hard. It is not possible to predict the
future of how all applications will communicate with one another. There is
a chance app-type-green and app-type-blue got the same pod subnets and
now they need to talk to each other. While allowing direct connection of
the two overlapping pod subnet networks is hard, a middleground is to use
clusterIPs to communicate.</p>
<h3 id="story-4-merging-two-tenants-maybe-even-temporarily">Story 4: Merging two tenants (maybe even temporarily)<a class="headerlink" href="#story-4-merging-two-tenants-maybe-even-temporarily" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I want</strong> to now connect my existing UDN-Blue
and UDN-Green <strong>so that</strong> they can communicate with each other as if being
part of the same network.</p>
<p>Example: The admin created UDN-Blue and UDN-Green that were isolated
initially but now wants to treat them as being part of the same network.
Pods cannot be rewired given they are part of two different UDNs. Say
when different teams within the same organization operate as separate
tenants but collaborate on a project requiring unrestricted communication
for a period of time and then want to disconnect from each other later.</p>
<h3 id="story-5-same-udn-across-multiple-clusters-must-be-connected-by-default">Story 5: Same UDN across multiple clusters must be connected by default<a class="headerlink" href="#story-5-same-udn-across-multiple-clusters-must-be-connected-by-default" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I want</strong> to connect my workloads which are
part of the same UDN but are in different clusters. </p>
<p>Example: The user has split their workloads into multiple clusters
thereby the same UDN could be fragmented across different clusters. These
pods should be able to communicate with each like it would be if they were
on the same cluster but be isolated from other workloads.</p>
<p>NOTE: Cross cluster UDN connecting is not targeted in this OKEP, but is
covered here since connecting UDNs within the cluster is the first step
here.</p>
<h3 id="story-6-connecting-mixed-type-networks-together-layer2-network-workloads-with-layer3-primarydefault-network">Story 6: Connecting mixed type networks together (Layer2 Network workloads with Layer3 Primary/Default Network)<a class="headerlink" href="#story-6-connecting-mixed-type-networks-together-layer2-network-workloads-with-layer3-primarydefault-network" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I manage</strong> isolated tenants (a bunch of
interconnected pods) and share them with my users. Every tenant has its
own Primary Layer3 UDN to emulate its own cluster network, but isolate
it from the other tenants. Northbound/internet traffic from my tenants
is always flowing through additional gateways that I manage. Gateways
require HA support, which is done using OVN virtual Port type, which is
only supported when all parent ports are located on the same switch,
hence the UDN used by the Gateways is Layer2 (Primary).</p>
<p>To make tenants' traffic flow through the gateways, I need to
interconnect Primary Layer3 network with Primary Layer2 network. Here is
a diagram illustrating this ask:</p>
<p><img alt="user-story-3" src="../images/user-story-3.png" /></p>
<h3 id="story-7-migration-of-connected-tenant-workloads-from-other-platforms-like-nsx-into-ovn-kubernetes">Story 7: Migration of connected tenant workloads from other platforms like NSX into OVN-Kubernetes<a class="headerlink" href="#story-7-migration-of-connected-tenant-workloads-from-other-platforms-like-nsx-into-ovn-kubernetes" title="Permanent link">&para;</a></h3>
<p><strong>As a cluster admin</strong>, <strong>I manage</strong> isolated tenants on my native NSX
platform where they are already seggregated into segments using networks.
Some of these segments are connected through vRouter for mutual access.
I want to migrate such workloads into OVN-Kubernetes platform by
leveraging user defined networks. I would need connecting UDNs feature
to replicate that same workload architecture. The alternative of placing
those workloads into same UDN and using network policies will not work
because it is significant architectural change we would need to mandate
on each tenant since tenant own their networks.</p>
<p>Example: Tenant-frontend has access to Tenant-backend's databaseAPI
workloads on NSX through vRouter, I want to migrate both these tenants
into OVN-Kubernetes platform keeping that architecture intact.</p>
<p><img alt="user-story-4" src="../images/user-story-4.png" /></p>
<h3 id="story-8-future-use-case-tenant-self-connection-without-admin-intervention">Story 8: [Future Use Case] Tenant self-connection without admin intervention<a class="headerlink" href="#story-8-future-use-case-tenant-self-connection-without-admin-intervention" title="Permanent link">&para;</a></h3>
<p><strong>As a tenant owner</strong>, <strong>I want</strong> to connect my workloads which are
part of two different namespaces (networks) in the same cluster with no
admin intervention.</p>
<p>Example: If the same tenant owns microservices across 5 namespaces that
are 5 different networks, there should be provision for this tenant to
connect their networks together without the requirement for an admin to
intervene. The reason could be the same as the above admin user stories
but this story captures the tenant intent with no admin intervention</p>
<h2 id="proposed-solution">Proposed Solution<a class="headerlink" href="#proposed-solution" title="Permanent link">&para;</a></h2>
<p>This section tries to answer: How can an admin declare two (C)UDNs to
be connected?</p>
<h3 id="config-for-enabling-the-feature">Config for enabling the feature<a class="headerlink" href="#config-for-enabling-the-feature" title="Permanent link">&para;</a></h3>
<p>The whole feature will be behind a config flag called
<code>--enable-network-connect</code> which has to be set to true to get this
feature.</p>
<h3 id="api-details">API Details<a class="headerlink" href="#api-details" title="Permanent link">&para;</a></h3>
<p>This enhancement proposes a new CRD to allow admins to request multiple
networks to be connected together.</p>
<p><code>ClusterNetworkConnect</code> CR will be cluster-scoped resource and admin-only
API that will allow admins to select multiple different networks that
need to be connected together. It will also allow specifying what level
of connectivity is expected. See the API definitions for more details.</p>
<p>Admins can create a <code>ClusterNetworkConnect</code> CR which signals the
controller to connect the topologies of the UDNs selected by this CR.</p>
<p>Sample YAML:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.ovn.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterNetworkConnect</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">colored-enterprise</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">networkSelectors</span><span class="p">:</span><span class="w"> </span><span class="c1"># can match on UDNs and/or CUDNs</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">networkSelectionType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterUserDefinedNetworks</span>
<span class="w">      </span><span class="nt">clusterUserDefinedNetworkSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">networkSelector</span><span class="p">:</span>
<span class="w">          </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/metadata.name</span>
<span class="w">            </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">            </span><span class="nt">values</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue-network</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green-network</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">networkSelectionType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PrimaryUserDefinedNetworks</span>
<span class="w">      </span><span class="nt">primaryUserDefinedNetworkSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">          </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/metadata.name</span>
<span class="w">            </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">            </span><span class="nt">values</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yellow</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">red</span>
<span class="w">  </span><span class="nt">connectSubnets</span><span class="p">:</span><span class="w"> </span><span class="c1"># can have at most 1 CIDR for each family type</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.0.0/16&quot;</span><span class="w">  </span><span class="c1"># 65K total IPs</span>
<span class="w">    </span><span class="nt">networkPrefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span><span class="w"> </span><span class="c1"># 255 IPs per layer3 network = ~100 possible nodes in your cluster</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fd01::/64&quot;</span>
<span class="w">    </span><span class="nt">networkPrefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">96</span>
<span class="w">  </span><span class="nt">connectivity</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PodNetwork</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIPServiceNetwork</span>
</code></pre></div>
* <code>connectivity</code> field will ensure we can add support for enabling
  more types of features for the connected UDNs granularly in the future.
  At least one of these options must be set and validations will be added
  for which combinations of these options could/should be set together
* If <code>PodNetwork</code> is enabled then admin is asking for full
  pod2pod connectivity across UDNs
* If <code>ClusterIPServiceNetwork</code> is enabled then admin is asking for
  clusterIPs to be reachable across UDNs.
    * If this flag is set but <code>PodNetwork</code> is not set, then
      it means users only want partial connectivity through services and
      not full mesh pod connectivity.
* <code>connectSubnets</code> field is used to take a configurable subnet from the end
  user that will be used to connect the different networks together. The
  slice needs to be big enough to accommodate an IP per network per node
  for layer3 network connectivity. So if there are M nodes in your cluster
  and N_L3 networks you should have 2*(N_L3M) IPs for allocation in this slice.
  The <code>networkPrefix</code> contains the prefix length allocated for each
  connected layer3 network. From this pool each node get's a <code>/31</code> or <code>/127</code> point to
  point network for actual topology connectivity.
  To connect layer2 networks we don't need per node-network slices, we just
  need one <code>/31</code> or <code>127</code> slice per network.
  ConnectSubnets value is expected to be configured uniquely across multiple <code>ClusterNetworkConnect</code>
  CRs that select the same network i.e. If a given network is selected as part
  of more than 1 ClusterNetworkConnect API, each of those ClusterNetworkConnect
  APIs must have a unique connect subnet. If a user accidentally configures overlapping values,
  we must have a status check to block and report this in the status. See
  status validation section for more details.
  ConnectSubnets field cannot be mutated to keep things simple in the first
  iteration/implementation of this enhancement. Can be revisited in future.</p>
<h4 id="api-field-details-and-cel-validations">API field details and CEL Validations<a class="headerlink" href="#api-field-details-and-cel-validations" title="Permanent link">&para;</a></h4>
<p>API fields are described in detail below along with field validations:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ClusterNetworkConnect enables connecting multiple User Defined Networks</span>
<span class="c1">// or Cluster User Defined Networks together.</span>
<span class="c1">//</span>
<span class="c1">// +genclient</span>
<span class="c1">// +genclient:nonNamespaced</span>
<span class="c1">// +k8s:openapi-gen=true</span>
<span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="c1">// +kubebuilder:resource:path=clusternetworkconnects,scope=Cluster,shortName=cnc,singular=clusternetworkconnect</span>
<span class="c1">// +kubebuilder:object:root=true</span>
<span class="c1">// +kubebuilder:subresource:status</span>
<span class="c1">// +kubebuilder:printcolumn:name=&quot;Age&quot;,type=&quot;date&quot;,JSONPath=&quot;.metadata.creationTimestamp&quot;</span>
<span class="c1">// +kubebuilder:printcolumn:name=&quot;Status&quot;,type=string,JSONPath=&quot;.status.status&quot;</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterNetworkConnect</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span><span class="w">   </span><span class="s">`json:&quot;,inline&quot;`</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="w"> </span><span class="s">`json:&quot;metadata,omitempty&quot;`</span>

<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="nx">Spec</span><span class="w"> </span><span class="nx">ClusterNetworkConnectSpec</span><span class="w"> </span><span class="s">`json:&quot;spec&quot;`</span>

<span class="w">    </span><span class="c1">// +optional</span>
<span class="w">    </span><span class="nx">Status</span><span class="w"> </span><span class="nx">ClusterNetworkConnectStatus</span><span class="w"> </span><span class="s">`json:&quot;status,omitempty&quot;`</span>
<span class="p">}</span>

<span class="c1">// ClusterNetworkConnectSpec defines the desired state of ClusterNetworkConnect.</span>
<span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;!self.networkSelectors.exists(i, i.networkSelectionType != &#39;ClusterUserDefinedNetworks&#39; &amp;&amp; i.networkSelectionType != &#39;PrimaryUserDefinedNetworks&#39;)&quot;,message=&quot;Only ClusterUserDefinedNetworks or PrimaryUserDefinedNetworks can be selected&quot;</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterNetworkConnectSpec</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// networkSelectors selects the networks to be connected together.</span>
<span class="w">    </span><span class="c1">// This can match User Defined Networks (UDNs) and/or Cluster User Defined Networks (CUDNs).</span>
<span class="w">    </span><span class="c1">// Only ClusterUserDefinedNetworkSelector and PrimaryUserDefinedNetworkSelector can be selected.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="nx">NetworkSelectors</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">NetworkSelectors</span><span class="w"> </span><span class="s">`json:&quot;networkSelectors&quot;`</span>

<span class="w">    </span><span class="c1">// connectSubnets specifies the subnets used for interconnecting the selected networks.</span>
<span class="w">    </span><span class="c1">// This creates a shared subnet space that connected networks can use to communicate.</span>
<span class="w">    </span><span class="c1">// Can have at most 1 CIDR for each IP family (IPv4 and IPv6).</span>
<span class="w">    </span><span class="c1">// Must not overlap with:</span>
<span class="w">    </span><span class="c1">//  any of the pod subnets used by the selected networks.</span>
<span class="w">    </span><span class="c1">//  any of the transit subnets used by the selected networks.</span>
<span class="w">    </span><span class="c1">//  any of the service CIDR range used in the cluster.</span>
<span class="w">    </span><span class="c1">//  any of the join subnet of the selected networks to be connected.</span>
<span class="w">    </span><span class="c1">//  any of the masquerade subnet range used in the cluster.</span>
<span class="w">    </span><span class="c1">//  any of the node subnets for choosen by the platform.</span>
<span class="w">    </span><span class="c1">//  any of other connect subnets for other ClusterNetworkConnects that might be selecting same networks.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// Does not have a default value for the above reason so</span>
<span class="w">    </span><span class="c1">// that user takes care in setting non-overlapping subnets.</span>
<span class="w">    </span><span class="c1">// Cannot be mutated once set.</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:MinItems=1</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:MaxItems=2</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;self == oldSelf&quot;, message=&quot;connectSubnets is immutable&quot;</span>
<span class="w">    </span><span class="c1">// +required</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;size(self) != 2 || !isCIDR(self[0].cidr) || !isCIDR(self[1].cidr) || cidr(self[0].cidr).ip().family() != cidr(self[1].cidr).ip().family()&quot;, message=&quot;When 2 CIDRs are set, they must be from different IP families&quot;</span>
<span class="w">    </span><span class="nx">ConnectSubnets</span><span class="w"> </span><span class="p">[]</span><span class="nx">ConnectSubnet</span><span class="w"> </span><span class="s">`json:&quot;connectSubnets&quot;`</span>

<span class="w">    </span><span class="c1">// connectivity specifies which connectivity types should be enabled for the connected networks.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Required</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:MinItems=1</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:MaxItems=2</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;self.all(x, self.exists_one(y, x == y))&quot;,message=&quot;connectivity cannot contain duplicate values&quot;</span>
<span class="w">    </span><span class="nx">connectivity</span><span class="w"> </span><span class="p">[]</span><span class="nx">ConnectivityType</span><span class="w"> </span><span class="s">`json:&quot;connectivity&quot;`</span>
<span class="p">}</span>

<span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;isCIDR(self) &amp;&amp; cidr(self) == cidr(self).masked()&quot;, message=&quot;CIDR must be a valid network address&quot;</span>
<span class="c1">// +kubebuilder:validation:MaxLength=43</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">CIDR</span><span class="w"> </span><span class="kt">string</span>

<span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;!has(self.networkPrefix) || !isCIDR(self.cidr) || self.networkPrefix &gt; cidr(self.cidr).prefixLength()&quot;, message=&quot;networkPrefix must be smaller than CIDR subnet&quot;</span>
<span class="c1">// +kubebuilder:validation:XValidation:rule=&quot;!has(self.networkPrefix) || !isCIDR(self.cidr) || (cidr(self.cidr).ip().family() != 4 || self.networkPrefix &lt; 32)&quot;, message=&quot;networkPrefix must &lt; 32 for ipv4 CIDR&quot;</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConnectSubnet</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// CIDR specifies ConnectSubnet, which is split into smaller subnets for every connected network.</span>
<span class="w">  </span><span class="c1">// This CIDR should be containing 2*((Number of L3 networks*Max Number of Nodes)+Number of L2 networks) IPs.</span>
<span class="w">  </span><span class="c1">// Example: cidr= &quot;192.168.0.0/16&quot;, networkPrefix= 24 means that you can connect 256 Layer3 networks OR</span>
<span class="w">  </span><span class="c1">// 255 Layer3 networks and 128 Layer2 networks</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// CIDR also restricts the maximum number of networks that can be connected together</span>
<span class="w">  </span><span class="c1">// based on what CIDR range is picked. So choosing a large enough CIDR for future use cases</span>
<span class="w">  </span><span class="c1">// is important.</span>
<span class="w">  </span><span class="c1">// +required</span>
<span class="w">  </span><span class="nx">CIDR</span><span class="w"> </span><span class="nx">CIDR</span><span class="w"> </span><span class="s">`json:&quot;cidr&quot;`</span>

<span class="w">  </span><span class="c1">// networkPrefix specifies the prefix length for every connected network.</span>
<span class="w">  </span><span class="c1">// This prefix length should be equal to or longer than the length of the CIDR prefix.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// For example, if the CIDR is 10.0.0.0/8 and the networkPrefix is 24,</span>
<span class="w">  </span><span class="c1">// then the connect subnet for each connected layer3 network will be 10.0.0.0/24, 10.0.1.0/24, 10.0.2.0/24 etc.</span>
<span class="w">  </span><span class="c1">// For each connected layer2 network we will allocate a /networkPrefix range</span>
<span class="w">  </span><span class="c1">// that is then used to allocate /31 and /127 slices for each layer2 network.</span>
<span class="w">  </span><span class="c1">// A good practice is to set this to a value that ensures it contains more</span>
<span class="w">  </span><span class="c1">// than twice the number of maximum nodes planned to be deployed in the cluster</span>
<span class="w">  </span><span class="c1">// and how frequently nodes are created and destroyed.</span>
<span class="w">  </span><span class="c1">// To be safe, better to set this to a value that&#39;s 4 times the maximum nodes planned</span>
<span class="w">  </span><span class="c1">// to be deployed in the cluster.</span>
<span class="w">  </span><span class="c1">// Example - required values;</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 10 nodes, minimum required networkPrefix is /27 (20+ IPs)</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 100 nodes, minimum required networkPrefix is /24 (200+ IPs)</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 1000 nodes, minimum required networkPrefix is /21 (2000+ IPs)</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 5000 nodes, minimum required networkPrefix is /18 (10000+ IPs)</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// However to be safe and in case nodes are created and destroyed at fast rate,</span>
<span class="w">  </span><span class="c1">// set it to 4 times max nodes of the cluster:</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 10 nodes, set the networkPrefix to /26 (40+ IPs)</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 100 nodes, set the networkPrefix to /23 (400+ IPs)</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 1000 nodes, set the networkPrefix to /20 (4000+ IPs)</span>
<span class="w">  </span><span class="c1">// if you plan to deploy 5000 nodes, set the networkPrefix to /17 (20000+ IPs)</span>
<span class="w">  </span><span class="c1">// This field restricts the maximum number of nodes that can be deployed in the cluster</span>
<span class="w">  </span><span class="c1">// and hence its good to plan this value carefully along with the CIDR.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// +kubebuilder:validation:Minimum=1</span>
<span class="w">  </span><span class="c1">// +kubebuilder:validation:Maximum=127</span>
<span class="w">  </span><span class="c1">// +required</span>
<span class="w">  </span><span class="nx">NetworkPrefix</span><span class="w"> </span><span class="kt">int32</span><span class="w"> </span><span class="s">`json:&quot;networkPrefix&quot;`</span>
<span class="p">}</span>

<span class="c1">// ConnectivityType represents the different connectivity types that can be enabled for connected networks.</span>
<span class="c1">// +kubebuilder:validation:Enum=PodNetwork;ClusterIPServiceNetwork</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ConnectivityType</span><span class="w"> </span><span class="kt">string</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">// PodNetwork enables direct pod-to-pod communication across connected networks.</span>
<span class="w">    </span><span class="nx">PodNetwork</span><span class="w"> </span><span class="nx">ConnectivityType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;PodNetwork&quot;</span>

<span class="w">    </span><span class="c1">// ClusterIPServiceNetwork enables ClusterIP service access across connected networks.</span>
<span class="w">    </span><span class="nx">ClusterIPServiceNetwork</span><span class="w"> </span><span class="nx">ConnectivityType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ClusterIPServiceNetwork&quot;</span>
<span class="p">)</span>

<span class="c1">// StatusType represents the status of a ClusterNetworkConnect.</span>
<span class="c1">// +kubebuilder:validation:Enum=Success;Failure</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">StatusType</span><span class="w"> </span><span class="kt">string</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">// Success indicates that the ClusterNetworkConnect has been successfully applied.</span>
<span class="w">    </span><span class="nx">Success</span><span class="w"> </span><span class="nx">StatusType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>

<span class="w">    </span><span class="c1">// Failure indicates that the ClusterNetworkConnect has failed to be applied.</span>
<span class="w">    </span><span class="nx">Failure</span><span class="w"> </span><span class="nx">StatusType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="p">)</span>

<span class="c1">// ClusterNetworkConnectStatus defines the observed state of ClusterNetworkConnect.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterNetworkConnectStatus</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// status is a concise indication of whether the ClusterNetworkConnect</span>
<span class="w">    </span><span class="c1">// resource is applied with success.</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Optional</span>
<span class="w">    </span><span class="nx">Status</span><span class="w"> </span><span class="nx">StatusType</span><span class="w"> </span><span class="s">`json:&quot;status,omitempty&quot;`</span>

<span class="w">    </span><span class="c1">// conditions is an array of condition objects indicating details about</span>
<span class="w">    </span><span class="c1">// status of ClusterNetworkConnect object.</span>
<span class="w">    </span><span class="c1">// +patchMergeKey=type</span>
<span class="w">    </span><span class="c1">// +patchStrategy=merge</span>
<span class="w">    </span><span class="c1">// +listType=map</span>
<span class="w">    </span><span class="c1">// +listMapKey=type</span>
<span class="w">    </span><span class="nx">Conditions</span><span class="w"> </span><span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="w"> </span><span class="s">`json:&quot;conditions,omitempty&quot;`</span>
<span class="p">}</span>

<span class="c1">// ClusterNetworkConnectList contains a list of ClusterNetworkConnect.</span>
<span class="c1">// +kubebuilder:object:root=true</span>
<span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterNetworkConnectList</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span><span class="w"> </span><span class="s">`json:&quot;,inline&quot;`</span>
<span class="w">    </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListMeta</span><span class="w"> </span><span class="s">`json:&quot;metadata,omitempty&quot;`</span>
<span class="w">    </span><span class="nx">Items</span><span class="w">           </span><span class="p">[]</span><span class="nx">ClusterNetworkConnect</span><span class="w"> </span><span class="s">`json:&quot;items&quot;`</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="validation-field-checks">Validation Field Checks<a class="headerlink" href="#validation-field-checks" title="Permanent link">&para;</a></h4>
<p>In the implementation, after parsing the <code>ClusterNetworkConnect</code>
object, we must ensure the following:</p>
<ul>
<li><code>connectSubnets</code> must not conflict with:
  1) pod subnets of the selected networks to be connected
  2) transit subnets of the selected networks to be connected
  3) service CIDR range used in the cluster
  4) join subnet of the selected networks to be connected
  5) masquerade subnet range used in the cluster
  6) node subnets for choosen by the platform. This is the responsibility
     of the user and we won't provide validation for node subnets since
     fetching that value could vary from platform to platform. We will
     cover this in the docs.
  If it does, we need to provide validation and feedback to the
  end user for the conflict. </li>
<li>Since connection of overlapping pod subnet networks is not
  allowed in first phase, we must detect the collision and report
  the error back to the user via the status</li>
<li>Expectation is for users to initiate the connection of networks of same
  family types together. If a singlestack IPV6 UDN is tried to be connected
  to singlestack IPV4 UDN, then we will have to validate this as a misconfiguration
  and have a status error for this.</li>
</ul>
<h4 id="valid-ways-of-connectingselectingdisconnecting-udns">Valid ways of Connecting/Selecting/Disconnecting UDNs<a class="headerlink" href="#valid-ways-of-connectingselectingdisconnecting-udns" title="Permanent link">&para;</a></h4>
<ul>
<li>A network could be selected as part of more than one network connnect, so
  what is the expectation when two Connect APIs are designed that select the
  exact same set of networks? How do we control validation of such scenarios?
  Example, ClusterNetworkConnect-A selects blue and green networks and
  ClusterNetworkConnect-B selects blue and red networks:<ul>
<li>In such scenarios the same network's router is going to be connected to
  more than one <code>connect-router</code>. So blue network will be connected
  to both <code>connect-router-A</code> and <code>connect-router-B</code>.</li>
<li>However given non-transitive relation and absence of connecting routes,
  indirect connection of green and red will not happen.</li>
<li>We must add validation in code to ensure if more than 1
  ClusterNetworkConnect API selects the same network, then they must
  have non-overlapping <code>connectSubnets</code> field configured. If there is a
  conflict, we must emit an event on the connectAPI and fail to create
  the plumbing for the subsequent case. OVN does not handle blocking
  the creation of two ports on the same router with same subnets.
  So if that happens, it will cause wrong routing and hence OVN-Kubernetes
  must detect this conflict.</li>
</ul>
</li>
<li>A ClusterNetworkConnect could be selecting a subset of networks already selected by
  another ClusterNetworkConnect API. What is the expectation in this case?
  Example,
  ClusterNetworkConnect-A selects blue, green, red and yellow networks and
  ClusterNetworkConnect-B selects blue and green networks.<ul>
<li>This is going to be considered a user-configuration error oversight.
  This same issue also exists for other APIs like <code>RouteAdvertisement</code>
  (wonder what we do there?).</li>
<li>We expect the rules to be additively implemented but in this case, we
  won't optimize for anything since its a hard problem to solve. We will
  end up create duplicate connect networks unnecessarily and it will be
  an ECMP routing situation on which connect network will be used to
  reach the other side.</li>
<li>We will not provide any validation around selectors across all connect
  APIs to rule out overlap except we will ensure the <code>connectSubnets</code> is
  non-overlapping across all connectAPIs that select a given network
  which is same as the first case.</li>
</ul>
</li>
<li>Selecting a network can be done as a day0 or day2 operation. So label changes
  to existing networks, new networks added and deleted need to be watched
  in order to connect and disconnect networks on the fly based on user
  configuration changes.</li>
</ul>
<h4 id="statusconditions">StatusConditions<a class="headerlink" href="#statusconditions" title="Permanent link">&para;</a></h4>
<p>The <code>ClusterNetworkConnect</code> status will include a <code>status</code> field
with a concise indication and a <code>conditions</code> array with detailed
condition objects. The controller will update these conditions based
on validation results.</p>
<p><strong>Condition Types</strong></p>
<ul>
<li>The <code>Accepted</code> type condition will be done from the cluster-manager
  which indicates whether the validation checks passed.</li>
<li>The <code>Ready-In-Zone-&lt;nodename&gt;</code> type condition will be done from
  each node's ovnkube-controller which indicates if all the corresponding
  OVN objects were created correctly.</li>
<li>Based on whether <code>status</code> of the above two types of conditions is
  <code>True</code> or <code>False</code>, the final string <code>status</code> will be marked <code>Success</code> or
  <code>Failure</code></li>
</ul>
<p><strong>Valid Scenario</strong></p>
<p>When a <code>ClusterNetworkConnect</code> resource is successfully applied,
the following conditions indicate healthy states:</p>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Success&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ValidationSucceeded&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;All</span><span class="nv"> </span><span class="s">validation</span><span class="nv"> </span><span class="s">checks</span><span class="nv"> </span><span class="s">passed</span><span class="nv"> </span><span class="s">successfully&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T09:59:00Z&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Ready-In-Zone-ovn-worker&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OVNSetupSucceeded&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Connect</span><span class="nv"> </span><span class="s">router</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">all</span><span class="nv"> </span><span class="s">ports</span><span class="nv"> </span><span class="s">created</span><span class="nv"> </span><span class="s">successfully&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Ready-In-Zone-ovn-worker2&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OVNSetupSucceeded&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Connect</span><span class="nv"> </span><span class="s">router</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">all</span><span class="nv"> </span><span class="s">ports</span><span class="nv"> </span><span class="s">created</span><span class="nv"> </span><span class="s">successfully&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<p><strong>Invalid Scenarios</strong></p>
<p>When validation fails or errors occur, the following error conditions will be reported:</p>
<p><strong>Cluster-Manager Validation Errors:</strong>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ConnectSubnetExhausted&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Insufficient</span><span class="nv"> </span><span class="s">IP</span><span class="nv"> </span><span class="s">addresses</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">subnet</span><span class="nv"> </span><span class="s">192.168.0.0/16.</span>
<span class="w">    </span><span class="s">lastTransitionTime:</span><span class="nv"> </span><span class="s">&quot;</span><span class="l l-Scalar l-Scalar-Plain">2023-10-01T10:00:00Z&quot;</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OverlappingNetworkSubnets&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Cannot</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">networks</span><span class="nv"> </span><span class="s">&#39;blue-network&#39;</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">&#39;green-network&#39;:</span><span class="nv"> </span><span class="s">overlapping</span>
<span class="w">    </span><span class="s">pod</span><span class="nv"> </span><span class="s">subnets</span><span class="nv"> </span><span class="s">10.1.0.0/16</span><span class="nv"> </span><span class="s">detected.&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ConnectSubnetConflict&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Connect</span><span class="nv"> </span><span class="s">subnet</span><span class="nv"> </span><span class="s">192.168.0.0/16</span><span class="nv"> </span><span class="s">conflicts</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">pod</span><span class="nv"> </span><span class="s">subnet</span><span class="nv"> </span><span class="s">192.168.1.0/24</span>
<span class="w">    </span><span class="s">of</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">&#39;blue-network&#39;&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ConnectSubnetOverlap&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Connect</span><span class="nv"> </span><span class="s">subnet</span><span class="nv"> </span><span class="s">192.168.0.0/16</span><span class="nv"> </span><span class="s">overlaps</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">ClusterNetworkConnect</span>
<span class="w">    </span><span class="s">&#39;enterprise-connect&#39;</span><span class="nv"> </span><span class="s">which</span><span class="nv"> </span><span class="s">also</span><span class="nv"> </span><span class="s">selects</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">&#39;blue-network&#39;.</span>
<span class="w">    </span><span class="s">Each</span><span class="nv"> </span><span class="s">ClusterNetworkConnect</span><span class="nv"> </span><span class="s">selecting</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">same</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">non-overlapping</span>
<span class="w">    </span><span class="s">connect</span><span class="nv"> </span><span class="s">subnets&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;IPFamilyMismatch&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Cannot</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">single-stack</span><span class="nv"> </span><span class="s">IPv4</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">&#39;ipv4-network&#39;</span><span class="nv"> </span><span class="s">with</span>
<span class="w">    </span><span class="s">single-stack</span><span class="nv"> </span><span class="s">IPv6</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">&#39;ipv6-network&#39;.</span><span class="nv"> </span><span class="s">Networks</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">same</span><span class="nv"> </span><span class="s">IP</span><span class="nv"> </span><span class="s">family&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;InsufficientNetworks&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Only</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">selected,</span><span class="nv"> </span><span class="s">minimum</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">networks</span><span class="nv"> </span><span class="s">required</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">connection&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;UnsupportedNetworkType&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Network</span><span class="nv"> </span><span class="s">&#39;blue-network&#39;</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">role</span><span class="nv"> </span><span class="s">&#39;Secondary&#39;.</span><span class="nv"> </span><span class="s">Only</span><span class="nv"> </span><span class="s">&#39;Primary&#39;</span><span class="nv"> </span><span class="s">role</span><span class="nv"> </span><span class="s">networks</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">supported&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;UnsupportedNetworkType&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Network</span><span class="nv"> </span><span class="s">&#39;localnet-network&#39;</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">&#39;localnet&#39;.</span><span class="nv"> </span><span class="s">Localnet</span><span class="nv"> </span><span class="s">networks</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">supported&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;UnsupportedNetworkType&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Network</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">feature</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">supported</span><span class="nv"> </span><span class="s">when</span><span class="nv"> </span><span class="s">overlay</span><span class="nv"> </span><span class="s">tunneling</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">disabled&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div>
<p><strong>OVN Setup Failures: (Per Zone)</strong>
<div class="highlight"><pre><span></span><code><span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failure&quot;</span>
<span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Accepted&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ValidationSucceeded&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;All</span><span class="nv"> </span><span class="s">validation</span><span class="nv"> </span><span class="s">checks</span><span class="nv"> </span><span class="s">passed</span><span class="nv"> </span><span class="s">successfully&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T09:59:00Z&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Ready-In-Zone-ovn-worker&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OVNSetupFailed&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">create</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">router</span><span class="nv"> </span><span class="s">ports:</span><span class="nv"> </span><span class="s">tunnel</span><span class="nv"> </span><span class="s">key</span><span class="nv"> </span><span class="s">allocation</span><span class="nv"> </span><span class="s">failed&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Ready-In-Zone-ovn-worker2&quot;</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;False&quot;</span>
<span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OVNSetupFailed&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">routing</span><span class="nv"> </span><span class="s">policies</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">&#39;blue-network&#39;&quot;</span>
<span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-10-01T10:00:00Z&quot;</span>
</code></pre></div></p>
<p><strong>Accepted Condition Reasons (from cluster-manager):</strong></p>
<ul>
<li><strong><code>ValidationSucceeded</code></strong> - All validation checks passed successfully</li>
<li><strong><code>ConnectSubnetExhausted</code></strong> - Not enough IPs in connect subnet for all network-node combinations</li>
<li><strong><code>OverlappingNetworkSubnets</code></strong> - Selected networks have overlapping pod subnets (not supported)</li>
<li><strong><code>ConnectSubnetConflict</code></strong> - Connect subnet conflicts with existing network subnets, service CIDR, etc.</li>
<li><strong><code>ConnectSubnetOverlap</code></strong> - Connect subnet overlaps with another ClusterNetworkConnect selecting the same network</li>
<li><strong><code>IPFamilyMismatch</code></strong> - Attempting to connect networks with different IP families</li>
<li><strong><code>InsufficientNetworks</code></strong> - Less than 2 networks selected for connection</li>
<li><strong><code>UnsupportedNetworkType</code></strong> - Network has unsupported role (Secondary) or type (localnet) or no-overlay mode enabled</li>
</ul>
<p><strong>Ready-In-Zone Condition Reasons (from ovnkube-controller):</strong></p>
<ul>
<li><strong><code>OVNSetupSucceeded</code></strong> - OVN topology setup completed successfully</li>
<li><strong><code>OVNSetupFailed</code></strong> - OVN topology setup failed</li>
</ul>
<p>NOTE: The actual messages and name types may vary in implementation
subject to reviews. These snippets only represent some potential examples.</p>
<h3 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h3>
<p>The implementation details of the feature are covered in various
sub sections below:</p>
<h4 id="network-topology">Network Topology<a class="headerlink" href="#network-topology" title="Permanent link">&para;</a></h4>
<p>This section covers the topology changes that will be introduced to
connect networks together.  NOTE: Besides the finalized
proposal we have below for the topology change, there were other ideas
which were discarded and listed in the alternatives section.</p>
<p><strong>Connecting Layer3 type networks together</strong></p>
<p>The below diagram shows the overlay part of the OVN Topology that
OVN-Kubernetes creates for 3 UDN networks (blue, green and yellow)
across two nodes.</p>
<p><img alt="3-isolated-l3-networks" src="../images/l3-connecting-udns-0.png" /></p>
<p>Let's take a look at how we can connect a blue network, green network
and yellow network at the OVN layer.</p>
<p><strong>Add a new transit router between the ovn_cluster_routers of the
networks</strong></p>
<p>When the <code>ClusterNetworkConnect</code> CR gets created selecting these three
networks, the controller will make the following changes to the topology:
* Create a distributed <code>connect-router-colored-enterprise</code> (basically
  a transit-router type in OVN used for interconnection)
* Connect the <code>connect-router-colored-enterprise</code> to the
  <code>ovn_cluster_router</code>'s of the blue, green and yellow networks on each
  node using peer ports and tunnelkeys. We will have a total of N*M
  links where N is the number of networks and M is the number of nodes.
* The port's will have IPs allocated from within the <code>connectSubnets</code>
  value provided on the CR. For connecting N networks on M nodes we
  would need 2(NM) IPs from the <code>connectSubnets</code>. See the controller
  design section for more details.</p>
<p><img alt="blue-green-yellow-l3-connect-idea" src="../images/l3-connecting-udns-v1.png" /></p>
<p>So in this proposal it will be 1 new transit router per
<code>ClusterNetworkConnect</code> API.
NOTE: Please keep reading to the <strong>Pods</strong> and <strong>Services</strong> sections for
details around routes, policies and other OVN object changes.</p>
<p>In the OVN database of ovn-worker node, this new router looks
like this:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl show connect-router-colored-enterprise</span>
<span class="l l-Scalar l-Scalar-Plain">router bb053a19-99d5-4af8-a8e9-ebcab52908d8 (connect-router-colored-enterprise)</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-blue_blue-network-ovn-control-plane</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:01&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:1&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.0.1/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w w-Error">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-yellow_yellow-network-ovn-control-plane</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:03&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:3&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.2.3/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-green_green-network-ovn-control-plane</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:05&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:5&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.1.5/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-green_green-network-ovn-worker2</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:11&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:11&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.1.17/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-blue_blue-network-ovn-worker</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:07&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:7&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.0.7/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-blue_blue-network-ovn-worker2</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:0d&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:d&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.0.13/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-yellow_yellow-network-ovn-worker2</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:0f&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:f&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.2.15/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-yellow_yellow-network-ovn-worker</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:09&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:9&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.2.9/31&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port colored-enterprise-to-green_green-network-ovn-worker</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:0b&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:b&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.1.11/31&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>The new ports added to the <code>ovn_cluster_router</code>'s of the 3 networks:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl show yellow_yellow.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">router 01e9f2fc-e351-4c7a-a51a-ba5f2b2fb099 (yellow_yellow.network_ovn_cluster_router)</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port yellow_yellow-network-ovn-worker-to-colored-enterprise</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:02:08&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:8&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.2.8/31&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">_uuid               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c78b105c-d2ee-4ba9-bb25-ec94dada0d15</span>
<span class="nt">dhcp_relay          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">enabled             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">external_ids        </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">gateway_chassis     </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ha_chassis_group    </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ipv6_prefix         </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ipv6_ra_configs     </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">mac                 </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:02:08&quot;</span>
<span class="nt">name                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yellow_yellow-network-ovn-worker-to-colored-enterprise</span>
<span class="nt">networks            </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.2.8/31&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">options             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">peer                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">colored-enterprise-to-yellow_yellow-network-ovn-worker --&gt; connects to connect-router</span>
<span class="nt">status              </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl show blue_blue.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">router 13b24c4d-f3c3-4811-98a9-98cc996be0d4 (blue_blue.network_ovn_cluster_router)</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port blue_blue-network-ovn-worker-to-colored-enterprise</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:06&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:6&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.0.6/31&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">_uuid               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24aabdb9-0b37-4332-965d-5d09ae0694a8</span>
<span class="nt">dhcp_relay          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">enabled             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">external_ids        </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">gateway_chassis     </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ha_chassis_group    </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ipv6_prefix         </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ipv6_ra_configs     </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">mac                 </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:00:06&quot;</span>
<span class="nt">name                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue_blue-network-ovn-worker-to-colored-enterprise</span>
<span class="nt">networks            </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.0.6/31&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">options             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">peer                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">colored-enterprise-to-blue_blue-network-ovn-worker --&gt; connects to connect-router</span>
<span class="nt">status              </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl show green_green.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">router 15532710-213f-4bee-8bc1-9d500a6bc5a9 (green_green.network_ovn_cluster_router)</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">port green_green-network-ovn-worker-to-colored-enterprise</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">mac</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:01:0a&quot;</span>
<span class="w">        </span><span class="nt">ipv6-lla</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fe80::858:c0ff:fe80:a&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.1.10/31&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">_uuid               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">99c4bff1-17c9-4d17-826c-c069f2a3cb6b</span>
<span class="nt">dhcp_relay          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">enabled             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">external_ids        </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">gateway_chassis     </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ha_chassis_group    </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ipv6_prefix         </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">ipv6_ra_configs     </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">mac                 </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0a:58:c0:80:01:0a&quot;</span>
<span class="nt">name                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green_green-network-ovn-worker-to-colored-enterprise</span>
<span class="nt">networks            </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;192.168.1.10/31&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">options             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">peer                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">colored-enterprise-to-green_green-network-ovn-worker --&gt; connects to connect-router</span>
<span class="nt">status              </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</code></pre></div>
<p><strong>Connecting Layer2 type networks together</strong></p>
<p>The below diagram shows the overlay part of the OVN Topology that
OVN-Kubernetes creates for 3 UDN networks (blue, green and yellow)
across two nodes. NOTE: The topology representation is that of the new
upcoming Layer2 topology. See enhancement on <a href="https://ovn-kubernetes.io/okeps/okep-5094-layer2-transit-router/">new Layer2 topology</a>
for more details on the new design.</p>
<p><img alt="3-isolated-l2-networks" src="../images/l2-connecting-udns-0.png" /></p>
<p><strong>Add a new transit router between the transit routers of the networks</strong></p>
<p>When the <code>ClusterNetworkConnect</code> CR gets created selecting these three
networks, the controller will make the following changes to the topology:
* Create a distributed <code>connect-router-colored-enterprise</code> (basically a
  transit-router type in OVN used for interconnection). However note that
  for pure layer2 network connections, we don't actually need a transit
  router since there won't be any remote ports we need to create for
  layer2 unlike in case of layer3. When we go from a pure layer2 to mixed
  type connections we will need the remote ports (see the next section).
* Connect the <code>connect-router-colored-enterprise</code> to the <code>transit-router</code>s
  of the blue, green and yellow networks using patch ports and
  tunnelkeys. In case of Layer2, we will have N links where N is the
  number of networks.
* The port's will have IPs allocated from within the <code>connectSubnets</code>
  value provided on the CR. For connecting N networks on M nodes we
  would need 2N IPs from the <code>connectSubnets</code>. See the controller
  design section for more details.</p>
<p><img alt="blue-green-yellow-l2-connect-idea" src="../images/l2-connecting-udns-v1.png" /></p>
<p><strong>Connecting mixed type (layer3 and/or layer2) networks together</strong></p>
<p>The below diagram shows the overlay part of the OVN Topology that OVN-Kubernetes
creates for 3 UDN networks (blue(l3), green(l3) and yellow(l2)) across two
nodes.</p>
<p><img alt="3-isolated-mixed-networks" src="../images/mixed-connecting-udns-0.png" /></p>
<p><strong>Add a new transit router between the ovn_cluster_router's and transit-routers of the networks</strong></p>
<p>When the <code>ClusterNetworkConnect</code> CR gets created selecting these three
networks, the controller will make the following changes to the topology:
* Create a distributed <code>connect-router-colored-enterprise</code> (basically
  a transit-router type in OVN used for interconnection). Remote ports
  will be used only in layer3 type interconnection and not in layer2.
* Connect the <code>connect-router-colored-enterprise</code> to the
  <code>transit-router</code> of the yellow network and <code>ovn_cluster_router</code>'s of the
  blue and green networks on each node using patch ports and tunnelkeys.
  In case of mixed connection type, we will have N_L3M+N_L2 links where
  N_L3 is the number of Layer3 networks and N_L2 is the number of Layer2
  networks
* The port's will have IPs allocated from within the <code>connectSubnets</code>
  value provided on the CR. For connecting N_L3 and N_L2 networks on M nodes
  we would need 2(N_L3M+N_L2) IPs from the <code>connectSubnets</code>. See the
  controller design section for more details.</p>
<p><img alt="blue-green-yellow-mixed-connect-idea" src="../images/mixed-connecting-udns-v1.png" /></p>
<h4 id="pods">Pods<a class="headerlink" href="#pods" title="Permanent link">&para;</a></h4>
<p>In order to ensure pods in different connected networks can talk to
each other we will need to add appropriate routes on the routers.</p>
<ul>
<li>Create policies on each connected network's <code>ovn_cluster_router</code> (L3)
  or <code>transit-router</code> (L2) that steers the traffic towards the other
  networks' subnet to the <code>connect-router</code>.</li>
<li>On the interconect <code>connect-router</code> we will add specific per
  network-node subnet routes that steers the traffic to the correct node.</li>
</ul>
<p><strong>Layer3</strong></p>
<p>These routes will look like this in the L3 blue, green, yellow sample topology:</p>
<ul>
<li>Add logical router policies to <code>blue_blue.network_ovn_cluster_router</code>
  that steers traffic towards the green and yellow UDN's subnet to connect
  router on all nodes</li>
<li>Add logical router policies to <code>green_green.network_ovn_cluster_router</code>
  that steers traffic towards the blue and yellow UDN's subnet to connect
  router on all nodes</li>
<li>Add logical router policies to <code>yellow_yellow.network_ovn_cluster_router</code>
  that steers traffic towards the blue and green UDN's subnet to connect
  router on all nodes</li>
<li>On the <code>connect-router-colored-enterprise</code> add routes to specific
  node subnet slices of the blue, green and yellow ovn_cluster_routers on the
  respective nodes.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list green_green.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-green_green.network_ovn-worker&quot; &amp;&amp; ip4.dst == 103.103.0.0/16         reroute              192.168.0.11</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-green_green.network_ovn-worker&quot; &amp;&amp; ip4.dst == 105.105.0.0/16         reroute              192.168.0.11</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list blue_blue.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-blue_blue.network_ovn-worker&quot; &amp;&amp; ip4.dst == 104.104.0.0/16         reroute               192.168.0.7</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-blue_blue.network_ovn-worker&quot; &amp;&amp; ip4.dst == 105.105.0.0/16         reroute               192.168.0.7</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list yellow_yellow.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-yellow_yellow.network_ovn-worker&quot; &amp;&amp; ip4.dst == 103.103.0.0/16         reroute               192.168.0.9</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-yellow_yellow.network_ovn-worker&quot; &amp;&amp; ip4.dst == 104.104.0.0/16         reroute               192.168.0.9</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-route-list connect-router-colored-enterprise</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain">IPv4 Routes</span>
<span class="l l-Scalar l-Scalar-Plain">Route Table &lt;main&gt;</span><span class="p p-Indicator">:</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.0.0/24              192.168.0.12 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.1.0/24               192.168.0.0 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.2.0/24               192.168.0.6 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.0.0/24               192.168.0.4 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.1.0/24              192.168.0.10 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.2.0/24              192.168.0.16 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">105.105.0.0/24              192.168.0.14 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">105.105.1.0/24               192.168.0.2 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">105.105.2.0/24               192.168.0.8 dst-ip</span>
</code></pre></div>
<p><strong>Layer2</strong></p>
<p>These routes will look like this in the L3 blue, green, yellow sample topology:</p>
<ul>
<li>Add logical router policies to <code>blue_blue.network_transit_router</code>
  that steers traffic towards the green and yellow UDN's subnet to connect
  router on all nodes</li>
<li>Add logical router policies to <code>green_green.network_transit_router</code>
  that steers traffic towards the blue and yellow UDN's subnet to connect
  router on all nodes</li>
<li>Add logical router policies to <code>yellow_yellow.network_transit_router</code>
  that steers traffic towards the blue and green UDN's subnet to connect
  router on all nodes</li>
<li>On the <code>connect-router-colored-enterprise</code> add routes to specific
  node subnet slices of the blue, green and yellow transit_routers. We
  don't need per-node routes like with layer3, since transit router is
  distributed across all nodes and layer2 is a flat network</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list green_green.network_transit_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-green_green.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 103.103.0.0/16         reroute               192.168.0.7</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-green_green.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 105.105.0.0/16         reroute               192.168.0.7</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list blue_blue.network_transit_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-blue_blue.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 104.104.0.0/16         reroute              192.168.0.11</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-blue_blue.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 105.105.0.0/16         reroute              192.168.0.11</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list yellow_yellow.network_transit_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-yellow_yellow.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 103.103.0.0/16         reroute               192.168.0.9</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-yellow_yellow.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 104.104.0.0/16         reroute               192.168.0.9</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-route-list connect-router-colored-enterprise</span>
<span class="l l-Scalar l-Scalar-Plain">IPv4 Routes</span>
<span class="l l-Scalar l-Scalar-Plain">Route Table &lt;main&gt;</span><span class="p p-Indicator">:</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.0.0/16               192.168.0.4 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.0.0/16               192.168.0.0 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">105.105.0.0/16               192.168.0.2 dst-ip</span>
</code></pre></div>
<p><strong>Mixed</strong></p>
<p>These routes will look like this in the mixed blue, green, yellow sample topology:</p>
<ul>
<li>Add logical router policies to <code>blue_blue.network_ovn_cluster_router</code>
  that steers traffic towards the green and yellow UDN's subnet to connect
  router on all nodes</li>
<li>Add logical router policies to <code>green_green.network_ovn_cluster_router</code>
  that steers traffic towards the blue and yellow UDN's subnet to connect
  router on all nodes</li>
<li>Add logical router policies to <code>yellow_yellow.network_transit_router</code>
  that steers traffic towards the blue and green UDN's subnet to connect
  router on all nodes</li>
<li>On the <code>connect-router-colored-enterprise</code> add routes to specific
  node subnet slices of the blue, green ovn_cluster_router on the respective
  nodes and 1 global route to the distributed yellow transit_router</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list blue_blue.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-blue_blue.network_ovn-worker&quot; &amp;&amp; ip4.dst == 104.104.0.0/16         reroute              192.168.0.17</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-blue_blue.network_ovn-worker&quot; &amp;&amp; ip4.dst == 105.105.0.0/16         reroute              192.168.0.17</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list green_green.network_ovn_cluster_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-green_green.network_ovn-worker&quot; &amp;&amp; ip4.dst == 103.103.0.0/16         reroute              192.168.0.13</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;rtos-green_green.network_ovn-worker&quot; &amp;&amp; ip4.dst == 105.105.0.0/16         reroute              192.168.0.13</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-policy-list yellow_yellow.network_transit_router</span>
<span class="l l-Scalar l-Scalar-Plain">Routing Policies</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-yellow_yellow.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 103.103.0.0/16         reroute              192.168.0.15</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">9001 inport == &quot;trtos-yellow_yellow.network_ovn_layer2_switch&quot; &amp;&amp; ip4.dst == 104.104.0.0/16         reroute              192.168.0.15</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl lr-route-list connect-router-colored-enterprise</span>
<span class="l l-Scalar l-Scalar-Plain">IPv4 Routes</span>
<span class="l l-Scalar l-Scalar-Plain">Route Table &lt;main&gt;</span><span class="p p-Indicator">:</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.0.0/24               192.168.0.12 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.1.0/24               192.168.0.10 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">103.103.2.0/24               192.168.0.4 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.0.0/24               192.168.0.6 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.1.0/24               192.168.0.0 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">104.104.2.0/24               192.168.0.8 dst-ip</span>
<span class="w">           </span><span class="l l-Scalar l-Scalar-Plain">105.105.0.0/16               192.168.0.2 dst-ip</span>
</code></pre></div>
<p><strong>Overlapping Subnets</strong></p>
<p>Direct pod to pod connectivity of two networks is not supported in
phase1. Conflict overlap detection and notification via API must be
implemented.</p>
<h4 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h4>
<p>Case1: <code>ClusterIPServiceNetwork</code> is not set</p>
<p>no-op. Services connectivity is not supported across connected UDNs.</p>
<p>Case2: <code>ClusterIPServiceNetwork</code> and <code>PodNetwork</code> are set</p>
<p>If the <code>ClusterIPServiceNetwork</code> is explicitly requested, then
it means the end user wants the services of both networks to be
connected. In this case, we need to modify the services controller to
program the OVN load balancers on the local network switches also for
connected networks so that once the DNAT to the backend happens it takes
the same path as the policies and routes outlined in the Pods section.</p>
<p>Example, if we have blue and green clusterIP services:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">$ k get svc -n blue</span>
<span class="l l-Scalar l-Scalar-Plain">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span>
<span class="l l-Scalar l-Scalar-Plain">service-blue   ClusterIP   10.96.210.158   &lt;none&gt;        80/TCP    57m</span>
<span class="l l-Scalar l-Scalar-Plain">k get svc -n green</span>
<span class="l l-Scalar l-Scalar-Plain">NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span>
<span class="l l-Scalar l-Scalar-Plain">service-green   ClusterIP   10.96.69.71   &lt;none&gt;        80/TCP    58m</span>
<span class="l l-Scalar l-Scalar-Plain">k get endpointslice -n blue</span>
<span class="l l-Scalar l-Scalar-Plain">NAME                 ADDRESSTYPE   PORTS   ENDPOINTS                 AGE</span>
<span class="l l-Scalar l-Scalar-Plain">service-blue-czpg2   IPv4          8080    103.103.0.5,103.103.2.5   58m</span>
<span class="l l-Scalar l-Scalar-Plain">service-blue-l26v9   IPv4          8080    10.244.2.3,10.244.1.6     58m</span>
<span class="l l-Scalar l-Scalar-Plain">k get endpointslice -n green</span>
<span class="l l-Scalar l-Scalar-Plain">NAME                  ADDRESSTYPE   PORTS   ENDPOINTS                 AGE</span>
<span class="l l-Scalar l-Scalar-Plain">service-green-ngrrc   IPv4          8080    10.244.2.5,10.244.1.8     58m</span>
<span class="l l-Scalar l-Scalar-Plain">service-green-rs2wv   IPv4          8080    104.104.2.4,104.104.1.4   58m</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl ls-lb-list green_green.network_ovn-worker</span>
<span class="l l-Scalar l-Scalar-Plain">UUID                                    LB                  PROTO      VIP               IPs</span>
<span class="l l-Scalar l-Scalar-Plain">ab3397dd-6c4f-41bd-9239-60c73c25aaee    green_green.netw    tcp        10.96.69.71:80    104.104.1.4:8080,104.104.2.4:8080</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl ls-lb-list blue_blue.network_ovn-worker</span>
<span class="l l-Scalar l-Scalar-Plain">UUID                                    LB                  PROTO      VIP                 IPs</span>
<span class="l l-Scalar l-Scalar-Plain">04aa1e0b-bfec-4270-94f0-4b6d511b63a3    blue_blue.networ    tcp        10.96.210.158:80    103.103.0.5:8080,103.103.2.5:8080</span>
</code></pre></div>
<p>We need the controller to also add <code>ab3397dd-6c4f-41bd-9239-60c73c25aaee</code>
to <code>blue_blue.network_ovn-worker</code> and <code>04aa1e0b-bfec-4270-94f0-4b6d511b63a3</code>
to <code>green_green.network_ovn-worker</code> for the blue pods to be able to
talk to green service and vice versa. The switches will DNAT the traffic
and the policies and routes we added in the <strong>Pods</strong> section will take
care of routing the DNAT-ed traffic to the correct network.</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl ls-lb-add blue_blue.network_ovn-worker ab3397dd-6c4f-41bd-9239-60c73c25aaee</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl ls-lb-add green_green.network_ovn-worker 04aa1e0b-bfec-4270-94f0-4b6d511b63a3</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl ls-lb-list blue_blue.network_ovn-worker</span>
<span class="l l-Scalar l-Scalar-Plain">UUID                                    LB                  PROTO      VIP                 IPs</span>
<span class="l l-Scalar l-Scalar-Plain">04aa1e0b-bfec-4270-94f0-4b6d511b63a3    blue_blue.networ    tcp        10.96.210.158:80    103.103.0.5:8080,103.103.2.5:8080</span>
<span class="l l-Scalar l-Scalar-Plain">ab3397dd-6c4f-41bd-9239-60c73c25aaee    green_green.netw    tcp        10.96.69.71:80      104.104.1.4:8080,104.104.2.4:8080</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl ls-lb-list green_green.network_ovn-worker</span>
<span class="l l-Scalar l-Scalar-Plain">UUID                                    LB                  PROTO      VIP                 IPs</span>
<span class="l l-Scalar l-Scalar-Plain">04aa1e0b-bfec-4270-94f0-4b6d511b63a3    blue_blue.networ    tcp        10.96.210.158:80    103.103.0.5:8080,103.103.2.5:8080</span>
<span class="l l-Scalar l-Scalar-Plain">ab3397dd-6c4f-41bd-9239-60c73c25aaee    green_green.netw    tcp        10.96.69.71:80      104.104.1.4:8080,104.104.2.4:8080</span>
</code></pre></div>
<p>Case3: <code>ClusterIPServiceNetwork</code> is set and <code>PodNetwork</code> is not set</p>
<p>This means user is asking for partial connectivity between UDNs
through serviceCIDRs. They don't want direct connectivity between
all their applications.</p>
<p>We will use ACLs in <code>Tier0</code> to allow traffic to service CIDR
and drop all <code>connected_udn_subnet</code> pod traffic. These ACLs
will be added on the local node switches for layer3 networks
and the distributed flat switch for layer2 networks.
They are applied in the <code>from-lport</code> direction for traffic
originating from the pod's ports.</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">_uuid               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">e88434bf-70c2-4853-810e-ecb2a64aaaa7</span>
<span class="nt">action              </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pass</span>
<span class="nt">direction           </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">from-lport</span>
<span class="nt">external_ids        </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">label               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">log                 </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">match               </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ip4.dst==10.96.0.0/16&quot;</span>
<span class="nt">meter               </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">name                </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">options             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">priority            </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<span class="nt">sample_est          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">sample_new          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">severity            </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">tier                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl list address-set connected_udn_subnets</span>
<span class="l l-Scalar l-Scalar-Plain">_uuid</span><span class="w">               </span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d340f83e-0adb-4f8c-9196-1e36ddcda7e9</span>
<span class="nt">addresses           </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;103.103.0.0/16&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;104.104.0.0/16&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;105.105.0.0/16&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">external_ids        </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">name                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">connected_udn_subnets</span>
<span class="nn">---</span>
<span class="nt">_uuid               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cfe7b1cd-25cc-4f4f-8d15-f7b978ef43a1</span>
<span class="nt">action              </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">drop</span>
<span class="nt">direction           </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">from-lport</span>
<span class="nt">external_ids        </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">label               </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">log                 </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">match               </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ip4.src==$connected_udn_subnets</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">ip4.dst==$connected_udn_subnets</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">ct.new&quot;</span>
<span class="nt">meter               </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">name                </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">options             </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="nt">priority            </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4950</span>
<span class="nt">sample_est          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">sample_new          </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">severity            </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="nt">tier                </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl acl-list green_green.network_ovn-worker2</span>
<span class="l l-Scalar l-Scalar-Plain">from-lport  5000 (ip4.dst==10.96.0.0/16) pass --&gt; new ACL in tier0</span>
<span class="l l-Scalar l-Scalar-Plain">from-lport  4999 (ip4.src==$connected_udn_subnets &amp;&amp; ip4.dst==$connected_udn_subnets &amp;&amp; ct.new) drop --&gt; new ACL in tier0</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">to-lport  1001 (ip4.src==104.104.0.2) allow-related --&gt; tier2 (allow healthchecks from kubelet)</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">sh-5.2# ovn-nbctl acl-list blue_blue.network_ovn-worker2</span>
<span class="l l-Scalar l-Scalar-Plain">from-lport  5000 (ip4.dst==10.96.0.0/16) pass --&gt; new ACL in tier0</span>
<span class="l l-Scalar l-Scalar-Plain">from-lport  4999 (ip4.src==$connected_udn_subnets &amp;&amp; ip4.dst==$connected_udn_subnets &amp;&amp; ct.new) drop --&gt; new ACL in tier 0</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">to-lport  1001 (ip4.src==103.103.1.2) allow-related --&gt; tier2 (allow healthchecks from kubelet)</span>
</code></pre></div>
These ACLs will be having <code>apply-after-lb=false</code> so the service
DNAT will happen after the ACLs are applied. Similarly for the response
the unDNAT will happen before ACLs for the replies. This guarantees traffic
destined directly to the pods in other connected networks will be
dropped but if its destined to a clusterIP service, then after the
ACL stage, we will hit the load balancing stage in the pipeline
where the DNAT to backend IP will happen. Remaining workflow is same
as the Pods section where the traffic will be routed to the
<code>connect-router</code>.</p>
<p>These ACLs take precedence over other ACL features (ANPs, NetPols)
and that is the defined behaviour since if full connectivity for
PodNetwork is not requested, then network policies are a no-op
and need not be honored for the cross-network connection case.</p>
<p>NOTE: Since we always have a allow-related ACL on our switches:
<div class="highlight"><pre><span></span><code>  to-lport  1001 (ip4.src==103.103.1.2) allow-related
</code></pre></div>
ideally we should not need the <code>ct.new</code> match in the drop ACL
since ct session should automatically be maintained by OVN and
replies shouldn't be dropped. However while doing the PoC I don't
see this working as expected and when I remove the <code>ct.new</code>
match, drop seems to be happening that too at an unexpected
places in the pipeline which needs more investigation. During
implementation phase, if we fix that behaviour then we can remove
the ct.new match from the ACL.</p>
<p>Traffic Path:</p>
<div class="highlight"><pre><span></span><code>Onward Traffic Flow:
                              
 podA  UDNA switch   UDNA router  connect router UDNB router  UDNB switch   podB 
                              
              (DNAT to podB)         (LRPs)               (LRSRs)              (LRSR)

Response Traffic Flow:
                              
 podA  UDNA switch   UDNA router  connect router UDNB router  UDNB switch   podB 
                              
              (unSNAT to CIP)        (LRSR)                 (LRSR)             (LRP)
</code></pre></div>
<p><strong>Overlapping Subnets</strong></p>
<p>We will not support connecting networks via services that have
overlapping subnets in the first iteration. Proper
user feedback indicating an error will be provided
in case users try to connect networks with overlapping
subnets.</p>
<h4 id="network-policies-and-admin-network-policies">Network Policies and Admin Network Policies<a class="headerlink" href="#network-policies-and-admin-network-policies" title="Permanent link">&para;</a></h4>
<p>If <code>PodNetwork</code> is set, then Network Policies
and AdminNetworkPolicies (when they get supported on UDNs)
that are created in the networks that are part of
ClusterNetworkConnect API will have peers that span across all
connect networks. So the scope of policies will be within all
connected networks.</p>
<p>If <code>PodNetwork</code> is not set, then policies won't
apply across networks since there is no need to do so.</p>
<h4 id="controller-design-changes-to-components">Controller Design / Changes to Components<a class="headerlink" href="#controller-design-changes-to-components" title="Permanent link">&para;</a></h4>
<p><strong>Cluster Manager</strong></p>
<p>A new <code>network-connect-controller</code> will be created that watches the
<code>ClusterNetworkConnect</code> objects and does the following:</p>
<p>1) It is responsible to allocate a range for each network:
  * It get's the <code>connectSubnets</code> value from the CNC and allocates
    a <code>/networkPrefix</code> subnet for each layer3 connected network.
    If its a layer2 type network, then allocator gives out a
    <code>/networkPrefix</code> subnet and then from that gives out a <code>/31</code> or
    <code>/127</code> slice subnet for each layer2 network. So until that
    <code>/networkPrefix</code> subnet is exhausted, all subsequent layer2
    networks will use that range.
  * These values are annotated on the <code>ClusterNetworkConnect</code>
    CRD for it to be then consumed on the <code>ovnkube-controller</code> side.
    Sample:
    <div class="highlight"><pre><span></span><code><span class="nt">k8s.ovn.org/network-subnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="nt">  layer3_&lt;network1-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.0.0/24&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="s">&quot;fd01:0:0:0::/64&quot;</span><span class="p p-Indicator">},</span>
<span class="nt">  layer3_&lt;network2-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.1.0/24&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:1::/64&quot;</span><span class="p p-Indicator">},</span><span class="w"> </span>
<span class="nt">  layer3_&lt;network5-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.2.0/24&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:2::/64&quot;</span><span class="p p-Indicator">},</span>
<span class="nt">  layer3_&lt;network12-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.3.0/24&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:3::/64&quot;</span><span class="p p-Indicator">},</span>
<span class="nt">  layer2_&lt;network40-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.4.0/31&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:4::/127&quot;</span><span class="p p-Indicator">},</span>
<span class="nt">  layer2_&lt;network103-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.4.2/31&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:4::2/127&quot;</span><span class="p p-Indicator">},</span>
<span class="nt">  layer3_&lt;network15-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.5.0/24&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:5::/64&quot;</span><span class="p p-Indicator">},</span>
<span class="nt">  layer2_&lt;network2000-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&quot;ipv4&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;192.168.4.4/31&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;ipv6&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;fd01:0:0:4::4/127&quot;</span><span class="p p-Indicator">},</span>
<span class="w">  </span><span class="nv">...</span>
<span class="p p-Indicator">}</span>
</code></pre></div>
    Ideally speaking, we will need N_L3M subnets for N_L3 Layer3
    networks and M nodes and N_L2 subnets for Layer2 for N layer2 networks.
    So a total of <code>N_L3*M+N_L2</code> subnets and <code>2x(N_L3*M+N_L2)</code> IPs.
    However in this method, we plan to let CM give a slice for each
    layer3 connected network based on <code>networkPrefix</code> and each
    layer2 connected network a <code>/31</code>- so that means we
    are going to consume <code>N_L3*M+N_L2</code> subnets and <code>2x(N_L3*M+N_L2)</code> IPs
    where M is maximum nodes in your cluster. Users need to be careful because
    this <code>networkPrefix</code> can limit the maximum number of nodes in your
    cluster. On the node side from this <code>networkPrefix</code>, we will give out
    a <code>/31</code> for each node. For layer3 networks, its possible the node-ids
    are not contiguous so we will loose out on a few IPs in the middle sparsely.
    This method was chosen so that we don't need to annotate a lot of
    N*M values on our annotation which will make it bloat a lot
    from performance and scale perspective.
2) It is responsible for allocating the global tunnel key for each
  <code>connect-router</code>:
  * It will use the same instance of global <code>TunnelKeysAllocator</code>
    in cluster manager that already allocates the tunnel keys for
    existing Layer2 transit routers. This allocator already
    preserves the first 4096 IDs which are used as tunnel-keys
    for Layer3 and Layer2 transit switches (derived from the networkID
    that is allocated by the networkID allocator).
    <code>TunnelKeysAllocator</code> will then allocate the new ones for the
    connect router dynamically. This ensures we don't reuse
    already allocated networkIDs. For each connect API that will
    create a connect router, we will need 1 tunnel key per router.
  * This value is annotated on the <code>ClusterNetworkConnect</code>
    CRD for it to be then consumed on the <code>ovnkube-controller</code> side.
    Sample:
    <div class="highlight"><pre><span></span><code><span class="nt">k8s.ovn.org/connect-router-tunnel-key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;50000&#39;</span>
</code></pre></div>
3) Status conditions will be updated based on feedback of setup
 from the <code>ovnkube-controllers</code> in different zones.</p>
<p>This controller also needs to watch for NADs to
accommodate adds, updates and deletes for the network-subnet.</p>
<p><strong>OVN-Kubernetes Controller</strong></p>
<p>A new <code>network-connect-controller</code> will be created that watches the
<code>ClusterNetworkConnect</code> objects and does the following:</p>
<p>1) Based on the network selectors, creates the
   necessary network topology changes mentioned
   in the above section:
   * Creates the <code>connect-router</code>
   * Creates the ports connecting each Layer3 <code>ovn_cluster_router</code> and
     each Layer2 <code>transit-router</code> to the <code>connect-router</code>
   * Adds the necessary logical router policies on each network router
   * Adds the necessary logical router static routes on the <code>connect-router</code>
2) Reads the <code>k8s.ovn.org/network-subnets</code>
   annotation set by the cluster manager on CNC and allocates
   a <code>/31</code> point to point subnet for each layer3 node-network's router port link
   and uses the IPs from the <code>/31</code> to create the ports. For layer2 we only
   need one <code>/31</code> instead of per node /31's which is already allocated by
   CM. This allocator will be a static allocator util that deterministically
   always picks the same <code>/31</code> for every <code>node-id</code>. Example:
   <div class="highlight"><pre><span></span><code><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker-1 (node-id=0)  10.2.0.0/31 (10.2.0.0 + 10.2.0.1)</span>
<span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker-2 (node-id=1)  10.2.0.2/31 (10.2.0.2 + 10.2.0.3)</span>
<span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker-3 (node-id=2)  10.2.0.4/31 (10.2.0.4 + 10.2.0.5)</span>
<span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker-4 (node-id=5)  10.2.0.10/31 (10.2.0.10 + 10.2.0.11)</span>
</code></pre></div>
   We can see that if node-ids are not contiguous, then we will loose
   those IPs in the middle. But we determined this is still better than
   having annotation patch issues at scale. However this static allocator
   totally relies on maxNodes value and node-id not exceeding the range
   user has provided. Offset used will be <code>generator.GenerateP2PSubnet(nodeID * 2)</code>.
   For layer2 we will just use the annotation value directly.
3) Reads the <code>k8s.ovn.org/connect-router-tunnel-key</code> and uses
   the tunnel key to create the <code>connect-router</code>
4) Within each <code>connect-router</code>, we would need N_L3*M tunnel keys to
   connect N_L3 Layer3 networks on M nodes and N_L2 tunnel keys to connect
   N_L2 Layer2 networks on M nodes. So total of <code>N_L3*M+N_L2</code> keys.
   * This will be done statically based on subnets allocated out for each
     node-network pair for layer3 networks and for each layer2 network. See the
     Deterministic Static TunnelID Allocator approach mentioned below for details.
5) Creates the <code>pass</code> and <code>drop</code> ACLs if only partial service connectivity
   is requested
6) If <code>ClusterIPServiceNetwork</code> is set, then once the services
   controller of each network creates the load balancers (retries till
   its created), this controller will also attach those load balancers
   to the switches of the connected networks. This way, no changes are
   required to existing services controller. However this means network-connect
   controller will need to watch for endpointslice and services
   objects.</p>
<p>This controller watches for CNCs, NADs, Services, Endpointslices
and Nodes to react to events. It will be a level driven controller.</p>
<p><strong>Deterministic Static Tunnel ID Allocation Algorithm used by ovnkube-controller</strong></p>
<p>The tunnel IDs for connect-router ports are allocated deterministically based on the existing subnet allocations. This ensures consistency across all ovnkube-controller instances without requiring coordination.</p>
<h5 id="algorithm-overview">Algorithm Overview<a class="headerlink" href="#algorithm-overview" title="Permanent link">&para;</a></h5>
<ol>
<li><strong>Calculate maxNodes</strong>: <code>maxNodes = 2^(32 - NetworkPrefix)</code></li>
<li>For NetworkPrefix=24: maxNodes=128</li>
<li>
<p>For NetworkPrefix=25: maxNodes=64</p>
</li>
<li>
<p><strong>Calculate network index</strong>: Based on the subnet's position in the NetworkPrefix range</p>
</li>
<li>
<p><strong>Allocate tunnel keys</strong>:</p>
</li>
<li><strong>Layer3 networks</strong>: <code>tunnelKey = networkIndex * maxNodes + nodeID + 1</code></li>
<li><strong>Layer2 networks</strong>: <code>tunnelKey = networkIndex * maxNodes + subIndex + 1</code></li>
</ol>
<h5 id="example-allocation">Example Allocation<a class="headerlink" href="#example-allocation" title="Permanent link">&para;</a></h5>
<p>Given NetworkPrefix=24 (maxNodes=128):</p>
<table>
<thead>
<tr>
<th>Network</th>
<th>Subnet</th>
<th>Type</th>
<th>Index</th>
<th>Tunnel Key Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>network1</td>
<td>192.168.0.0/24</td>
<td>Layer3</td>
<td>0</td>
<td>[1, 128]</td>
</tr>
<tr>
<td>network2</td>
<td>192.168.1.0/24</td>
<td>Layer3</td>
<td>1</td>
<td>[129, 256]</td>
</tr>
<tr>
<td>network5</td>
<td>192.168.2.0/24</td>
<td>Layer3</td>
<td>2</td>
<td>[257, 384]</td>
</tr>
<tr>
<td>network12</td>
<td>192.168.3.0/24</td>
<td>Layer3</td>
<td>3</td>
<td>[385, 512]</td>
</tr>
<tr>
<td>network40</td>
<td>192.168.4.0/31</td>
<td>Layer2</td>
<td>4</td>
<td>[513]</td>
</tr>
<tr>
<td>network103</td>
<td>192.168.4.2/31</td>
<td>Layer2</td>
<td>4</td>
<td>[514]</td>
</tr>
<tr>
<td>network15</td>
<td>192.168.5.0/24</td>
<td>Layer3</td>
<td>5</td>
<td>[641, 768]</td>
</tr>
</tbody>
</table>
<h5 id="scale-limitations">Scale Limitations<a class="headerlink" href="#scale-limitations" title="Permanent link">&para;</a></h5>
<p>The maximum number of connectable networks is limited by:
- <strong>Tunnel key limit</strong>: 32767 (reserved: 0 since 0 is invalid tunnelKey)
- <strong>Available keys</strong>: 32766
- <strong>Max networks</strong>: <code>32766 / maxNodes</code></p>
<table>
<thead>
<tr>
<th>NetworkPrefix</th>
<th>maxNodes</th>
<th>Max Networks</th>
</tr>
</thead>
<tbody>
<tr>
<td>/24</td>
<td>128</td>
<td>255</td>
</tr>
<tr>
<td>/25</td>
<td>64</td>
<td>511</td>
</tr>
<tr>
<td>/26</td>
<td>32</td>
<td>1023</td>
</tr>
</tbody>
</table>
<h2 id="cross-feature-interaction">Cross Feature Interaction<a class="headerlink" href="#cross-feature-interaction" title="Permanent link">&para;</a></h2>
<h3 id="connecting-advertised-udns">Connecting Advertised UDNs<a class="headerlink" href="#connecting-advertised-udns" title="Permanent link">&para;</a></h3>
<p>The ACLs that are added to block traffic routing between the two UDNs
in strict mode will be removed so that traffic can flow between networks
once connected.</p>
<p>A side caveat here is instead of the edge router doing the routing,
OVN-Kubernetes itself will take care of routing the traffic. If
that is not desired, then users should stick with loose isolation mode
using BGP and not use this feature.</p>
<h3 id="connecting-udns-with-no-overlay-mode">Connecting UDNs with no overlay mode<a class="headerlink" href="#connecting-udns-with-no-overlay-mode" title="Permanent link">&para;</a></h3>
<p>This feature will not be supported if overlay tunnel encapsulation is
turned off. Cluster Manager will perform the necessary steps to validate
and emit a message to the end user reporting an error if they tried to
connect UDNs when overlay is turned off.</p>
<h2 id="testing-details">Testing Details<a class="headerlink" href="#testing-details" title="Permanent link">&para;</a></h2>
<ul>
<li>Unit Testing details - All code modules will have necessary unit tests</li>
<li>E2E Testing details - Entire feature will have E2E and Integration
  testing</li>
<li>API Testing details - CEL rules and API validation will have its own
  apply test suite</li>
<li>Scale Testing details - Bare minimum set of scale testing will be done
  for this feature although we probably need to fix UDN Scale first</li>
<li>Cross Feature Testing details - coverage for interaction with other
  features like BGP and no-overlay mode</li>
</ul>
<h2 id="documentation-details">Documentation Details<a class="headerlink" href="#documentation-details" title="Permanent link">&para;</a></h2>
<ul>
<li>User guide will be updated for the feature on ovn-kubernetes.io
  website</li>
<li>Blog posts and easy to get started guides will be done on
  ovn-kubernetes.io website</li>
<li>Developer docs whereever possible will be added</li>
</ul>
<h2 id="risks-known-limitations-and-mitigations">Risks, Known Limitations and Mitigations<a class="headerlink" href="#risks-known-limitations-and-mitigations" title="Permanent link">&para;</a></h2>
<h3 id="scale-and-performance">Scale and Performance<a class="headerlink" href="#scale-and-performance" title="Permanent link">&para;</a></h3>
<ul>
<li>Adding a /16 route to each router for each connected peer network and
  then adding /24 routes for each node-network combo on the transit
  router has scale implications specially on clusters with large nodes.
  A cluster with 500 nodes and 500 networks will end up with 250000
  routes on each transit router distributed half on the node.</li>
<li>In future there is a requirement to not create OVN constructs for UDNs
  on those nodes where we know there won't be pod's scheduled. This is
  to optimize resource consumption on large scale clusters with 1000 nodes
  where only 10 nodes are going to host UDNs. Whatever topology we pick
  here must work for that future enhancement as changing topologies is not
  really encouraged. See <a href="https://ovn-kubernetes.io/okeps/okep-5552-dynamic-udn-node-allocation/">Dynamic UDN Node Allocation</a> for more details.</li>
<li>The annotations we add to the CNC has cost of marshal and unmarshal
  at each ovnkube-controller</li>
</ul>
<p><img alt="blue-green-yellow-l3-connect-scale" src="../images/l3-connecting-udns-scale.png" /></p>
<h2 id="ovn-kubernetes-version-skew">OVN Kubernetes Version Skew<a class="headerlink" href="#ovn-kubernetes-version-skew" title="Permanent link">&para;</a></h2>
<p>Targeting release 1.2</p>
<h2 id="alternatives">Alternatives<a class="headerlink" href="#alternatives" title="Permanent link">&para;</a></h2>
<h3 id="using-bgp-and-routeradvertisement-api">Using BGP and RouterAdvertisement API<a class="headerlink" href="#using-bgp-and-routeradvertisement-api" title="Permanent link">&para;</a></h3>
<p>If admin wants to connect two UDNs together then they can simply expose
the two UDNs using RouterAdvertisement CR and the router acting as
gateway outside the cluster will learn the pod subnet routes from both
these UDNs thereby acting as the router and being able to connect pods
together. Today we add ACLs, but those could be removed to accommodate
the connectivity.</p>
<p><strong>Pros</strong></p>
<ul>
<li>No need for a new API to connect UDNs together</li>
<li>Implementation changes are also almost nil</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Some users might want to use BGP and UDNs only for the pods to be
  directly accessible from external destinations and within the cluster
  they might still want to respect segmentation - this is not possible
  if we declare exposing UDNs subnets using BGP also means they are now
  connected together. So basically the current API didn't account for
  BGP to solve connecting UDNs problem.</li>
<li>Some users might not want to use BGP at all because that makes
  assumptions on having the right fabric at the cluster infrastructure
  layer like presence of FRR-K8s which might not be the case always -
  then how can they connect their UDNs together? Solution needs to be
  OVN-native where-ever possible.</li>
<li>Users cannot ask for partial v/s full connectivity across these UDNs</li>
<li>example allow only services not pods.</li>
<li>Hardware offload not possible since traffic is not curtailed only to
  the OVS stack</li>
</ul>
<h3 id="using-alternative-connection-ideas-on-ovn-topology-level">Using alternative connection ideas on OVN topology level<a class="headerlink" href="#using-alternative-connection-ideas-on-ovn-topology-level" title="Permanent link">&para;</a></h3>
<p>See <a href="../discarded-alternatives/">discarded-alternatives.md</a> for details
on alternative topology connection ideas that were considered but
discarded.</p>
<h3 id="using-nodenetwork-cr-instead-of-annotations-on-clusternetworkconnect-api">Using NodeNetwork CR instead of Annotations on ClusterNetworkConnect API<a class="headerlink" href="#using-nodenetwork-cr-instead-of-annotations-on-clusternetworkconnect-api" title="Permanent link">&para;</a></h3>
<p>NOTE: Having the <code>NodeNetwork</code> CRD as an internal data storage API might
be more ideal to store the above information internally as this needs to
be persisted into etcd on reboots. It will simplify the annotations and
also help with scale since there are known issues around patching of
annotation and waiting for reading and unmarshalling the annotation
impacts scale. But this theory is not proven yet. During discussions we
concluded it wouldn't be faster because the NetworkConnectController
would be the only one watching for these CRs and it will need to process
all the data and networks anyway.</p>
<h3 id="have-clustermanager-give-out-point-to-point-subnet-slices">Have ClusterManager give out point to point subnet slices<a class="headerlink" href="#have-clustermanager-give-out-point-to-point-subnet-slices" title="Permanent link">&para;</a></h3>
<p>Initial design had:
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">k8s.ovn.org/node-network-subnets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="nt">      layer3_&lt;network1-id&gt;_&lt;node1name&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.0/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer3_&lt;network1-id&gt;_&lt;node2name&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.2/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer3_&lt;network1-id&gt;_&lt;node3name&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.4/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer3_&lt;network2-id&gt;_&lt;node1name&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.6/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer3_&lt;network2-id&gt;_&lt;node2name&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.8/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer3_&lt;network3-id&gt;_&lt;node3name&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.10/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer2_&lt;network1-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.12/31</span><span class="p p-Indicator">,</span>
<span class="nt">      layer2_&lt;network2-id&gt;</span><span class="p">:</span><span class="w"> </span><span class="nv">192.168.0.14/31</span><span class="p p-Indicator">,</span>
<span class="w">      </span><span class="nv">...</span>
<span class="w">    </span><span class="p p-Indicator">}</span>
</code></pre></div>
this style of annotation on the CNC object, but we decided against it
since 5000 nodes (max nodes) x 4096 networks (max networks) could at
worst case generate 2*20480000 values in annotation which won't scale
well. Each network and node change would cause churn and frequent updates.
For scale reasons we went with the hybrid model mentioned in the proposal.
We would have needed N_L3M subnets for N_L3 Layer3 networks and M nodes
and N_L2 subnets for Layer2 for N layer2 networks. So a total of
<code>N_L3*M+N_L2</code> subnets and <code>2x(N_L3*M+N_L2)</code> IPs. This had the advantage
of the ranges being contiguous and no wasted IPs in connectSubnets range
compared to the solution we have today.</p>
<h3 id="adding-load-balancers-on-transit-connect-routers-for-services">Adding load balancers on transit connect routers for services<a class="headerlink" href="#adding-load-balancers-on-transit-connect-routers-for-services" title="Permanent link">&para;</a></h3>
<p>Alternative Idea2: <strong>Instead of doing the DNAT at the network
switches, we could add the load balancers to the connect router.</strong></p>
<p>If <code>ClusterIPServiceNetwork</code> is set, then we add routes for each
clusterIP that belongs to the other connected networks
to be routed to the <code>connect-router</code> or a ClusterIP CIDR route.
We would need to then either host all load balancers for all connected
networks on the <code>connect-router</code> OR we would need to route the clusterIP to
any random node-network pair belonging to the destination network
where the DNAT and reroute would happen but that's complicated.
If we go with adding load balancers to the connect router, then
traffic path looks like this:</p>
<div class="highlight"><pre><span></span><code>Forward Path (podA -&gt; podB):
                              
 podA  UDNA switch   UDNA router  connect router UDNB router  UDNB switch   podB 
                              
                                      (LRP)          (DNAT to podB +        (LRSR)
                                                           LRSR)

Return Path (podB -&gt; podA):
                              
 podA  UDNA switch   UDNA router  connect router UDNB router  UDNB switch   podB 
                              
                                      (LRSR)        (unSNAT to cip +      (need LRPs
                                                           LRSR)          for reply)
</code></pre></div>
<p>So in the end we'd need CIP routes and pod subnet routes + add the
load balancers to connect router and also add ACLs to drop direct
traffic towards pod subnets but only allow replies for service
traffic for idea2 v/s for idea1 we don't need the CIP routes an
rest remains the same except load balancers are added to the
switches instead of routers. However, idea2 won't work because
transit routers have same limitations as regular distributed routers
in OVN when it comes to connection tracking. Given the Layer2
transit router to Connect router is a distributed port, traffic
coming from the layer2 switch -&gt; layer2 router -&gt; connect router
cannot be load balanced.</p>
<h2 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h2>
<ul>
<li>This enhancement depends on the <a href="https://ovn-kubernetes.io/okeps/okep-5094-layer2-transit-router/">new Layer2 topology</a> changes.</li>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  OVN-Kubernetes a Series of LF Projects, LLC. For website terms of use, trademark policy and other project policies please see <a href="https://lfprojects.org/policies/">LF Projects Policies</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../javascripts/gemini-api-key.js"></script>
      
        <script src="../../../javascripts/theme.js"></script>
      
        <script src="../../../javascripts/extra.js"></script>
      
    
  </body>
</html>